{"version":3,"sources":["globalVariable.js","functions.js","initLang.js","initData.js","init.js","displayMainMenu.js","updateMainMenu.js","bubbles.js","customMenu.js","ingame.js","clear.js","save.js","updateDayAndCycle.js","updatePlayerInfos.js","open.js","update.js","updateCookie.js","updateOpt.js","other.js"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC5CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AHxCA;AIAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ANdA;AACA;AACA;AACA;AACA;AACA;AACA;ACNA;AACA;AACA;AACA;AACA;AACA;AACA;AMNA;AACA;AACA;AACA;ACHA;AACA;AACA;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AV1CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AUrBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACTA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"CTRLW.mini.user.js","sourcesContent":["var Main = unsafeWindow.Main;\nvar _tid = unsafeWindow._tid;\n/*var ArrayEx = unsafeWindow.ArrayEx;\n var ChatType = unsafeWindow.ChatType;\n var Clients = unsafeWindow.Clients;\n var CrossConsts = unsafeWindow.CrossConsts;\n var haxe = unsafeWindow.haxe;\n var HxOverrides = unsafeWindow.HxOverrides;*/\nvar js = unsafeWindow.js;\njs.JQuery = $;\n/*var Lambda = unsafeWindow.Lambda;\n var Reflect = unsafeWindow.Reflect;\n var Selection = unsafeWindow.Selection;\n var Std = unsafeWindow.Std;\n var StringBuf = unsafeWindow.StringBuf;\n var StringTools = unsafeWindow.StringTools;\n var Tag = unsafeWindow.Tag;\n var Tools = unsafeWindow.Tools;\n var Utils = unsafeWindow.Utils;*/\nvar mt = unsafeWindow.mt;\nvar mush_jquery = unsafeWindow.$;\n\nif (typeof(exportFunction) == 'undefined') {\n    var exportFunction = function(foo, scope, defAs){\n        return foo;\n    }\n}\nif (typeof(createObjectIn) == 'undefined') {\n    var createObjectIn = function(obj,options){\n        return {};\n    }\n}\nif (typeof(cloneInto) == 'undefined') {\n    var cloneInto = function(obj,targetScope,options){\n        return obj;\n    }\n}\n\n//MAIN.k VARIABLES\nMain.k = createObjectIn(unsafeWindow.Main, {defineAs: \"k\"});\n\nMain.k.window = unsafeWindow;\nMain.k.version = GM_info.script.version;\nMain.k.website = \"http://ks26782.kimsufi.com/ctrlw\";\n\nMain.k.servurl = \"http://ctrl-w.badconker.com\";\nMain.k.servurl_badconker = 'http://ctrlw.badconker.com';\nMain.k.servhost = 'file:///mnt/Données/Developpement/ctrl-w/build';\n\nMain.k.window = window;\nMain.k.domain = document.domain;\nMain.k.mushurl = 'http://' + document.domain;\nMain.k.debug = true;\nMain.k.errorList = [];\n\nif(Main.k.debug){\n    var console = unsafeWindow.console;\n}else{\n    var console = {}\n    console.log = console.error = console.info = console.debug = console.warn = console.trace = console.dir = console.dirxml = console.group = console.groupEnd = console.time = console.timeEnd = console.assert = console.profile = function() {};\n}","String.prototype.htmlEncode = function() {\n    return $('<div/>').text(this).html();\n};\n\nString.prototype.capitalize = function() {\n    return this.replace(/(?:^|\\s)\\S/g, function(a) {\n        return a.toUpperCase();\n    });\n};\n\nString.prototype.replaceFromObj = function(obj) {\n    var retStr = this;\n    for (var x in obj) {\n        if(obj.hasOwnProperty(x)){\n            retStr = retStr.replace(new RegExp(x, 'g'), obj[x]);\n        }\n    }\n    return retStr;\n};\n\nString.prototype.hashCode = function() {\n    var hash = 0;\n    if (this.length == 0) return hash;\n    for (i = 0; i < this.length; i++) {\n        char = this.charCodeAt(i);\n        hash = ((hash << 5) - hash) + char;\n        hash = hash & hash; // Convert to 32bit integer\n    }\n    return hash;\n};\n\nRegExp.escape = function(s) {\n    return s.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&');\n};\n\nfunction addFctToPage (text, name) {\n    var D                                   = document;\n    var scriptNode                          = D.createElement ('script');\n    scriptNode.type                         = \"text/javascript\";\n    if (text)       scriptNode.textContent  = text;\n    if (name)\t\tscriptNode.textContent  = name + ' = ' + text;\n\n    var targ = D.getElementsByTagName ('head')[0] || D.body || D.documentElement;\n    targ.appendChild (scriptNode);\n}","Main.k.initLang = function() {\n    // Language detection\n    switch(Main.k.domain) {\n        case \"mush.twinoid.com\":\n            Main.k.lang = \"en\";\n            break;\n        case \"mush.twinoid.es\":\n            Main.k.lang = \"es\";\n            break;\n        default:\n            Main.k.lang = \"fr\";\n    }\n    /*Main.k.text = new Gettext({\n     domain: \"ctrl-w\"\n     });*/\n    /*for (var id in Main.k.text) {\n     if (typeof(Main.k.text[id]) == \"function\") {\n     console.log('export Main.k.text.'+id)\n     exportFunction(Main.k.text[id], unsafeWindow.Main.k.text, {defineAs: id});\n     }\n     }*/\n    Main.k.textInit = exportFunction(function(){Main.k.text = new Gettext({\n        domain: \"ctrl-w\"\n    });}, unsafeWindow);\n    //console.warn(Main.k.text);\n    Main.k.textInit();\n    //unsafeWindow.Main.k.text = cloneInto(Main.k.text,unsafeWindow,{cloneFunctions:true});\n    //console.warn(Main.k.text);\n    try {\n        var translationDataText = GM_getResourceText(\"translation:\"+Main.k.lang);\n        if(typeof translationDataText == 'undefined') {\n            console.warn(\"No translations for '\"+Main.k.lang+\"'\");\n            return;\n        }\n        var translationData = Main.k.text.parse_po(translationDataText);\n        Main.k.text.parse_locale_data({\"ctrl-w\": translationData}); // ctrl-w is the domain.\n    } catch(err) { // GM_getResourceText throws errors if things don't exist\n        console.error(\"Error getting translation data:\", err);\n    }\n};","Main.k.Options = {};\nMain.k.Options.initialized = false;\nMain.k.Options.cbubbles = false;\nMain.k.Options.cbubblesNB = false;\nMain.k.Options.dlogo = false;\nMain.k.Options.splitpjt = true;\nMain.k.Options.altpa = false;\nMain.k.Options.mushNoConf = false;\nMain.k.Options.options = [];","Main.k.Options.init = function() {\n    Main.k.Options.options = [\n        //  Option Name,\tOption Object,\t\t\t\tNeed refresh,\tAfter(),\t\t\t\tDesc\n        [\"cbubbles\",\tMain.k.Options.cbubbles,\tfalse,\t\t\tMain.k.customBubbles,\tMain.k.text.gettext(\"Activer la mise en forme personnalisée des messages (bordure + couleur nom + image de fond).\")],\n        [\"cbubblesNB\",\tMain.k.Options.cbubblesNB,\tfalse,\t\t\tMain.k.customBubbles,\tMain.k.text.gettext(\"Simplifier la mise en forme personnalisée des messages (suppression de l'image de fond).\")],\n        [\"dlogo\",\t\tMain.k.Options.dlogo,\t\ttrue,\t\t\tnull,\t\t\t\t\tMain.k.text.gettext(\"Afficher le logo Mush au dessus des onglets.\")],\n        [\"splitpjt\",\tMain.k.Options.splitpjt,\tfalse,\t\t\tMain.k.updateBottom,\tMain.k.text.gettext(\"Séparer les projets / recherches / pilgred sous la zone de jeu.\")]\n        //[\"altpa\",\t\tMain.k.Options.altpa,\t\ttrue,\t\t\tnull,\t\t\t\t\t\"Utiliser des images alternatives pour les pa / pm.\"]\n    ];\n\n    var cook = js.Cookie.get(\"ctrlwoptions\");\n    if (!cook) return;\n\n    var parts = cook.split(\"|\");\n    for (var i=0; i<parts.length; i++) {\n        var part = parts[i].split(\":\");\n        var key = part[0];\n        var val = part[1];\n\n        Main.k.Options.updateOpt(key,val);\n    }\n};","Main.k.displayMainMenu = function() {\n    Main.k.css.customMenu();\n\n    // Fix position\n    var fix = $(\"ul.mtabs\").length > 0 ? 70 : 20;\n    $(\"#maincontainer, .boxcontainer\").css(\"margin\", fix + \"px auto 0\");\n\n    Main.k.ownHero = ($(\".hero h1.who\").length > 0 ) ? $(\".who\").html().toLowerCase().trim().replace(/(\\s)/g, \"_\") : false;\n    Main.k.silver = true; //TODO\n    Main.k.fds = ($(\"a.butmini[href='/fds']\").length > 0);\n    var menu = $(\"<ul>\").addClass(\"kmenu\").insertBefore(\"#maincontainer, .boxcontainer\");\n    var play = $(\"<li class='kmenuel active first'><a href='\"+Main.k.mushurl+\"/chooseHero'>\"+Main.k.text.gettext(\"Jouer\")+\"</a></li>\").appendTo(menu);\n    var account = $(\"<li class='kmenuel'><a href='\"+Main.k.mushurl+\"/me'>\"+Main.k.text.gettext(\"Mon compte\")+\"</a></li>\").appendTo(menu);\n\n    if(Main.k.text.gettext(\"ForumCastingsId\") != \"ForumCastingsId\") {\n        var casting = $(\"<li class='kmenuel' id='ctrlw-main-menu-castings'><a href='\"+Main.k.mushurl+\"/group/list'>\"+Main.k.text.gettext(\"Castings\")+\"</a></li>\").appendTo(menu);\n\n    }\n    var rankings = $(\"<li class='kmenuel'><a href='\"+Main.k.mushurl+\"/ranking'>\"+Main.k.text.gettext(\"Classements\")+\"</a></li>\").appendTo(menu);\n    var forum = $(\"<li class='kmenuel'><a href='\"+Main.k.mushurl+\"/tid/forum'>\"+Main.k.text.gettext(\"Forum\")+\"</a></li>\").appendTo(menu);\n    var help = $(\"<li class='kmenuel last'><a href='\"+Main.k.mushurl+\"/help'>\"+Main.k.text.gettext(\"Aide\")+\"</a></li>\").appendTo(menu);\n\n\n    var account_ss = $(\"<ul>\").attr(\"id\", \"accountmenu\").appendTo(account);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/me'><img src='/build/img/icons/skills/persistent.png' />\"+Main.k.text.gettext(\"Expérience\")+\"</a></li>\").appendTo(account_ss);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/me?profile'><img src='/build/img/icons/skills/opportunist.png' />\"+Main.k.text.gettext(\"Ma fiche\")+\"</a></li>\").appendTo(account_ss);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/me?config'><img src='/build/img/icons/skills/engineer.png' />\"+Main.k.text.gettext(\"Mes réglages\")+\"</a></li>\").appendTo(account_ss);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/me?news'><img src='/build/img/icons/skills/radio_expert.png' />\"+Main.k.text.gettext(\"News\")+\"</a></li>\").appendTo(account_ss);\n\n    var rankings_ss = $(\"<ul>\").appendTo(rankings);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/ranking'><img src='/build/img/icons/skills/persistent.png' />\"+Main.k.text.gettext(\"Classements\")+\"</a></li>\").appendTo(rankings_ss);\n    $(\"<li><a class='kssmenuel ext' href='http://twinorank.kubegb.fr/jeux/Mush' target='_blank'><img src='/build/img/icons/skills/persistent.png' />Twin-O-Rank</a></li>\").appendTo(rankings_ss);\n\n    var forum_ss = $(\"<ul>\").appendTo(forum);\n    if(Main.k.text.gettext(\"ForumDiscussionId\") != \"ForumDiscussionId\") {\n        /* Translators: Forum Discussion id */\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumDiscussionId\")+\n            /* Translators: Forum Discussion label */\n        \"'><img src='\" + Main.k.servurl + \"/img/radioh.png' />\"+Main.k.text.gettext(\"Discussion\")+\"</a></li>\").appendTo(forum_ss);\n    }\n    if(Main.k.text.gettext(\"ForumAdviceId\") != \"ForumAdviceId\") {\n        /* Translators: Forum Advice id */\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumAdviceId\")+\n            /* Translators: Forum Advice label */\n        \"'><img src='\" + Main.k.servurl + \"/img/radioh.png' />\"+Main.k.text.gettext(\"Entraide\")+\"</a></li>\").appendTo(forum_ss);\n    }\n    if(Main.k.text.gettext(\"ForumLoungeId\") != \"ForumLoungeId\") {\n        /* Translators: Forum Lounge id */\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumLoungeId\")+\n            /* Translators: Forum Lounge label */\n        \"'><img src='\" + Main.k.servurl + \"/img/radioh.png' />\"+Main.k.text.gettext(\"Détente\")+\"</a></li>\").appendTo(forum_ss);\n    }\n    if(Main.k.text.gettext(\"ForumCastingsId\") != \"ForumCastingsId\") {\n        /* Translators: Forum Castings id */\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumCastingsId\")+\n            /* Translators: Forum Castings label */\n        \"'><img src='\" + Main.k.servurl + \"/img/radioh.png' />\"+Main.k.text.gettext(\"Castings\")+\"</a></li>\").appendTo(forum_ss);\n    }\n    if(Main.k.text.gettext(\"ForumOfficersId\") != \"ForumOfficersId\") {\n        /* Translators: Forum Officers id */\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumOfficersId\")+\"'><img src='/build/img/icons/skills/rebel.png' />\"+Main.k.text.gettext(\"Officiers\")+\"</a></li>\").appendTo(forum_ss);\n    }\n\n    var help_ss = $(\"<ul>\").appendTo(help);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/help'><img src='/build/img/icons/skills/genius.png' />\"+Main.k.text.gettext(\"Aide Mush\")+\"</a></li>\").appendTo(help_ss);\n    $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/patchlog'><img src='/build/img/icons/skills/persistent.png' />\"+Main.k.text.gettext(\"Patchlog\")+\"</a></li>\").appendTo(help_ss);\n\n    if (Main.k.ownHero && typeof(Main.k.h[Main.k.ownHero]) != 'undefined') {\n        var charname = Main.k.ownHero.replace(\"_\", \"\");\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumAdviceId\")+\"|thread/\" + Main.k.h[Main.k.ownHero].tutorial + \"'><img src='/img/icons/ui/\" + charname + \".png' />\" + Main.k.text.strargs(Main.k.text.gettext(\"Tuto %1\"), [Main.k.ownHero.capitalize()]) + \"</a></li>\").appendTo(help_ss);\n    }\n    /* Translators: Wiki url */\n    $(\"<li><a class='kssmenuel ext' target='_blank' href='\"+Main.k.text.gettext(\"http://www.twinpedia.com/mush\")+\n        /* Translators: Wiki favicon url */\n    \"'><img data-async_src='\"+Main.k.text.gettext(\"http://www.twinpedia.com/_media/favicon.ico\")+\"' />\"+Main.k.text.gettext(\"Twinpedia\")+\"</a></li>\").appendTo(help_ss);\n    $(\"<li><a class='kssmenuel ext' href='http://pictoid.fr/mush/picto' target='_blank'><img data-async_src='http://pictoid.fr/favicon.png' />Pictoid</a></li>\").appendTo(help_ss);\n\n    if (Main.k.fds) {\n        $(\"<li><a class='kssmenuel ext' href='\"+Main.k.mushurl+\"/tid/forum#!view/\"+Main.k.text.gettext(\"ForumFDSId\")+\"'><img src='/build/img/icons/skills/juge.png' />\"+Main.k.text.gettext(\"Magistrature\")+\"</a></li>\").appendTo(forum_ss);\n\n        $(\"<li><a class='kssmenuel' href='\"+Main.k.mushurl+\"/fds'><img src='/build/img/icons/skills/juge.png' />FDS</a></li>\").appendTo(play_ss);\n    }\n    Main.k.updateMainMenu();\n};","Main.k.updateMainMenu = function (){\n    var casting = $('#ctrlw-main-menu-castings');\n\n    // ************ CASTING SUBMENU ************\n    var casting_ss = casting.find(' > ul');\n    if(casting_ss.length > 0){\n        casting_ss.remove();\n    }\n    casting_ss = $(\"<ul>\").appendTo(casting);\n\n    var castings = Main.k.Game.data.castings;\n\n    if(!$.isEmptyObject(castings)) {\t// Check having casting\n        var casting_menu, cast_ss;\n        $.each(castings,function(id, casting){\n            casting_menu = $(\"<li></li>\")\n                .appendTo(casting_ss);\n\n            var a = $(\"<a class='kssmenuel' href='\"+Main.k.mushurl+\"/group/\"+casting.id+\"'><img src='\"+casting.icon+\"' />\"+casting.short_name+\"</a>\")\n                .appendTo(casting_menu);\n\n            if(casting.long_name != casting.short_name){\n                a\n                    .attr(\"_title\", Main.k.text.gettext(\"Nom complet\"))\n                    .attr(\"_desc\", \"<strong>\"+casting.long_name+\"</strong>\")\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip)\n            }\n\n            cast_ss = $(\"<ul>\").appendTo(casting_menu);\n            $(\"<li><a href='\"+Main.k.mushurl+\"/group/page/\"+casting.id+\"'><img src='\" + Main.k.mushurl + \"/img/icons/skills/conceptor.png' />\"+Main.k.text.gettext(\"Mémoire\")+\"</a></li>\").appendTo(cast_ss); // Pages\n            $(\"<li><a href='\"+Main.k.mushurl+\"/group/nexus/\"+casting.id+\"'><img src='\" + Main.k.mushurl + \"/img/icons/skills/logistics.png' />\"+Main.k.text.gettext(\"Nexus\")+\"</a></li>\").appendTo(cast_ss); // Nexus\n            $(\"<li><a href='\"+Main.k.mushurl+\"/group/forum/\"+casting.id+\"'><img src='\" + Main.k.servurl + \"/img/radioh.png' />\"+Main.k.text.gettext(\"Forum\")+\"</a></li>\").appendTo(cast_ss); // Forum\n            $(\"<li><a href='\"+Main.k.mushurl+\"/group/members/\"+casting.id+\"'><img src='\" + Main.k.mushurl + \"/img/icons/skills/optimistic.png' />\"+Main.k.text.gettext(\"Membres\")+\"</a></li>\").appendTo(cast_ss); // Members\n            $(\"<li><a href='\"+Main.k.mushurl+\"/group/history/\"+casting.id+\"'><img src='\" + Main.k.mushurl + \"/img/icons/skills/hunt.png' />\"+Main.k.text.gettext(\"Historique\")+\"</a></li>\").appendTo(cast_ss); // History\n        });\n        $(\"<li style='height:2px'>&nbsp</li>\").appendTo(casting_ss);\n    }\n    $(\"<li><a href='http://mtrg.kubegb.fr/' class='kssmenuel ext' title='Mush Triumph Remap Generator'><img src='\"+Main.k.mushurl+\"/img/icons/ui/triumph.png' />MTRG</a></li>\").appendTo(casting_ss); // Mush Triumph Remap Generator\n    // ************ NEW: CASTING SUBMENU ************\n};","Main.k.css.bubbles = function() {\n    var d = \"3px\";\n    var custombubbles_glow = \"text-shadow: 0 0 \" + d + \" #FFF, 0 0 \" + d + \" #FFF, 0 0 \" + d + \" #FFF, 0 0 \" + d + \" #FFF, 0 0 \" + d + \" #FFF, 0 0 \" + d + \" #FFF, 0 0 \" + d + \" #FFF;\";\n\n    $(\"head\").append(\n        $(document.createElement(\"link\")).attr({rel: \"stylesheet\", type: \"text/css\", href: Main.k.servhost+'/css/bubbles.css'})\n    );\n\n    //$(\"<link rel='stylesheet' type='text/css'>\")\n    //    .attr('src', Main.k.servhost+'/css/bubbles.css')\n    //    .appendTo(\"head\");\n};","Main.k.css.customMenu = function() {\n    $(\"head\").append(\n        $(document.createElement(\"link\")).attr({rel: \"stylesheet\", type: \"text/css\", href: Main.k.servhost+'/css/customMenu.css'})\n    );\n\n    //$(\"<link rel='stylesheet' type='text/css'>\")\n    //    .attr('src', Main.k.servhost+'/css/customMenu.css')\n    //    .appendTo(\"head\");\n};","Main.k.css.ingame = function() {\n    Main.k.css.bubbles();\n\n    $(\"head\").append(\n        $(document.createElement(\"link\")).attr({rel: \"stylesheet\", type: \"text/css\", href: Main.k.servhost+'/css/ingame.css'})\n    );\n\n    //$(\"<link rel='stylesheet' type='text/css'>\")\n    //    .attr('src', Main.k.servhost+'/css/ingame.css')\n    //    .appendTo(\"head\");\n\n    if (navigator.userAgent.indexOf(\"Firefox\")==-1) {\n        $(\".usLeftbar .hero .icons\").css(\"padding-right\", \"30px\");\n    }\n};","Main.k.Game.clear = function(){\n    Main.k.Game.data.day = 0;\n    $this.save();\n};","Main.k.Game.save = function() {\n    localStorage.setItem(\"ctrlw_game\",JSON.stringify(Main.k.Game.data));\n};","Main.k.Game.updateDayAndCycle = function(day,cycle) {\n    if(day != this.data.day || cycle != this.data.cycle){\n        this.data.day = day;\n        this.data.cycle = cycle;\n        Main.k.onCycleChange();\n        this.updatePlayerInfos();\n        this.save();\n    }\n};","Main.k.Game.updatePlayerInfos = function() {\n    var $this = this;\n    console.info('Mise à jour des infos joueurs - envoi');\n    Tools.ping('/me',function(content) {\n        console.group('Mise à jour des infos joueurs - retour');\n        var body = '<div id=\"body-mock\">' + content.replace(/^[\\s\\S]*<body.*?>|<\\/body>[\\s\\S]*$/g, '') + '</div>';\n        var jobject = $(body);\n        console.log('récupération de l\\'xp');\n        if(jobject.find('#cdActualXp').length > 0){\n            $this.data.xp = jobject.find('#cdActualXp').text();\n            console.log('xp',$this.data.xp);\n        }\n        console.log('récupération du statut du joueur');\n        if(jobject.find('#experience .bought.goldactive').length > 0){\n            $this.data.player_status = 'gold';\n            console.log('le joueur est gold');\n        }else if(jobject.find('#experience .bought').length > 0){\n            $this.data.player_status = 'silver';\n            console.log('le joueur est silver');\n        }else{\n            $this.data.player_status = 'bronze';\n            console.log('le joueur est bronze');\n        }\n\n        $this.data.castings = {};\n        jobject.find('#profile .bgtablesummar:last li').each(function(index, element) {\n            var casting = {};\n            casting.id = $(this).find('a').attr('href').replace('/group/','');\n            casting.icon = $(this).find('img').attr('src');\n            var str = jobject.find('.nameCast a:eq('+index+')').text();\n            casting.long_name = casting.short_name = str;\n            if(str.length > 18){\n                casting.short_name = str.match(/\\b(\\w)/g).join('.').concat('.');\n            }\n            $this.data.castings[casting.id] = casting;\n        });\n\n        $this.save();\n        Main.k.MushUpdate();\n        Main.k.updateMainMenu();\n        Main.k.quickNotice(Main.k.text.gettext('Infos du joueur mises à jour.'));\n    });\n};","\nMain.k.Options.open = function() {\n    if (Main.k.folding.displayed == \"options\") {\n        Main.k.folding.displayGame();\n        return;\n    }\n\n    if (!Main.k.Options.initialized) {\n        Main.k.Options.initialized = true;\n\n        var td = $(\"<td>\").addClass(\"chat_box\").css({\n            \"padding-right\": \"6px\",\n            \"padding-top\": \"1px\",\n            transform: \"scale(0,1)\",\n            color: \"rgb(9,10,97)\"\n        }).attr(\"id\", \"options_col\").appendTo($(\"table.inter tr\").first());\n\n        $(\"<p>\").addClass(\"warning\").text(Main.k.text.gettext(\"Plus d'options disponibles prochainement.\")).appendTo(td);\n\n\n        for (var i=0; i<Main.k.Options.options.length; i++) {\n            var opt = Main.k.Options.options[i];\n            var html = opt[4];\n            if (opt[2]) html += \" \"+Main.k.text.gettext(\"Nécessite un rechargement de la page.\");\n\n            var p = $(\"<p>\").css({\n                color: \"#EEE\",\n                padding: \"5px\",\n                border: \"1px dashed #EEE\",\n                background: \"rgba(255,255,255,0.1)\",\n                margin: \"10px 20px\",\n                clear: \"both\"\n            })\n                .html('<label style=\"margin-left: 30px;display:block\" for=\"ctrlw_'+opt[0]+'\">' + html + '</label>')\n                .appendTo(td);\n\n            var chk = $(\"<input>\").css({\n                \"float\": \"left\"\n            })\n                .attr(\"type\", \"checkbox\")\n                .attr(\"optname\", opt[0])\n                .attr(\"id\", 'ctrlw_'+opt[0])\n                .attr(\"opti\", i)\n                .on(\"change\", Main.k.Options.update)\n                .prependTo(p);\n            if (opt[1]) chk.attr(\"checked\", \"checked\");\n        }\n\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/reported.png' style='vertical-align: -20%' /> \"+ Main.k.text.gettext(\"Vider le cache du script\"), null, null, Main.k.text.gettext(\"Vider le cache du script\"),\n            Main.k.text.gettext(\"Ce bouton vous permet de vider le cache du script pour, par exemple, prendre en compte tout de suite votre mode Or ou forcer une vérification de mise à jour. A utiliser avec parcimonie svp.\"))\n            .appendTo(td).find(\"a\").on(\"mousedown\", function(){\n                Main.k.clearCache();\n            });\n    }\n\n    Main.k.folding.display([null,null, \"#options_col\"], \"options\");\n};","Main.k.Options.update = function(e) {\n    var tgt = $(e.target);\n    var key = $(tgt).attr(\"optname\");\n    var val = $(tgt).is(\":checked\") ? \"y\" : \"n\";\n    var i = $(tgt).attr(\"opti\");\n\n    Main.k.Options.updateOpt(key,val);\n    Main.k.Options.updateCookie();\n    if (Main.k.Options.options[i][3]) Main.k.Options.options[i][3]();\n};","Main.k.Options.updateCookie = function() {\n    var cook = \"\";\n    for (var i=0; i<Main.k.Options.options.length; i++) {\n        if (i>0) cook += \"|\";\n        cook += Main.k.Options.options[i][0] + \":\";\n        cook += Main.k.Options.options[i][1] ? \"y\" : \"n\";\n    }\n\n    js.Cookie.set(\"ctrlwoptions\",cook,420000000);\n};","Main.k.Options.updateOpt = function(key, val) {\n    switch(key) {\n        case \"custombubbles\":\n        case \"cbubbles\":\n            Main.k.Options.cbubbles = (val == \"y\");\n            Main.k.Options.options[0][1] = (val == \"y\");\n            break;\n        case \"custombubbles_nobackground\":\n        case \"cbubblesNB\":\n            Main.k.Options.cbubblesNB = (val == \"y\");\n            Main.k.Options.options[1][1] = (val == \"y\");\n            break;\n        case \"displaylogo\":\n        case \"dlogo\":\n            Main.k.Options.dlogo = (val == \"y\");\n            Main.k.Options.options[2][1] = (val == \"y\");\n            break;\n        case \"splitpjt\":\n            Main.k.Options.splitpjt = (val == \"y\");\n            Main.k.Options.options[3][1] = (val == \"y\");\n            break;\n        //case \"altpa\":\n        //\tMain.k.Options.altpa = (val == \"y\");\n        //\tMain.k.Options.options[4][1] = (val == \"y\");\n        //\tbreak;\n    }\n};","//USERSCRIPT\n\n//GLOBAL VAR\n\n//FUNCTIONS\n\n//MAIN - INIT TRANS\n\n//MAIN - INIT DATA\n\n//MAIN - INIT\n\n// ************ NEW: CASTING SUBMENU ************\n//MAIN displayMainMenu\n\n//MAIN updateMainMenu\n\n/**\n *\n * @param arr\n * @param o\n * @returns {boolean}\n */\nMain.k.ArrayContains = function(arr, o) {\n    for (var a in arr) {\n        if (a == o) return true;\n    }\n    for (var i=0; i<arr.length; i++) {\n        if (arr[i] == o) return true;\n    }\n    return false;\n};\nMain.k.EliminateDuplicates = function(arr) {\n    var i, len=arr.length, out=[], obj={};\n    for (i=0;i<len;i++) obj[arr[i]]=0;\n    for (i in obj){\n        if (obj.hasOwnProperty(i)) {\n            out.push(i);\n        }\n    }\n    return out;\n};\nMain.k.CreatePopup = function() {\n    var popup = {};\n\n    popup.dom = $(\"<td>\").attr(\"id\", \"usPopup\").addClass(\"usPopup chat_box\");\n    popup.mask = $(\"<div>\").addClass(\"usPopupMask\").attr('onclick','Main.k.ClosePopup();').appendTo(popup.dom);\n    popup.content = $(\"<div>\").addClass(\"usPopupContent chattext\").css({\n        \"width\": (Main.k.window.innerWidth - 300) + \"px\",\n        \"height\": (Main.k.window.innerHeight - 100) + \"px\"\n    }).appendTo(popup.dom);\n\n    return popup;\n};\nMain.k.OpenPopup = function(popup) { $(\"body\").append(popup); };\nMain.k.ClosePopup = function() {\n    var popup = $(\"#usPopup\");\n    if (!popup.get()) return;\n\n    popup.remove();\n    var tgt = $(\"#formattingpopuptgt\");\n    if (tgt.get()) {\n        tgt.focus();\n        tgt.attr(\"id\", \"\");\n    }\n};\nexportFunction(Main.k.ClosePopup, unsafeWindow.Main.k, {defineAs: \"ClosePopup\"});\nMain.k.CreateNeronAlert = function(message){\n    var neronAlert = Main.k.CreatePopup();\n    neronAlert.content.css({\n        \"height\": \"auto\",\n        \"max-height\": \"90%\",\n        \"width\": \"500px\",\n        \"color\": \"#FFF\"\n    });\n\n    var content = \"<img class=\\\"img_neron\\\" alt='neron' src='/build/img/design/neron_chat.png' /><p>\"+ message +\"</p>\";\n    // Fill neronAlert content\n    var cancelAc = \"'Main.k.ClosePopup();'\";\n    var ok = \"<div id=\\\"cancel\\\" class=\\\"but updatesbtn\\\" onclick=\" + cancelAc + \"><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a href=\\\"#\\\">\" + Main.k.text.gettext(\"ok\") + \"</a></div></div></div></div>\";\n    var buttons = $('<div class=\"neron_alert_buttons\"></div>');\n    buttons.append(ok);\n    $('<div>')\n        .attr(\"id\",\"neron_alert_content\")\n        .append(content)\n        .append(buttons)\n        .appendTo(neronAlert.content);\n\n    // Display neronAlert\n    Main.k.OpenPopup(neronAlert.dom);\n};\nMain.k.CreateNeronPrompt = function(){\n    var NeronPrompt = Main.k.CreatePopup();\n    NeronPrompt.content.css({\n        \"height\": \"auto\",\n        \"max-height\": \"90%\",\n        \"width\": \"500px\",\n        \"color\": \"#FFF\"\n    });\n\n    var cancelAc = \"'Main.k.ClosePopup();'\";\n    // Fill prompt content\n    var validate = \"<div id=\\\"validate\\\" class=\\\"but updatesbtn\\\" ><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a href=\\\"#\\\">\" + Main.k.text.gettext(\"valider\") + \"</a></div></div></div></div>\";\n    var cancel = \"<div id=\\\"cancel\\\" class=\\\"but updatesbtn\\\" onclick=\"+cancelAc+\"><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a href=\\\"#\\\">\" + Main.k.text.gettext(\"annuler\") + \"</a></div></div></div></div>\";\n    var input = \"<input type='text' name='neron_prompt'>\";\n    var content = \"<img class=\\\"img_neron\\\" alt='neron' src='/build/img/design/neron_chat.png' /><p>\" + Main.k.text.gettext(\"Saisissez le titre du message\") + \" : </p>\";\n\n\n    $(\"<div>\")\n        .attr(\"id\",\"neron_alert_content\")\n        .html(content + input + \"<br/>\" + validate + cancel)\n        .appendTo(NeronPrompt.content);\n\n    // Display prompt\n    Main.k.OpenPopup(NeronPrompt.dom);\n};\n\n\n\nMain.k.CustomTip = function(e) {\n    var tgt = (e || event).target;\n    var title = tgt.getAttribute(\"_title\");\n    var desc = tgt.getAttribute(\"_desc\");\n    if (desc) desc = desc.replace(/(\\\\r|\\\\n)/g, \"\");\n    var max = 3, current = 0, t = tgt;\n    while (!title && !desc && current<max) {\n        t = t.parentNode;\n        title = t.getAttribute(\"_title\");\n        desc = t.getAttribute(\"_desc\");\n        if (desc) desc = desc.replace(/(\\\\r|\\\\n)/g, \"\");\n        current++;\n    }\n\n    Main.showTip(tgt,\n        \"<div class='tiptop' ><div class='tipbottom'><div class='tipbg'><div class='tipcontent'>\" +\n        (title ? \"<h1>\" + title + \"</h1>\" : \"\") +\n        (desc ? \"<p>\" + desc.replace(\"\\n\", \"\") + \"</p>\" : \"\") +\n        \"</div></div></div></div>\"\n    );\n};\nMain.k.hideTip = function(){\n    Main.hideTip();\n};\n\nMain.k.MakeButton = function(content, href, onclick, tiptitle, tipdesc) {\n    var but = $(\"<div>\").addClass(\"action but\");\n    var butbr = $(\"<div>\").addClass(\"butright\").appendTo(but);\n    var butbg = $(\"<div>\").addClass(\"butbg\").appendTo(butbr);\n\n    var buta = $(\"<a>\").attr(\"href\", href ? href : \"#\").html(content).appendTo(butbg)\n        .on(\"click\", onclick ? onclick : href ? null : function() { return false; });\n\n    /* Translators: domain name*/\n    if(href !=null && href.indexOf(Main.k.text.gettext('mush.vg'))){\n        buta.attr('target','_blank');\n    }\n\n    if (tiptitle || tipdesc) {\n        if (tiptitle) buta.attr(\"_title\", tiptitle);\n        if (tipdesc) buta.attr(\"_desc\", tipdesc);\n        buta.on(\"mouseover\", Main.k.CustomTip);\n        buta.on(\"mouseout\", Main.k.hideTip);\n    }\n\n    return but;\n};\nMain.k.quickNotice = function(msg,type){\n    if(typeof(type) == 'undefined' || type == 'info'){\n        $.jGrowl(\"<img src='http://imgup.motion-twin.com/twinoid/8/5/ab7aced9_4030.jpg' height='16' alt='notice'/> \"+msg);\n    }else if(type == 'error'){\n        $.jGrowl(\"<img src='http://imgup.motion-twin.com/twinoid/9/a/8429c028_4030.jpg' height='16' alt='notice'/> \"+msg,{\n            theme:'ctrlw-error',\n            life: 6000\n        });\n    }\n};\nMain.k.quickNoticeError = function(msg){\n    Main.k.quickNotice(msg,'error');\n};\n/**\n * @param {object} topic\n * @return string\n */\nMain.k.GetHeroNameFromTopic = function(topic) {\n    var hero = '';\n    var div = null;\n\n    // First tries to get the character-specific css class name\n    if (topic.find(\".char,.tid_char\").length >0) {\n        div = topic.find(\".char,.tid_char\");\n        hero = div.attr('class').replace(\"char \", \"\").replace(\"tid_char tid_\", \"\");\n    }\n\n    // If it failed, compare the image position with custom outfits\n    if (div != null && hero == '') {\n        var sp = div.css('backgroundPosition').split(\" \");\n        var pos_y = sp[1];\n\n        // Don't need to check if undefined thanks to the shield in the return\n        hero = Main.k.cssToHeroes[pos_y];\n    }\n\n    // If no hero found (hero = \"\" or hero = undefined), use jin su\n    return hero ? hero : \"jin_su\";\n};\nMain.k.SyncAstropad = function(tgt){\n    var $astro_maj_inventaire = $('#astro_maj_inventaire');\n    if($astro_maj_inventaire.length > 0){\n        $astro_maj_inventaire[0].click();\n        Main.k.quickNotice(Main.k.text.gettext(\"Astropad synchronisé.\"));\n        Main.showTip(tgt,\n            \"<div class='tiptop' ><div class='tipbottom'><div class='tipbg'><div class='tipcontent'>\" +\n            Main.k.text.gettext(\"Astropad synchronisé.\") +\n            \"</div></div></div></div>\"\n        );\n    }\n};\n// Shows the actual number of remaining cycles\nMain.k.displayRemainingCyclesToNextLevel = function (){\n    $('.levelingame').each(function(){\n        var attr, xp_by_cycle;\n        var regex = /(<p>.*>[^0-9]?)([0-9]+)([a-zA-Z ]*)(<)(.*<\\/p>)/;\n        if($(this).attr('onmouseover_save') !== undefined){\n            attr = $(this).attr('onmouseover_save');\n        }else{\n            attr = $(this).attr('onmouseover');\n            $(this).attr('onmouseover_save',attr);\n        }\n        if(regex.exec(attr) != null){\n            if(Main.k.Game.data.player_status == 'gold'){\n                xp_by_cycle = 2;\n            }else{\n                xp_by_cycle = 1;\n            }\n            var i_cycles = RegExp.$2;\n            var i_cycles_save = localStorage.getItem('ctrlw_remaining_cycles');\n            localStorage.setItem('ctrlw_remaining_cycles',i_cycles);\n            if(i_cycles_save != i_cycles && i_cycles_save != null){\n                Main.k.Game.updatePlayerInfos();\n            }\n            var remaining_cycles = Math.ceil(i_cycles - Main.k.Game.data.xp / xp_by_cycle);\n            var i_daily_cycle = 8;\n            if($('.miniConf img[src*=\"fast_cycle\"]').length > 0){\n                i_daily_cycle = 12;\n            }else if($('.miniConf img[src$=\"blitz_cycle.png\"]').length > 0){\n                i_daily_cycle = 24;\n            }\n\n            var nb_days = Math.round(remaining_cycles / i_daily_cycle);\n            var s_days = '';\n            if(nb_days > 0){\n                s_days = Main.k.text.strargs(Main.k.text.ngettext(\"(~%1 jour)\",\"(~%1 jours)\",nb_days),[nb_days]);\n                s_days = ' '+s_days;\n            }\n            $(this).attr('onmouseover',attr.replace(regex,\"$1\"+remaining_cycles+\"$3\"+s_days+\"$4\"+\"$5\"));\n        }\n    });\n    if($('.levelingame_no_anim').length > 0){\n        localStorage.setItem('ctrlw_remaining_cycles',0);\n    }\n};\nMain.k.showLoading = function(){\n    if($('.ctrlw_overlay_loading').length == 0){\n        var overlay = $('<div class=\"ctrlw_overlay_loading\"></div>');\n        $('body').append(overlay);\n        overlay.after('<div class=\"ctrlw_loading_ball_wrapper\"><div class=\"ctrlw_loading_ball\"></div><div class=\"ctrlw_loading_ball1\"></div></div>');\n\n    }\n};\nMain.k.hideLoading = function(){\n    $('.ctrlw_overlay_loading,.ctrlw_loading_ball_wrapper').remove();\n};\nMain.k.clearCache = function(){\n    Main.k.showLoading();\n    Main.k.Game.clear();\n    localStorage.removeItem('ctrlw_update_cache');\n    localStorage.removeItem('ctrlw_remaining_cycles');\n    window.location.reload();\n};\n// BUG\nMain.k.treatingBug = function(e){\n    Main.k.errorList += e;\n};\nMain.k.displayBug = function(e){\n    var displayBug = \"\";\n    var error = [];\n    if(Main.k.errorList != undefined){\n        error = Main.k.errorList;\n    }\n\n    for(var idBug = 0;idBug < error.length;idBug++){\n        displayBug += \"Name : \"+error[idBug].name+\"Message : \"+error[idBug].message+\"\\n\";\n    }\n    if(error.length > 0) {alert(\"nbError : \"+error.length+\"\\n\\n\"+displayBug);}\n};\nMain.k.countdownTimer = {};\nMain.k.countdownTimer.counters = {};\nMain.k.countdownTimer.go = function(seconds, id, callback){\n    var count = seconds;\n    var $this = this;\n    this.counters[id] = setInterval(function(){\n        count--;\n        callback(count);\n        if(count <= 0){\n            clearInterval($this.counters[id]);\n        }\n    }, 1000); //1000 will  run it every 1 second\n};\n\nMain.k.countdownTimer.stop = function (id){\n    if(typeof(this.counters[id]) != \"undefined\"){\n        clearInterval(this.counters[id]);\n    }\n};\n// == Game Manager\n\n\n\n\n\n\n\n// == Options Manager  ========================================\n// == /Options Manager  =======================================\n\nMain.k.tabs = {};\nMain.k.tabs.playing = function() {\n    var callbacks_storage_sync = $.Callbacks();\n    Main.k.css.ingame();\n\n    // Open links in a new tab\n    $(\"ul.kmenu a.ext\").on(\"click\", function() { Main.k.window.open(this.href); return false; });\n    Main.k.hasTalkie = $(\"#walltab\").length > 0;\n\n    $('#swf_ISO_MODULE').click(function(){\n        var fake_on = $('.fakeitem.on');\n        if(fake_on.length == 1){\n            Main.k.fakeSelectItem(fake_on);\n        }\n    });\n\n    // == Extend Prototype  =======================================\n    /*Selection.prototype.cancelSelection = function(node) {\n     var doHeroInv = node != null?node.parents(\"#myInventory\").length > 0:true;\n     var doRoomInv = node != null?node.parents(\".inventory\").length > 0:true;\n     if(doHeroInv) {\n     js.Cookie.set(CrossConsts.COOK_SEL,null,3600);\n     var allItems = Selection.j(\"#myInventory .item\").not(\".cdEmptySlot\");\n     Selection.j(\".cdCharColSel\").remove();\n     Selection.j(\"#myInventory .selected\").parent().removeClass(\"on\");\n     Selection.j(\"#myInventory .selected\").remove();\n     Lambda.iter(allItems.toArray(),function(h) {\n     h.onclick = function(e) {\n     Main.selectItem(h);\n     };\n     });\n     this.currentInvSelection = null;\n     Main.acListMaintainer.refreshHeroInv();\n     null;\n     }\n     if(doRoomInv) {\n     js.Cookie.set(CrossConsts.COOK_SEL,null,3600);\n     var allItems = Selection.j(\".inventory .item\").not(\".cdEmptySlot\");\n     Selection.j(\".inventory .selected\").parent().removeClass(\"on\");\n     Selection.j(\".inventory .selected\").remove();\n     Selection.j(\"#tt_itemname\").text(\"\");\n     Lambda.iter(allItems.toArray(),function(h1) {\n     h1.onclick = function(e) {\n     Main.selectItem(h1);\n     };\n     });\n     this.currentRoomSelection = null;\n     Main.acListMaintainer.refreshRoomInv();\n     null;\n     }\n     if(!Main.closet.visible) {\n     var prx = Main.rmMan.getProxy(Clients.ISO_MODULE);\n     if(prx != null) prx._setBaseLine(439);\n     Selection.j(\".inv\").css(\"visibility\",\"hidden\");\n     }\n     }\n     Closet.prototype.show = function(forced,immediate) {\n     var _g = this;\n     var doIt = function() {\n     $(\".invcolorbg\").show();\n     $(\".inv#cdInventory\").addClass(\"placard_on\");\n     _g.visible = true;\n     if(!forced) Main.cancelSelection();\n     $(\".inv\").css(\"visibility\",\"visible\");\n     $(\".inv\").css(\"display\", \"block\");\n     $(\".inv\").css(\"margin-top\", \"-194px\");\n     var invbloc = $(\"#cdInventory .invcolorbg\");\n     invbloc.css(\"display\", \"block\");\n     invbloc.find(\".exceed\").css(\"display\", \"block\");\n     invbloc.find(\".arrowleft\").css(\"display\", \"block\");\n     invbloc.find(\".arrowright\").css(\"display\", \"block\");\n     $(\"#cdItemActions\").removeClass(\"selectplayer\");\n     var prx = Main.rmMan.getProxy(Clients.ISO_MODULE);\n     if(prx != null) prx._setBaseLine(CrossConsts.BASELINE_CLOSET);\n     };\n     if(Main.isTuto() && !forced && (Main.uiFlags().rep & 1 << UI_FLAGS.UF_EXPECT_CLOSET_OPENED[1]) != 0) Tools.updateContent(\"/co\",Main.selUpdtArr,null,function() {\n     Main.resetJs();\n     doIt();\n     }); else doIt();\n     }*/\n    $.fn.insertAtCaret = function(text) {\n        return this.each(function() {\n            if (this.selectionStart || this.selectionStart == '0') {\n                var startPos = this.selectionStart;\n                var endPos = this.selectionEnd;\n                var scrollTop = this.scrollTop;\n                this.value = this.value.substring(0, startPos) + text + this.value.substring(endPos, this.value.length);\n                this.focus();\n                this.selectionStart = startPos + text.length;\n                this.selectionEnd = startPos + text.length;\n                this.scrollTop = scrollTop;\n            } else {\n                this.value += text;\n                this.focus();\n                this.value = this.value;\n            }\n        });\n    };\n    $.fn.insertAroundCaret = function(b, a) {\n        return this.each(function() {\n            if (this.selectionStart || this.selectionStart == '0') {\n                var startPos = this.selectionStart;\n                var endPos = this.selectionEnd;\n                var scrollTop = this.scrollTop;\n                this.value = this.value.substring(0, startPos) + b + this.value.substring(startPos, endPos) + a + this.value.substring(endPos, this.value.length);\n                this.focus();\n                this.selectionStart = startPos + b.length;\n                this.selectionEnd = endPos + a.length;\n                this.scrollTop = scrollTop;\n            } else {\n                this.value += b + a; // TODO: move caret?\n                this.focus();\n                this.value = this.value;\n            }\n        });\n    };\n    $.fn.addHeroDescToolTip = function(dev_surname){\n        var $desc = $('<div/>');\n        var $tooltip_title = $('<div/>');\n        var name;\n        var o_hero = Main.k.Profiles.get(dev_surname);\n        $tooltip_title.append(o_hero.name);\n\n        $.each(o_hero.titles,function(k,title){\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/\" + title.img + \".png\")\n                .css({\n                    'margin-left': '5px',\n                    'line-height': '7px'\n                })\n                .attr(\"alt\", title.img)\n                .appendTo($tooltip_title);\n        });\n        var $statuses = $(\"<div>\").addClass(\"icons statuses\").css('float','right');\n        $desc.append($statuses);\n        if(o_hero.statuses.length > 0){\n            $.each(o_hero.statuses,function(k,status){\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/status/\" + status.img + \".png\")\n                    .attr(\"height\", \"16\").attr(\"alt\", status.img)\n                    .appendTo($statuses);\n            });\n        }\n        if(typeof(o_hero.spores) != 'undefined' && o_hero.spores != null){\n            var $spores = $('<div>')\n                .css({\n                    position: 'relative',\n                    display: 'inline-block',\n                    'margin-left': '2px',\n                    top: '2px'\n                })\n                .appendTo($statuses);\n\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/spore.png\")\n                .attr(\"height\", \"16\").attr(\"alt\", o_hero.spores.name)\n                .attr(\"_title\", o_hero.spores.name)\n                .attr(\"_desc\", o_hero.spores.desc)\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip)\n                .appendTo($spores);\n\n            $('<span>')\n                .text(o_hero.spores.nb)\n                .css({\n                    color: '#FFF',\n                    'font-size': \"10px\",\n                    position: 'absolute',\n                    left: '4px',\n                    top: '1px',\n                    opacity: 0.7,\n                    'pointer-events': 'none'\n\n                })\n                .appendTo($spores);\n        }\n        if(o_hero.skills.length > 0) {\n            var $skills = $(\"<p>\").addClass(\"icons skills\");\n            $.each(o_hero.skills, function (k, skill) {\n                var $skilldom = $(\"<span>\").addClass(\"skill\").appendTo($skills);\n\n                $(\"<img>\").attr(\"src\", \"/img/icons/skills/\" + skill.img + \".png\")\n                    .attr(\"height\", \"19\").attr(\"alt\", skill.img)\n                    .appendTo($skilldom);\n\n                if (Main.k.compInactiveMush[skill.img]) {\n                    $(\"<img>\").attr(\"src\", Main.k.servurl_badconker + \"/img/non-mush.png\").addClass(\"actmush\")\n                        .attr(\"width\", \"10\").attr(\"height\", \"10\")\n                        .appendTo($skilldom);\n                }\n                $desc.append($skills);\n            });\n        }\n\n        $desc.append('<div class=\"clear\"></div>');\n        $desc.append('<p>' + o_hero.short_desc.htmlEncode().replace(/([\\r\\n]+)/g, \"<br/>\") + '</p>');\n\n\n        $desc.append('<p><strong>' + Main.k.text.gettext(\"Cliquez pour plus d'informations\") + '</strong></p>');\n        $(this)\n            .attr(\"_title\", $tooltip_title.html())\n            .attr(\"_desc\", $desc.html())\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip);\n        return $(this);\n    };\n    $.fn.addTooltip = function(title,text){\n        $(this)\n            .attr(\"_title\", title)\n            .attr(\"_desc\", text)\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip);\n        return $(this);\n    };\n    /*haxe.remoting.ExternalConnection.prototype.call = function(params) {\n     var s = new haxe.Serializer();\n     s.serialize(params);\n     var params1 = s.toString();\n     var data = null;\n     var fobj = Main.k.window.document[this.__data.flash];\n     if(fobj == null) {\n     fobj = Main.k.window.document.getElementById(this.__data.flash);\n     }\n     if(fobj == null) {\n     throw \"Could not find flash object '\" + this.__data.flash + \"'\";\n     }\n     try {\n     if (fobj.externalRemotingCall) {\n     data = fobj.externalRemotingCall(this.__data.name,this.__path.join(\".\"),params1);\n     }\n     } catch( e ) {\n     }\n     if(data == null) {\n     var domain, pageDomain;\n     try {\n     domain = fobj.src.split(\"/\")[2];\n     pageDomain = js.Lib.window.location.host;\n     } catch( e ) {\n     domain = null;\n     pageDomain = null;\n     }\n     if(domain != pageDomain) throw \"ExternalConnection call failure : SWF need allowDomain('\" + pageDomain + \"')\";\n     throw \"Call failure : ExternalConnection is not initialized in Flash\";\n     }\n     return new haxe.Unserializer(data).unserialize();\n     }*/\n    // == /Extend Prototype =======================================\n\n\n    // == Extend Reflect  =========================================\n    /*var Reflect = function() {};\n     $hxClasses[\"Reflect\"] = Reflect;\n     Reflect.__name__ = [\"Reflect\"];\n     Reflect.field = function(o,field) {\n     var v = null;\n     try {\n     v = o[field];\n     } catch( e ) {\n     }\n     return v;\n     }\n     Reflect.fields = function(o) {\n     var a = [];\n     if(o != null) {\n     var hasOwnProperty = Object.prototype.hasOwnProperty;\n     for( var f in o ) {\n     if(hasOwnProperty.call(o,f)) a.push(f);\n     }\n     }\n     return a;\n     }\n     Reflect.copy = function(o) {\n     var o2 = { };\n     var _g = 0, _g1 = Reflect.fields(o);\n     while(_g < _g1.length) {\n     var f = _g1[_g];\n     ++_g;\n     o2[f] = Reflect.field(o,f);\n     }\n     return o2;\n     }\n     Reflect.compare = function(a,b) { return a == b?0:a > b?1:-1; }*/\n    // == /Extend Reflect =========================================\n\n\n    // == Extend Main  ============================================\n    Main.k.extend = createObjectIn(unsafeWindow.Main.k, {defineAs: \"extend\"});\n    Main.k.extend.updateContent =  Main.updateContent;\n    Main.updateContent = function(url,seek,dest,cb) {\n        console.log('update content');\n        Main.k.extend.updateContent(url,seek,dest,function(){\n            try {\n                if (cb != null) cb();\n            } catch (e) {\n                console.error('erreur',e);\n                Main.k.MushUpdate();\n            }\n\n            if(/\\/choosePeer\\?charId=[0-9]+&idx=([0-9]+)/.test(url)){\n                var tab_class = '.cdPrivateTab' + RegExp.$1;\n                Main.k.MushUpdate();\n                if($(tab_class).length > 0){\n                    $(tab_class).trigger('click');\n                }\n            }\n        });\n    };\n    addFctToPage(Main.updateContent,'Main.updateContent');\n\n    //Main.k.extend.onChatFocus = Main.onChatFocus;\n    Main.k.extend.onChatFocus = function(t,i) {\n        //Main.k.extend.onChatFocus(t,i);\n        console.log('Main.rst',Main.rst);\n        if (0 == (Main.rst & 1 << i)) {\n            console.log('Main.rst if');\n            Main.rst |= 1 << i;\n\n            if (!t.parent().find(\".formatbtn\").get(0)) {\n\n                // Add formatting\n                $(\"<a>\").addClass(\"butmini chatformatbtn\").html(\"<img src='/build/img/icons/ui/pam.png' /> Formater\").attr(\"href\", \"#\").appendTo(t.parent())\n                    .on(\"click\", function () {\n                        var tgt = $(this);\n                        if (tgt.hasClass(\"butmini\")) tgt = tgt.parent().find(\"textarea\");\n\n                        Main.k.Manager.openOn(\"newtopic\", tgt.val());\n                        return false;\n                    });\n\n                // Display chat button & fix tabindex\n                t.siblings(\"input\").show();\n                t.siblings(\"input\").attr(\"tabindex\", 1);\n            }\n        }\n        console.log('onchatfocus end');\n    };\n    Main.k.extend.onChatInput = function(event) {\n        var jq = $(this);\n        var tgt = new mush_jquery(event.target);\n        tgt.siblings(\"input\").show();\n        if(event.keyCode == 13) {\n            if(!event.ctrlKey) {\n                event.preventDefault();\n                var pr = tgt.parent();\n                pr.submit();\n                Tools.send2Store(\"mush_chatContent_\" + jq.attr(\"id\"),\"\");\n                //jq.val('');\n                tgt.data(\"default\",true);\n            } else {\n                // Insert line break at caret, not at the end...\n                $(tgt).insertAtCaret(\"\\n\");\n                Tools.send2Store(\"mush_chatContent_\" + jq.attr(\"id\"),tgt.val());\n            }\n        } else Tools.send2Store(\"mush_chatContent_\" + jq.attr(\"id\"),tgt.val());\n    };\n    Main.k.extend.onWallInput = function(event) {\n        var tgt = new mush_jquery(event.target);\n        var val = tgt.val();\n        if(event.keyCode == 13) {\n            if(!event.ctrlKey && val.length > 1) {\n                event.preventDefault();\n                var updtArr = [\"cdTabsChat\",\"chatBlock\",\"char_col\"];\n                var scr = new js.JQuery(\".cdWallChannel\").scrollTop();\n                var sendChatProc = function() {\n                    Main.resetJs();\n                    var jq = new $(\".cdWallChannel\");\n                    jq.scrollTop(scr + 100);\n                };\n                unsafeWindow.sendChatProc = exportFunction(sendChatProc, unsafeWindow, {defineAs: \"sendChatProc\"});\n                if(Main.isTuto()) {\n                    updtArr.unshift(\"floating_ui_start\");\n                    updtArr.unshift(\"cdDialogs\");\n                    updtArr.push(\"ode\");\n                }\n                var stVal = encodeURIComponent(val);\n                var url = \"/wallReply?k=\" + Std.string(tgt.closest(\".unit\").data(\"k\")) + \"&msg=\" + stVal;\n                Main.updateContent(url,cloneInto(updtArr,unsafeWindow),null,unsafeWindow.sendChatProc);\n                Tools.send2Store(\"mush_wallReply_\" + tgt.attr(\"id\"),\"\");\n                tgt.val('');\n                tgt.data(\"default\",true);\n            } else {\n                // Insert line break at caret, not at the end...\n                $(tgt).insertAtCaret(\"\\n\");\n                Tools.send2Store(\"mush_wallReply_\" + tgt.attr(\"id\"),tgt.val());\n            }\n        } else Tools.send2Store(\"mush_wallReply_\" + tgt.attr(\"id\"),tgt.val());\n    };\n    Main.k.extend.onWallFocus = function() {//TODO: MULTILANG\n        jq = $(this);\n        console.info('Main.onWallFocus');\n        if (!jq.parent().find(\".formatbtn\").get(0)) {\n            jq.attr(\"onblur\", \"\");\n\n            var td = jq.parent().parent().siblings(\"td\").first();\n            var sharediv = $(\"<div>\").css({\n                \"margin-top\": \"20px\",\n                \"margin-left\": \"5px\"\n            }).appendTo(td);\n\n            // Life\n            $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='\" + Main.k.servurl + \"/img/viemoral.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                .on(\"click\", function() {\n                    var txt = Main.k.FormatLife();\n                    $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                    return false;\n                })\n                .attr(\"_title\", Main.k.text.gettext(\"Partager son état de santé\"))\n                .attr(\"_desc\", Main.k.text.gettext(\"<p>Insère votre nombre de points de vie et de moral dans la zone de texte active, de la forme&nbsp;:</p><p>TODO: example</p>\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            // Inventory\n            $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='http://data.hordes.fr/gfx/icons/item_bag.gif' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                .on(\"click\", function(e) {\n                    var txt = Main.k.FormatInventory();\n                    $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                    Main.k.SyncAstropad(e);\n                    return false;\n                })\n                .attr(\"_title\", Main.k.text.gettext(\"Partager l'inventaire\"))\n                .attr(\"_desc\", Main.k.text.gettext(\"Insère l'inventaire de la pièce dans la zone de texte active, de la forme&nbsp;:</p><p><strong>Couloir central :</strong> <i>Combinaison</i>, <i>Couteau</i>, <i>Médikit</i>, <i>Extincteur</i></p><p><strong>Partage aussi sur Astropad si celui-ci est installé.</strong></p>\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            // Conso\n            if ($(\"#pharmashare\").css(\"display\") != \"none\") {\n                $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/sat.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                    .on(\"click\", function() {\n                        var txt = Main.k.FormatPharma();\n                        $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                        return false;\n                    });\n            }\n\n            // Plants\n            if ($(\"#plantmanager\").length > 0) {\n                $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/plant_youngling.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                    .on(\"click\", function() {\n                        var txt = Main.k.FormatPlants();\n                        $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                        return false;\n                    })\n                    .attr(\"_title\", Main.k.text.gettext(\"Partager l'état des plantes\"))\n                    .attr(\"_desc\", Main.k.text.gettext(\"<p>Insère l'état des plantes dans la zone de texte active.</p><p>TODO: Exemple</p>\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            }\n\n            // Projects\n            if ($(\".shareprojectbtn\").length > 0) {\n                $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/conceptor.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                    .on(\"click\", function() {\n                        var txt = Main.k.FormatProjects();\n                        $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                        return false;\n                    })\n                    .attr(\"_title\", Main.k.text.gettext(\"Partager les projets\"))\n                    .attr(\"_desc\", Main.k.text.gettext(\"Insère la liste de projets dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                    \"<li><strong>Nom du projet</strong> - 0%<br/>Description du projet<br/>Bonus : <i>Tireur</i>, <i>Pilote</i></li>\" +\n                    \"<li><strong>Nom du projet</strong> - 0%<br/>Description du projet<br/>Bonus : <i>Tireur</i>, <i>Pilote</i></li>\" +\n                    \"<li><strong>Nom du projet</strong> - 0%<br/>Description du projet<br/>Bonus : <i>Tireur</i>, <i>Pilote</i></li>\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            }\n\n            // Research\n            if ($(\".shareresearchbtn\").length > 0) {\n                $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/microsc.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                    .on(\"click\", function() {\n                        var txt = Main.k.FormatResearch();\n                        $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                        return false;\n                    })\n                    .attr(\"_title\", Main.k.text.gettext(\"Partager les recherches\"))\n                    .attr(\"_desc\", Main.k.text.gettext(\"Insère la liste de recherches dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                    \"<li><strong>Nom de la recherche</strong> - 0%<br/>Description de la recherche<br/>Bonus : <i>Biologiste</i>, <i>Médecin</i></li>\" +\n                    \"<li><strong>Nom de la recherche</strong> - 0%<br/>Description de la recherche<br/>Bonus : <i>Biologiste</i>, <i>Médecin</i></li>\" +\n                    \"<li><strong>Nom de la recherche</strong> - 0%<br/>Description de la recherche<br/>Bonus : <i>Biologiste</i>, <i>Médecin</i></li>\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            }\n\n            // BIOS\n            if ($(\"#biosModule\").length > 0) {\n                $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/pa_core.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                    .on(\"click\", function() {\n                        var txt = Main.k.FormatBIOS();\n                        $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                        return false;\n                    })\n                    .attr(\"_title\", Main.k.text.gettext(\"Partager les paramètres BIOS\"))\n                    .attr(\"_desc\", Main.k.text.gettext(\"Insère la liste de paramètres BIOS Neron dans la zone de texte active, de la forme&nbsp;:</p><p>TODO: aperçu\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            }\n\n            // Planets\n            if ($(\"#navModule\").length > 0) {\n                $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/planet.png' />\").attr(\"href\", \"#\").appendTo(sharediv)\n                    .on(\"click\", function() {\n                        var txt = Main.k.FormatPlanets();\n                        $(this).parent().parent().siblings(\"td\").first().find(\"textarea\").insertAtCaret(txt);\n                        return false;\n                    })\n                    .attr(\"_title\", Main.k.text.gettext(\"Partager les planètes\"))\n                    .attr(\"_desc\", Main.k.text.gettext(\"<p>Insère les détails des planètes dans la zone de texte active.</p><p>TODO: Exemple</p>\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            }\n\n\n\n            // Formatting\n            var formatdiv = $(\"<div>\").addClass(\"replybuttons customreply\").appendTo(jq.parent());\n            formatdiv.siblings(\"textarea\").css({\"padding-bottom\": \"22px\", height: \"130px\"});\n\n            // Bold\n            $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<strong>B</strong>\").attr(\"href\", \"#\").appendTo(formatdiv)\n                .on(\"click\", function() {\n                    $(this).parent().parent().find(\"textarea\").insertAroundCaret(\"**\",\"**\");\n                });\n\n            // Italic\n            $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<i>I</i>\").attr(\"href\", \"#\").appendTo(formatdiv)\n                .on(\"click\", function() {\n                    $(this).parent().parent().find(\"textarea\").insertAroundCaret(\"//\",\"//\");\n                });\n\n            // Add smile\n            $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/moral.png' />\").attr(\"href\", \"#\").appendTo(formatdiv)\n                .on(\"click\", function() {\n                    // TODO\n                })\n                .attr(\"_title\", Main.k.text.gettext(\"Insérer un smiley\"))\n                .attr(\"_desc\", Main.k.text.gettext(\"Bientôt disponible.\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            // Empty textarea\n            $(\"<a>\").addClass(\"butmini\").html(\"<img src='/build/img/icons/ui/bin.png' />\").attr(\"href\", \"#\").appendTo(formatdiv)\n                .on(\"click\", function() {\n                    var t = $(this).closest(\".unit\").find(\"textarea\");\n                    t.val(\"\");\n                    t.focus();\n                    return false;\n                })\n                .attr(\"_desc\", Main.k.text.gettext(\"Vider la zone de texte.\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            // Close textarea\n            $(\"<a>\").addClass(\"butmini\").html(\"<img src='/build/img/icons/ui/status/unsociable.png' />\").attr(\"href\", \"#\").appendTo(formatdiv)\n                .on(\"click\", function() {\n                    var jq = $(this);\n                    var jqp = jq.closest(\".unit\");\n                    jqp.find(\".tree\").not(\".cdTreeReply\").last().addClass(\"treelast\");\n                    jqp.find(\".blockreply\").addClass(\"hide\");\n                    jqp.find(\"textarea\").val(\"\");\n                    return false;\n                })\n                .attr(\"_desc\", Main.k.text.gettext(\"Fermer la zone de texte.\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            // Add formatting link (manager)\n            $(\"<span>&nbsp;</span>\").appendTo(formatdiv);\n            $(\"<a>\").addClass(\"butmini formatbtn\").html(\"<img src='/build/img/icons/ui/pam.png' /> Formater\").attr(\"href\", \"#\").appendTo(formatdiv)\n                .on(\"click\", function() {\n                    var tgt = $(this);\n                    if (tgt.hasClass(\"butmini\")) tgt = tgt.parent().parent().find(\"textarea\");\n\n                    Main.k.Manager.openOn(\"reply\", tgt.val(), tgt.closest(\".unit\").attr(\"data-k\"));\n                    return false;\n                })\n                .attr(\"_desc\", Main.k.text.gettext(\"Ouvrir le manager.\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n        }\n    };\n    Main.k.extend.onChatScroll = function() {\n        var jq = $(this);\n        var curChan = Main.curChatIndex();\n        Main.curScroll.set(curChan,jq.scrollTop());\n        if(curChan == ChatType.Wall[1]) {\n            if(jq.scrollTop() + jq.height() + 8 >= jq.toArray()[0].scrollHeight) Main.k.extend.loadMoreWall();\n        }\n    };\n    Main.loadMoreWall = function(){\n\n    };\n    addFctToPage(Main.loadMoreWall,'Main.loadMoreWall');\n    Main.k.extend.loadMoreWall = function(){\n        if(Main.lmwProcessing) return;\n        Main.lmwProcessing = true;\n        Main.lmw_spin++;\n        var chan = Main.getChannel(Main.curChatIndex()).find(\"div.wall div.unit\");\n        var w = chan.last();\n        var wp = w.closest(\".wall\");\n        if(w.length > 0) {\n            JqEx.postLoading(wp);\n            var url = \"/retrWallAfter/\" + Std.string(w.data(\"k\"));\n            Tools.ping(url,function(content) {\n                var jq = new js.JQuery(content);\n                JqEx.remLoading(wp);\n                var subWall = Lambda.list(jq.find(\".wall form\"));\n                var $it0 = subWall.iterator();\n                while( $it0.hasNext() ) {\n                    var e = $it0.next();\n                    var u = e.find(\".unit\");\n                    if(u == null) continue;\n                    var $it1 = (function($this) {\n                        var $r;\n                        var _this = wp.find(\".unit\");\n                        $r = (_this.iterator)();\n                        return $r;\n                    }(this));\n                    while( $it1.hasNext() ) {\n                        var we = $it1.next();\n                        var uk = u.data(\"k\");\n                        var wk = we.data(\"k\");\n                        haxe.Log.trace(uk + \" <>  \" + wk,{ fileName : \"Main.hx\", lineNumber : 3841, className : \"Main\", methodName : \"loadMoreWall\"});\n                        if(wk == uk) subWall.remove(e);\n                    }\n                }\n                var $it2 = subWall.iterator();\n                while( $it2.hasNext() ) {\n                    var w1 = $it2.next();\n                    wp.append(w1.html());\n                }\n                Main.lmwProcessing = false;\n\n                /**************** CTRL+W *************/\n                if (Main.k.Options.cbubbles) Main.k.customBubbles();\n                // Never hide unread msg\n                $(\"table.treereply tr.not_read.cdRepl\").css(\"display\", \"table-row\");\n                /**************** CTRL+W *************/\n\n            });\n        } else Main.lmwProcessing = false;\n\n    };\n\n    Main.k.extend.resetJs = Main.resetJs;\n    Main.resetJs = function(doActions, skipK) {\n        Main.k.extend.resetJs(doActions);\n        if (!skipK) Main.k.MushUpdate();\n    };\n    exportFunction(Main.resetJs, unsafeWindow.Main, {defineAs: 'resetJs'});\n\n    // == /Extend Main ============================================\n\n\n\n\n    // ============================================================\n    // == User Script  ============================================\n    // ============================================================\n    Main.k.UpdateData = {currversion: 0, changelog: []};\n    Main.k.UpdateCheck = function() {\n        var version_update;\n        if(Main.k.UpdateCheck.b_in_progress == undefined){\n            Main.k.UpdateCheck.b_in_progress = false;\n        }\n        if(Main.k.UpdateCheck.b_in_progress == true){\n            return;\n        }\n        var lastVersion = js.Cookie.get('ctrlwVersion');\n        if(typeof(lastVersion) != 'undefined' && lastVersion < Main.k.version){\n            version_update = lastVersion;\n        }else{\n            version_update = Main.k.version;\n        }\n        if(localStorage.getItem('ctrlw_update_cache') == null){\n            Main.k.UpdateCheck.b_in_progress = true;\n            GM_xmlhttpRequest({\n                method: 'GET',\n                url :Main.k.servurl + \"/versions/update/\"+ version_update,\n                headers: {\n                    \"Content-Type\": \"application/x-www-form-urlencoded\"\n                },\n                onload: function(json) {\n                    setTimeout(function() {\n                        console.warn('update_json',json);\n                        localStorage.setItem('ctrlw_update_cache',JSON.stringify(json));\n                        Main.k.UpdateCheck.b_in_progress = false;\n                    }, 0);\n\n\n                    Main.k.UpdateCheckScriptVersion(json,lastVersion);\n                },\n                onerror: function(xhr,statut,http){\n                    console.warn(xhr,statut,http);\n                }\n            });\n\n        }else{\n            Main.k.UpdateCheckScriptVersion(JSON.parse(localStorage.getItem('ctrlw_update_cache')),lastVersion);\n        }\n\n    };\n    /**\n     *\n     * @param {object} json infos about current version\n     * @param {string} json.numero Version number\n     * @param {string} json.changelog_long Changelog\n     * @param {string} json.user_num_version Version number of the installed script\n     * @param {int} json.user_code_version Version code of the installed script\n     * @param lastVersion\n     */\n    Main.k.UpdateCheckScriptVersion = function(json,lastVersion){\n        try {\n            json = JSON.parse(json.response);\n        } catch (e) {\n            return false;\n        }\n        Main.k.UpdateData.currversion = json.numero;\n        if(typeof(json['changelog_long_'+Main.k.lang]) != 'undefined'){\n            Main.k.UpdateData.changelog = json['changelog_long_'+Main.k.lang];\n        }else{\n            Main.k.UpdateData.changelog = json.changelog_long;\n        }\n        Main.k.UpdateData.url = json.url;\n        if (json.user_code_version < json.code && json.user_num_version == GM_info.script.version) {\n            $(\"#updatebtn\").css(\"display\", \"block\");\n        } else {\n            if(typeof(lastVersion) != 'undefined' && lastVersion != GM_info.script.version){\n                Main.k.AutoUpdateDialog();\n            }\n            js.Cookie.set('ctrlwVersion',GM_info.script.version,420000000);\n            $(\"#updatebtn\").css(\"display\", \"none\");\n        }\n    };\n    Main.k.UpdateDialog = function() {\n        var okHref = Main.k.UpdateData.url;\n        // Create popup\n        var popup = Main.k.CreatePopup();\n        popup.content.css({\n            \"height\": \"auto\",\n            \"max-height\": \"90%\",\n            \"width\": \"600px\",\n            \"color\": \"#FFF\"\n        });\n\n        //conf.title = \"Mise à jour du script CTRL+W\";\n        var maj_content = Main.k.text.gettext(\"Version \" + Main.k.UpdateData.currversion + \" disponible :\")+\" <br/> <ul class='updateslist'>\";\n        for (var i=0; i<Main.k.UpdateData.changelog.length; i++) {\n            var log = Main.k.UpdateData.changelog[i];\n            maj_content += \"<li>\"+log+\"</li>\";\n        }\n        maj_content += \"</ul>\";\n\n        // Fill popup content\n        var content = \"<div class='updatescontent'>\" + maj_content + \"</div>\";\n        var ok = \"<div class='updatesactions'><div id=\\\"ok\\\" class=\\\"but updatesbtn\\\" ><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a onclick=\\\"$('#final').show();\\\" href=\\\"\"+okHref+\"\\\">\"+Main.k.text.gettext(\"Mettre à jour\")+\"</a></div></div></div>\";\n        var cancelAc = \"'Main.k.ClosePopup();'\";\n        var cancel = \"<div id=\\\"cancel\\\" class=\\\"but updatesbtn\\\" onclick=\" + cancelAc + \"><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a href=\\\"#\\\">\" + Main.getText(\"cancel\") + \"</a></div></div></div></div>\";\n        var finalisation = '<div id=\"final\" class=\"updatesactions\" style=\"display:none\"><div><strong>'+Main.k.text.gettext(\"Pour finaliser la mise à jour, après avoir installé le script, veuillez cliquer sur le bouton ci-dessous.\")+'</strong></div><div class=\"but updatesbtn\" onclick=\"Main.k.ClosePopup();window.location.reload();\"><div class=\"butright\"><div class=\"butbg\"><a href=\"#\">'+Main.k.text.gettext(\"Finaliser la mise à jour\")+'</a></div></div></div></div></div>';\n        $(\"<div>\").html(content + ok + cancel + finalisation).appendTo(popup.content);\n\n        // Display popup\n        Main.k.OpenPopup(popup.dom);\n    };\n    Main.k.AutoUpdateDialog = function() {\n        // Create popup\n        var popup = Main.k.CreatePopup();\n        popup.content.css({\n            \"height\": \"auto\",\n            \"max-height\": \"90%\",\n            \"width\": \"600px\",\n            \"color\": \"#FFF\"\n        });\n\n        //conf.title = \"Mise à jour du script CTRL+W\";\n        var maj_content = Main.k.text.strargs(Main.k.text.gettext(\"Dernière version de CTRL+W installée (%1) :\"), [GM_info.script.version]);\n        maj_content += \" <br/> <ul class='updateslist'>\";\n        for (var i=0; i<Main.k.UpdateData.changelog.length; i++) {\n            var log = Main.k.UpdateData.changelog[i];\n            maj_content += \"<li>\"+log+\"</li>\";\n        }\n        maj_content += \"</ul>\";\n\n        // Fill popup content\n        var content = \"<div class='updatescontent'>\" + maj_content + \"</div>\";\n        var ok = \"<div class='updatesactions'><div id=\\\"ok\\\" class=\\\"but updatesbtn\\\" ><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a onclick=\\\"Main.k.ClosePopup();\\\" href=\\\"#\\\">\"+Main.k.text.gettext(\"Très bien, merci !\")+\"</a></div></div></div>\";\n        $(\"<div>\").html(content + ok).appendTo(popup.content);\n\n        // Display popup\n        Main.k.OpenPopup(popup.dom);\n    };\n    Main.k.COMPLETE_SURNAME = function(n) { return n.replace(\"_\", \" \").capitalize(); };\n    Main.k.LoadJS = function(url, params, after) {\n        var s = js.Lib.document.createElement(\"script\");\n        s.async = true;\n        var p = Reflect.copy(params);\n        p.jsm = \"1\";\n        p.lang = \"FR\";\n        s.src = _tid.makeUrl(url,cloneInto(p,unsafeWindow));\n        if (after != null) s.onload = after;\n        js.Lib.document.body.appendChild(s);\n    };\n    Main.k.postMessage = function(k, msg, after) {\n        // Save msg\n        var stVal = StringTools.urlEncode(msg);\n        js.Cookie.set(\"lastsentmsg\", stVal);\n        Main.k.displayLastSent(true);\n\n        var sendChatProc = function() {\n            Main.resetJs();\n\n            // Message sent\n            Main.k.displayLastSent(false);\n            if (after) after();\n        };\n\n        var updtArr = [\"cdTabsChat\",\"chatBlock\",\"char_col\"];\n        var url = \"/wallReply?k=\" + k + \"&msg=\" + stVal;\n        Main.updateContent(url,updtArr,null,sendChatProc);\n    };\n    Main.k.newTopic = function(msg, after) {\n        // Save msg\n        var stVal = StringTools.urlEncode(msg);\n        js.Cookie.set(\"lastsentmsg\", stVal);\n        Main.k.displayLastSent(true);\n\n        var sendChatProc = function() {\n            Main.resetJs();\n\n            // Message sent\n            Main.k.displayLastSent(false);\n            if (after) after();\n        };\n\n        var updtArr = [\"cdTabsChat\",\"chatBlock\",\"char_col\"];\n        var url = \"/newWallThread?message=\" + stVal;\n        Main.updateContent(url,updtArr,null,sendChatProc);\n    };\n    Main.k.displayLastSent = function(show) {\n        var btn = $(\"#lastsentmsg\");\n        if (show) {\n            btn.css(\"display\", \"block\");\n            var cook = js.Cookie.get(\"lastsentmsg\");\n        } else {\n            btn.css(\"display\", \"none\");\n            js.Cookie.set(\"lastsentmsg\", \"\");\n        }\n    };\n    /**\n     * @return string\n     */\n    Main.k.FormatInventory = function() {\n        // Room name\n        var inv = \"**\" + $(\"#input\").attr(\"d_name\") + \" :** \";\n\n        // Objects\n        var objects = $(\"#room\").clone();\n        objects.find(\".cdEmptySlot\").remove();\n        var first = true;\n        objects.find(\"li\").each(function(i) {\n            // Ignore hidden objects\n            if ($(this).attr(\"data-name\").indexOf(\"/img/icons/ui/hidden.png\") != -1) return;\n            var name = $(this).attr(\"data-name\");\n\n            // Ignore personal objects\n            var perso = [\"itrakie\",\"itrackie\", \"talkie\", \"walkie\", \"traqueur\", \"tracker\"]; // TODO: add other translations (itrackie exists or it's a mistake ?)\n            for (var a = 0 ; a < perso.length ; a++) if (name.toLowerCase().indexOf(perso[a].toLowerCase()) != -1) return;\n\n            // Handle broken objects\n            var broken = (name.indexOf(\"/img/icons/ui/broken.png\") > -1);\n\n            // Remove img from desc\n            name = name.replace(/(<img.+\\/>)/ig, \"\").trim();\n\n            // Handle mage books\n            if (name.toLowerCase() == Main.k.text.gettext(\"apprentron\")) {\n                name = decodeURIComponent(/namey[0-9]+:(.+)g$/.exec($(this).attr(\"data-tip\"))[1]).replace(/(\\s\\s)/, \" \");\n            }\n\n            // Handle quantity\n            var qty = \"\";\n            if ($(this).find(\".qty\").get(0)) {\n                qty = \" x\" + $(this).find(\".qty\").html().trim();\n            }\n\n            // Handle loads\n            var reg = /x([0-9]+)$/;\n            if (reg.test(name)) name += \" \" + Main.k.text.gettext(\"charges\");\n\n            if (!first) inv += \", \";\n            inv += \"//\" + name + \"//\" + qty;\n            if (broken) inv += \" :alert:\";\n            first = false;\n        });\n        if (first) inv += \"//\" + Main.k.text.gettext(\"vide\") + \"//\";\n\n        // Camera / Drone\n        var ncamera = 0;\n        var ndrones = 0;\n        var $it = Main.items.iterator();\n        while( $it.hasNext() ) {\n            /** @type {{iid:string}} **/\n            var item = $it.next();\n            if (item.iid == \"CAMERA\") ncamera++;\n            else if (item.iid == \"HELP_DRONE\") ndrones++;\n        }\n        if (ncamera || ndrones) inv += \" [\";\n        if (ncamera) inv += ncamera + \" \" + Main.k.text.gettext(\"caméra\") + (ncamera != 1 ? \"s\" : \"\");\n        if (ncamera && ndrones) inv += \" - \";\n        if (ndrones) inv += ndrones + \" \" + Main.k.text.gettext(\"drone\") + (ndrones != 1 ? \"s\" : \"\");\n        if (ncamera || ndrones) inv += \"]\";\n\n        return inv;\n    };\n    /**\n     * @return string\n     */\n    Main.k.FormatPlants = function() {\n        var ret = \"**//\" + Main.k.text.gettext(\"plantes\").capitalize() + \" : //**\";\n\n        $(\"#room\").find(\"[data-id='TREE_POT']\").each(function(i) {\n            var name = /^([^<]+)/.exec($(this).attr(\"data-name\"))[1].trim();\n            var diseased = ($(this).attr(\"data-name\").indexOf(\"plant_diseased\") != -1);\n            var thirsty = ($(this).attr(\"data-name\").indexOf(\"plant_thirsty\") != -1);\n            var dry = ($(this).attr(\"data-name\").indexOf(\"plant_dry\") != -1);\n            var adult = true; // TODO\n\n            ret += \"\\n- ////**\" + name + \"** \";\n            //ret += adult ? \"(mature)\" : \"(X cycles)\";\n            ret += \" - \";\n\n            var problems = [];\n            if (diseased) problems.push(\"//\" + Main.k.text.gettext(\"malade\").capitalize() + \"//\");\n            if (thirsty) problems.push(\"//\" + Main.k.text.gettext(\"soif\").capitalize() + \"//\");\n            if (dry) problems.push(\"//\" + Main.k.text.gettext(\"desséché\").capitalize() + \"//\");\n            if(problems.length == 0) problems.push(\"//\" + Main.k.text.gettext(\"RAS\").capitalize() + \"//\");\n\n            ret += problems.join();\n\n        });\n\n        return ret;\n    };\n    /**\n     * @return string\n     */\n    Main.k.FormatProjects = function() {//TODO: MULTILANG\n        var ret = \"**//\" + Main.k.text.gettext(\"Projets\") + \" : //**\";\n\n        var parse = function(t) {\n            t = t.replace(/<img\\s+src=\\\"\\/img\\/icons\\/ui\\/pa_slot1.png\\\"[\\/\\s]*>/ig, \":pa:\");\n            t = t.replace(/&nbsp;/ig, \" \");\n            t = t.replace(/\\n/ig, \"\");\n            t = t.replace(/<p>/ig, \" \");\n            t = t.replace(/<\\/?[^>]+>/g, \"\");\n            return t;\n        };\n\n        $(\"#cdModuleContent\").find(\"ul.dev li.cdProjCard\").each(function(i) {\n            var name = $(this).find(\"h3\").html().trim();\n            var pct = $(this).find(\"span\").html().trim();\n            var desc = parse($(this).find(\"div.desc\").html().trim());\n            var bonus1 = /<h1>([^<]+)<\\/h1>/.exec($(this).find(\"div.suggestprogress ul li img\").first().attr(\"onmouseover\"))[1].trim();\n            var bonus2 = /<h1>([^<]+)<\\/h1>/.exec($(this).find(\"div.suggestprogress ul li img\").last().attr(\"onmouseover\"))[1].trim();\n\n            ret += \"\\n**\" + name + \"** - \" + pct + \"\\n\";\n            ret += \"\" + desc + \"\\n\";\n            ret += \"Bonus : //\" + bonus1 + \"//, //\" + bonus2 + \"//\";\n        });\n\n        return ret;\n    };\n    /**\n     * @return string;\n     */\n    Main.k.FormatResearch = function(short) {\n        var ret = \"**//\"+Main.k.text.gettext(\"Recherches\")+\" : //**\";\n\n        var parse = function(t) {\n            t = t.replace(/<img\\s+src=\\\"\\/img\\/icons\\/ui\\/triumph.png\\\"\\s+alt=\\\"triomphe\\\"[\\/\\s]*>/ig, \":mush_triumph:\");\n            t = t.replace(/&nbsp;/ig, \" \");\n            t = t.replace(/\\n/ig, \"\");\n            t = t.replace(/<p>/ig, \" \");\n            t = t.replace(/<\\/?[^>]+>/g, \"\");\n            return t;\n        };\n\n        $(\"#cdModuleContent\").find(\"ul.dev li.cdProjCard\").each(function(i) {\n            var h3 = $(this).find(\"h3\").clone();\n            h3.find(\"em\").remove();\n            var name = parse(h3.html().trim());\n            var pct = $(this).find(\"span\").html().trim();\n            var desc = parse($(this).find(\"div.desc\").html().trim());\n            var bonus1 = /<strong>([^<]+)<\\/strong>/.exec($(this).find(\"div.suggestprogress ul li img\").first().attr(\"onmouseover\"))[1].trim().replace(\"Médeçin\", \"Médecin\");\n            var bonus2 = /<strong>([^<]+)<\\/strong>/.exec($(this).find(\"div.suggestprogress ul li img\").last().attr(\"onmouseover\"))[1].trim().replace(\"Médeçin\", \"Médecin\");\n            ret += \"\\n**\" + name + \"** - \" + pct;\n            if(typeof(short) == 'undefined' ||  short != true ) {\n                ret += \"\\n\" + desc + \"\\n\";\n                ret += \"Bonus : //\" + bonus1 + \"//, //\" + bonus2 + \"//\";\n            }\n        });\n\n        return ret;\n    };\n    /**\n     * @return string;\n     */\n    Main.k.FormatPlanets = function(index) {//TODO: MULTILANG\n        var ret = \"**//\"+Main.k.text.gettext(\"Planètes\")+\" : //**\";\n\n        var parse = function(t) {\n            t = t.replace(/<img\\s+src=\\\"\\/img\\/icons\\/ui\\/triumph.png\\\"\\s+alt=\\\"triomphe\\\"[\\/\\s]*>/ig, \":mush_triumph:\");\n            t = t.replace(/&nbsp;/ig, \" \");\n            t = t.replace(/\\n/ig, \"\");\n            t = t.replace(/<p>/ig, \" \");\n            t = t.replace(/<\\/?[^>]+>/g, \"\");\n            return t;\n        };\n\n        $(\"#navModule\").find(\".planet\").not(\".planetoff\").each(function(i) {\n            if(index != null && i != index){\n                return true;\n            }\n            // Name + Planet img\n            var name = $(this).find(\"h3\").html().trim();\n            var img = $(this).find(\"img.previmg\").attr(\"src\");\n\n            // Distance & fuel\n            var dir, dist;\n            var pllist = $(this).find(\"ul.pllist li\");\n            if (pllist.length > 0) {\n                var regex = new RegExp(Main.k.text.gettext('(Nord|Est|Ouest|Sud)'));\n                dir = regex.exec(pllist.eq(-2).html())[1];\n                dist = /([0-9]+)/.exec(pllist.last().html())[1];\n            }\n\n            // Cases\n            var nbcases = $(this).find(\"td img.explTag\").length;\n            var cases = [];\n            var casenamereg = /<h1>([^<]+)<\\/h1>/;\n            $(this).find(\"td img.explTag.on\").each(function() {\n                cases.push(casenamereg.exec($(this).attr(\"onmouseover\"))[1]);\n            });\n\n            // Print planet\n            ret += \"\\n**\" + name + \"** (\" + nbcases + ' ' + Main.k.text.gettext('cases') + \")\\n\";\n            if (dist && dir) ret += \"//\" + dir + \" - \" + dist + \" :mush_fuel:****//\\n\";\n            ret += cases.join(\", \");\n        });\n\n        return ret;\n    };\n    /**\n     * @return string;\n     */\n    Main.k.FormatBIOS = function() {//TODO: MULTILANG\n        var ret = \"//**\" + Main.k.text.gettext('Paramètres BIOS:') + \"**//\";\n\n        $('#biosModule').find('ul.dev li').each(function() {\n            var biosParam = $(this);\n            ret += \"\\n**\" + $(this).children(\"h3:first\").text().trim() + \"** : \";\n            ret += $(this).find(\"input[checked='checked']\").siblings(\"label\").text();\n        });\n\n        return ret;\n    };\n    /**\n     * @return string;\n     */\n    Main.k.FormatComm = function(){\n        var comm = \"//**\" + Main.k.text.gettext('Communications:') + \"**//\";\n\n        var parse = function(t) {\n            t = t.replace(/<img\\s+src=\\\"\\/img\\/icons\\/ui\\/triumph.png\\\"\\s+alt=\\\"triomphe\\\"[\\/\\s]*>/ig, \":mush_triumph:\");\n            t = t.replace(/&nbsp;/ig, \" \");\n            t = t.replace(/\\n/ig, \"\");\n            t = t.replace(/<p>/ig, \" \");\n            t = t.replace(/<\\/?[^>]+>/g, \"\");\n            return t;\n        };\n        var $trackerModule = $('#trackerModule');\n        $trackerModule.find('.sensors').each(function() {\n\n            var bdd = $(this).find(\"h2\").html().trim();\n            comm += \"\\n//\" + bdd + \"//: \";\n            var data = [];\n            $(this).find(\"p\").each(function() {\n                data.push($(this).find(\"em\").html());\n            });\n\n            if (data.length < 2){\n                data.push(' :alert:');\n            }else{\n                data.pop();\n                data.push(' :com:');\n            }\n            comm += data.join(\"\");\n        });\n\n        $trackerModule.find('.neron').each(function() {\n\n            var version = $(this).find(\"h2\").html().trim();\n            comm += \"\\n//\" + version + \"//\\n\";\n\n        });\n        $trackerModule.find('.xyloph').each(function() {\n\n            var bdd = $(this).find(\"h2\").html().trim();\n            var nbr = 0;\n            var data = [];\n            var datanamereg = /<h1>([^<]+)<\\/h1>/;\n            $(this).find(\"li\").not(\".undone\").each(function() {\n                nbr += 1;\n                data.push(datanamereg.exec($(this).attr(\"onmouseover\"))[1].replace('\\\\',''));\n            });\n\n            if (nbr == 12){\n                comm += \"//\" + bdd + \"//: \";\n                comm += nbr + \"/12\\n\";\n            }\n            else{\n                if (nbr >0){\n                    comm += \"//\" + bdd + \"//: \";\n                    comm += nbr + \"/12\"+\"\\n ▶ **\"+ data.join(\"** \\n ▶ **\")+\"**\\n\";\n                }\n            }\n\n\n\n        });\n\n        $trackerModule.find('.network .bases').each(function() {\n\n            var base = \"//\" + Main.k.text.gettext('Décodage: ') + \"//\";\n            var base_decode;\n            $(this).find(\"li\").each(function(){\n\n                base_decode = $(this).attr(\"data-id\");\n                $(this).find(\".percent\").not(\".off\").each(function(){\n                    base += base_decode+ \"► \" + $(this).html().trim();\n                });\n            });\n\n            if (base != \"//\" + Main.k.text.gettext('Décodage: ') + \"//\"){\n                comm += base +\"\\n\";\n            }\n\n            var base_fini = \"//\" + Main.k.text.gettext('Base(s) décodée(s): ') + \"//\";\n            var _base =\"\";\n            var base_signal_perdu = \"//\" + Main.k.text.gettext('Base(s) perdue(s): ') + \"//\";\n            var base_nom = \"\";\n            var nbr_base_perdu = 0;\n\n            $(this).find(\"li\").each(function(){\n\n                base_nom = $(this).attr(\"data-id\");\n                $(this).find(\"h3\").each(function(){\n                    if (($(this).html().trim()) != \"???\" && ($(this).html().trim()) != \"\"){\n\n                        base_fini += $(this).html().trim() +\", \";\n                    }\n                });\n\n                $(this).find(\"span\").not(\".percent\").each(function(){\n\n                    base_signal_perdu += base_nom +\", \";\n                });\n            });\n\n            if (base_fini != \"//\" + Main.k.text.gettext('Base(s) décodée(s): ') + \"//\"){\n                comm += base_fini;\n                comm = comm.substring(0,comm.length-2)+\"\\n\";\n            }\n            if (base_signal_perdu != \"//\" + Main.k.text.gettext('Base(s) perdue(s): ') + \"//\"){\n                comm += base_signal_perdu.substring(0,base_signal_perdu.length-2);\n            }\n\n\n        });\n        return comm;\n    };\n    /**\n     * @return string;\n     */\n    Main.k.FormatPharma = function() {\n        var ret = \"**//\" + Main.k.text.gettext(\"Consommables :\") + \" //**\";\n\n        var o_replace = {};\n        /* Translators: This translation must be copied from the game. (Consummables description) */\n        o_replace[Main.k.text.gettext(\"Guérie la maladie\")] = ':pa_heal:';\n        /* Translators: This translation must be copied from the game. (Consummables description) */\n        o_replace[Main.k.text.gettext(\"satiété\")] = ':pa_cook:';\n        /* Translators: This translation must be copied from the game. (Consummables description) */\n        o_replace[Main.k.text.gettext(\"Provoque la maladie\")] = ':ill:';\n\n        var a_ignore = [];\n        /* Translators: This translation must be copied from the game. (Consummables description) */\n        a_ignore.push(Main.k.text.gettext(\"Impérissable\"));\n        var regex_ignore = new RegExp('^('+a_ignore.join('|')+'$)');\n\n        var $room = $(\"#room\");\n        $room.find(\"li\").not(\".cdEmptySlot\").each(function() {\n            var name = $(this).attr(\"data-name\").capitalize();\n            var desc = $(this).attr(\"data-desc\").split(\"\\\\'\").join(\"'\");\n\n            if (desc.indexOf(\"Effets\") != -1 || $(this).data('id') == \"CONSUMABLE\") {\n                var $desc = $('<div>'+desc+'</div>');\n                if($desc.has('p')){\n\n                    var a_ret_effect = [];\n                    $desc.find('p').each(function(){\n                        if(!regex_ignore.test($(this).html())){\n                            a_ret_effect.push($(this).html().replaceFromObj(o_replace));\n                        }\n                    });\n                    if(a_ret_effect.length > 0){\n                        ret += \"\\n**\" + name + \"** : \";\n                        ret += a_ret_effect.join(', ');\n                    }\n\n\n                }\n\n\n            }\n        });\n\n        ret = ret.replace(/<\\/p>/g, \", \");\n        ret = ret.replace(/(\\t|\\\\r\\\\n|\\\\|<\\/?(p|div)>)/g, \"\");\n        ret = ret.replace(/,\\s<br\\/>/g, \"\\n\");\n        ret = ret.replace(/<img[^>]+pa_slot1[^>]+>/g, \":pa:\");\n        ret = ret.replace(/<img[^>]+pa_slot2[^>]+>/g, \":pm:\");\n        ret = ret.replace(/<img[^>]+moral[^>]+>/g, \":moral:\");\n        ret = ret.replace(/<img[^>]+lp\\.png[^>]+>/g, \":hp:\");\n        ret = ret.replace(/<img[^>]+>/g, \"\");\n\n        return ret;\n    };\n    /**\n     * @return string;\n     */\n    Main.k.FormatLife = function() {//TODO: MULTILANG\n        var pv = $(\"table.pvsm td\").not(\".barmoral\").find(\"span\").html().trim();\n        var moral = $(\"table.pvsm td.barmoral span\").html().trim();\n        return pv + \" :mush_hp: / \" + moral + \" :mush_moral:\";\n    };\n    /**\n     * @return string;\n     */\n    Main.k.Resize = function() {\n        var leftbar = $(\".usLeftbar\");\n        var content = $(\"#content\");\n        var $body = $(\"body\");\n        var bw = $body.width();\n        var lbw = 126; //leftbar.width();\n        var w = Math.min(Main.k.BMAXWIDTH, bw - lbw - 30);\n        content.css(\"width\", w);\n\n        if ($(Main.k.window).width() > (w + (lbw + 15)*2)) {\n            content.css(\"left\", (bw - w) / 2 + \"px\");\n\n            // Fix background position\n            if (Main.k.Options.dlogo) $body.css(\"background-position\", \"-\" + ((1830-bw)/2) + \"px 20px\");\n        } else {\n            content.css(\"left\", lbw + 15 + \"px\");\n\n            // Fix background position\n            if (Main.k.Options.dlogo) $body.css(\"background-position\", \"-272px 20px\");\n        }\n\n        var content_height = content.height() + content.position().top;\n        if (leftbar.height() < content_height) {\n            leftbar.css(\"height\", content_height-11);\n        } else {\n            content.css(\"height\", leftbar.height() - content.position().top + 11);\n        }\n    };\n    Main.k.ToggleDisplay = function() {\n        if (this.className == \"displaymore\") {\n            this.className = \"displayless\";\n            $(\"\" + $(this).attr(\"_target\")).css(\"display\", \"block\");\n        } else {\n            this.className = \"displaymore\";\n            $(\"\" + $(this).attr(\"_target\")).css(\"display\", \"none\");\n        }\n        Main.k.Resize();\n    };\n    Main.k.ExtendPilgred = function() {\n        var $cdBottomBlock = $(\"#cdBottomBlock\");\n        $(\"#pilgredbonus\").remove();\n        var pilgred = $cdBottomBlock.find(\"div.pilgred\").parent().css({\n            position: \"relative\",\n            \"margin-right\": \"160px\"\n        });\n\n        // Double research points\n        var research = $cdBottomBlock.find(\"div.research\");\n        var researchtriumph = 0;\n        research.each(function() {\n            var name = $(this).parent().find(\"img\").attr(\"src\").replace(\"/img/cards/research/\", \"\").replace(\".png\", \"\");\n            if(Main.k.researchGlory[name]) researchtriumph += Main.k.researchGlory[name];\n        });\n\n        // -10 / mush alive\n        var nmush = $(\"ul.people img[src='/img/icons/ui/p_mush.png']\").length;\n        var mushtriumph = -10 * nmush;\n\n        // Print result\n        var res = \"<h4>\"+ Main.k.text.gettext(\"Triomphe retour sur sol\") + \"</h4>\" +\n            \"- \" + Main.k.text.gettext(\"Retour sur Sol :\") + \" 20 <br/>\" +\n            \"- \" + Main.k.text.gettext(\"Bonus recherches : \") + researchtriumph + \"<br/>\" +\n            \"- \" + Main.k.text.gettext(\"Malus mush en vie : \") + mushtriumph + \"<br/>\" +\n            Main.k.text.gettext(\"Total :\") + \" \" + (20 + researchtriumph + mushtriumph);\n        $(\"<div>\")\n            .attr(\"id\", \"pilgredbonus\")\n            .attr('_title',Main.k.text.gettext(\"Triomphe retour sur sol\"))\n            .attr('_desc',Main.k.text.gettext(\"Ne tient pas compte des mushs anonymes.\"))\n            .css({\n                position: \"absolute\",\n                top: \"3px\",\n                left: \"54px\",\n                width: \"150px\",\n                \"font-size\": \"11px\"\n            })\n            .html(res)\n            .appendTo(pilgred)\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip);\n    };\n    Main.k.maxAgo = function(a,b) {//TODO: MULTILANG\n        var min_a, min_b;\n\n        // TODO: factorize code\n\n        // undefined\n        if (!a) return b;\n        if (!b) return a;\n\n        // <1min\n        if (a == \"&lt;1m\") return b;\n        if (b == \"&lt;1m\") return a;\n\n        // Minutes\n        var reg_min = /([0-9]+)min/;\n        if (reg_min.test(a)) {\n            if (!reg_min.test(b)) return b;\n\n            min_a = parseInt(reg_min.exec(a)[1]);\n            min_b = parseInt(reg_min.exec(b)[1]);\n            if (min_a <= min_b) return b;\n            return a;\n        } else if (reg_min.test(b)) {\n            if (!reg_min.test(a)) return a;\n\n            min_a = parseInt(reg_min.exec(a)[1]);\n            min_b = parseInt(reg_min.exec(b)[1]);\n            if (min_a <= min_b) return b;\n            return a;\n        }\n\n        // Hours\n        var reg_hours = /\\~([0-9]+)h/;\n        if (reg_hours.test(a)) {\n            if (!reg_hours.test(b)) return b;\n\n            min_a = parseInt(reg_hours.exec(a)[1]);\n            min_b = parseInt(reg_hours.exec(b)[1]);\n            if (min_a <= min_b) return b;\n            return a;\n        } else if (reg_hours.test(b)) {\n            if (!reg_hours.test(a)) return a;\n\n            min_a = parseInt(reg_hours.exec(a)[1]);\n            min_b = parseInt(reg_hours.exec(b)[1]);\n            if (min_a <= min_b) return b;\n            return a;\n        }\n\n        // Days\n        var reg_days = /\\~([0-9]+)j/;\n        if (reg_days.test(a)) {\n            if (!reg_days.test(b)) return b;\n\n            min_a = parseInt(reg_days.exec(a)[1]);\n            min_b = parseInt(reg_days.exec(b)[1]);\n            if (min_a <= min_b) return b;\n            return a;\n        } else if (reg_days.test(b)) {\n            if (!reg_days.test(a)) return a;\n\n            min_a = parseInt(reg_days.exec(a)[1]);\n            min_b = parseInt(reg_days.exec(b)[1]);\n            if (min_a <= min_b) return b;\n            return a;\n        }\n\n        // ?\n        return a;\n    };\n    Main.k.minAgo = function(a,b) {//TODO: MULTILANG\n        var min_a, min_b;\n        // TODO: factorize code\n\n        // undefined\n        if (!a) return b;\n        if (!b) return a;\n\n        // <1min\n        if (a == \"&lt;1m\") return a;\n        if (b == \"&lt;1m\") return b;\n\n        // Minutes\n        var reg_min = /([0-9]+)min/;\n        if (reg_min.test(a)) {\n            if (!reg_min.test(b)) return a;\n\n            min_a = parseInt(reg_min.exec(a)[1]);\n            min_b = parseInt(reg_min.exec(b)[1]);\n            if (min_a <= min_b) return a;\n            return b;\n        } else if (reg_min.test(b)) {\n            if (!reg_min.test(a)) return b;\n\n            min_a = parseInt(reg_min.exec(a)[1]);\n            min_b = parseInt(reg_min.exec(b)[1]);\n            if (min_a <= min_b) return a;\n            return b;\n        }\n\n        // Hours\n        var reg_hours = /\\~([0-9]+)h/;\n        if (reg_hours.test(a)) {\n            if (!reg_hours.test(b)) return a;\n\n            min_a = parseInt(reg_hours.exec(a)[1]);\n            min_b = parseInt(reg_hours.exec(b)[1]);\n            if (min_a <= min_b) return a;\n            return b;\n        } else if (reg_hours.test(b)) {\n            if (!reg_hours.test(a)) return b;\n\n            min_a = parseInt(reg_hours.exec(a)[1]);\n            min_b = parseInt(reg_hours.exec(b)[1]);\n            if (min_a <= min_b) return a;\n            return b;\n        }\n\n        // Days\n        var reg_days = /\\~([0-9]+)j/;\n        if (reg_days.test(a)) {\n            if (!reg_days.test(b)) return a;\n\n            min_a = parseInt(reg_days.exec(a)[1]);\n            min_b = parseInt(reg_days.exec(b)[1]);\n            if (min_a <= min_b) return a;\n            return b;\n        } else if (reg_days.test(b)) {\n            if (!reg_days.test(a)) return b;\n\n            min_a = parseInt(reg_days.exec(a)[1]);\n            min_b = parseInt(reg_days.exec(b)[1]);\n            if (min_a <= min_b) return a;\n            return b;\n        }\n\n        // ?\n        return a;\n    };\n    Main.k.extendAgo = function(ago) {//TODO: MULTILANG\n        var one = (parseInt(/([0-9]+)/.exec(ago)[1]) == 1);\n\n        ago = ago.replace(\"min\", \" minute\" + (one ? \"\" : \"s\"));\n        ago = ago.replace(\"h\", \" heure\" + (one ? \"\" : \"s\"));\n        ago = ago.replace(\"j\", \" jour\" + (one ? \"\" : \"s\"));\n        ago = ago.replace(\"&lt;1m\", \"moins d'une minute\");\n        ago = ago.replace(\"~\", \"environ \");\n        return ago;\n    };\n    Main.k.surnameToBubble = function(surname){\n        return surname.replace(/(\\s)/g, \"_\").toLowerCase();\n    };\n    Main.k.customBubbles = function() {\n        var bubbles = $(\".bubble\");\n        if (Main.k.Options.cbubbles) {\n            bubbles.each(function() {\n                var charname = Main.k.GetHeroNameFromTopic($(this).parent());\n                $(this).addClass(\"bubble_\" + charname);\n                if (Main.k.Options.cbubblesNB) $(this).addClass(\"custombubbles_nobackground\");\n            });\n        } else {\n            bubbles.removeClass(\"custombubbles_nobackground\");\n\n            for (var i=0; i<Main.k.HEROES.length; i++ ) {\n                bubbles.removeClass(\"bubble_\" + Main.k.HEROES[i]);\n            }\n        }\n    };\n    Main.k.updateBottom = function() {\n        var $cdBottomBlock = $(\"#cdBottomBlock\");\n        if ($cdBottomBlock.find(\"div.pilgred\").length > 0) Main.k.ExtendPilgred();\n        $cdBottomBlock.find(\"div.split\").remove();\n        if (Main.k.Options.splitpjt) {\n            if ($cdBottomBlock.find(\"div.project\").length > 0) $(\"<div>\").addClass(\"split\").insertAfter($cdBottomBlock.find(\"div.project\").last().parent());\n            if ($cdBottomBlock.find(\"div.research\").length > 0) $(\"<div>\").addClass(\"split\").insertAfter($cdBottomBlock.find(\"div.research\").last().parent());\n        }\n    };\n\n    // Game zone fold/unfold\n    Main.k.folding = {};\n    Main.k.folding.displayed = \"game\";\n    Main.k.folding.busy = false;\n    Main.k.folding.currcols = [\"#char_col\", \"#room_col\", \"#chat_col\"];\n    Main.k.folding.gamecols = [\"#char_col\", \"#room_col\", \"#chat_col\"];\n    Main.k.folding.display = function(cols, newdisplay, afterdisplay) {\n        if (Main.k.folding.busy) return;\n        Main.k.folding.busy = true;\n        Main.k.folding.displayed = newdisplay;\n\n        // Get cols to fold\n        var tofold = [null, null, null];\n        for (var i=0; i<Main.k.folding.currcols.length; i++) {\n            if (cols[i]) {\n                if (cols[i] != Main.k.folding.currcols[i]) tofold[i] = Main.k.folding.currcols[i];\n            } else if (Main.k.folding.currcols[i] != Main.k.folding.gamecols[i]) {\n                tofold[i] = Main.k.folding.currcols[i];\n            }\n        }\n\n        // Unfolding\n        var after = function() {\n            // Get cols to unfold\n            var tounfold = [null, null, null];\n            for (var i=0; i<Main.k.folding.currcols.length; i++) {\n                // If a new col is wanted here\n                if (cols[i]) {\n                    if (cols[i] != Main.k.folding.currcols[i]) tounfold[i] = cols[i];\n\n                    // Else display game col\n                } else if (Main.k.folding.currcols[i] != Main.k.folding.gamecols[i]) {\n                    tounfold[i] = Main.k.folding.gamecols[i];\n                }\n            }\n\n            // Unfold\n            Main.k.folding.unfold(tounfold, function() {\n                Main.k.folding.busy = false;\n                if (afterdisplay && typeof afterdisplay == 'function') afterdisplay();\n            });\n        };\n\n        // Fold previous cols, then unfold new cols\n        Main.k.folding.fold(tofold, after);\n    };\n    Main.k.folding.displayGame = function(afterdisplay) {\n        if (Main.k.folding.busy) return;\n        Main.k.folding.busy = true;\n        Main.k.folding.displayed = \"game\";\n\n        // Get cols to fold\n        var tofold = [null, null, null];\n        for (var i=0; i<Main.k.folding.currcols.length; i++) {\n            if (Main.k.folding.currcols[i] != Main.k.folding.gamecols[i]) tofold[i] = Main.k.folding.currcols[i];\n        }\n\n        // Unfolding\n        var after = function() {\n            // Get cols to unfold\n            var tounfold = [null, null, null];\n            for (var i=0; i<Main.k.folding.currcols.length; i++) {\n                // Display game col\n                if (Main.k.folding.currcols[i] != Main.k.folding.gamecols[i]) {\n                    tounfold[i] = Main.k.folding.gamecols[i];\n                }\n            }\n\n            // Unfold\n            Main.k.folding.unfold(tounfold, function() {\n                Main.k.folding.busy = false;\n                if (afterdisplay) afterdisplay();\n            });\n        };\n\n        // Fold previous cols, then unfold new cols\n        Main.k.folding.fold(tofold, after);\n    };\n    Main.k.folding.fold = function(cols, after) {\n        // Init CSS transform\n        for (var i=0; i<cols.length; i++) {\n            if (cols[i]) $(cols[i]).css({\n                \"transform\": \"scale(0,1)\",\n                \"-o-transform\": \"scale(0,1)\",\n                \"-webkit-transform\": \"scale(0,1)\"\n            });\n        }\n\n        setTimeout(function() {\n            // Hide previous cols\n            for (var i=0; i<cols.length; i++) {\n                if (cols[i]) $(cols[i]).hide();\n            }\n\n            if (after) after();\n        }, 250);\n    };\n    Main.k.folding.unfold = function(cols, after) {\n        // Display new cols\n        for (var i=0; i<cols.length; i++) {\n            if (cols[i]) $(cols[i]).show();\n        }\n\n        setTimeout(function() {\n            // Init CSS transform\n            for (var i=0; i<cols.length; i++) {\n                if (cols[i]) $(cols[i]).css({\n                    \"transform\": \"scale(1,1)\",\n                    \"-o-transform\": \"scale(1,1)\",\n                    \"-webkit-transform\": \"scale(1,1)\"\n                });\n            }\n\n            setTimeout(function() {\n                // Update current cols\n                for (var i=0; i<cols.length; i++) {\n                    if (cols[i]) Main.k.folding.currcols[i] = cols[i];\n                }\n\n                if (after) after();\n\n                // Fix flash (chrome)\n                if (cols[1] == Main.k.folding.gamecols[1]) {\n                    $(\"body\").delay(200, \"myQueue\").queue(\"myQueue\", function() {\n                        Main.refreshChat();\n                        Main.acListMaintainer.refresh(true);\n                        Main.syncInvOffset(null,true);\n                        Main.doChatPacks();\n                        Main.topChat();\n                        Main.onChanDone(ChatType.Local[1],true);\n                    }).dequeue(\"myQueue\");\n                }\n            }, 230);\n        }, 20);\n    };\n\n    Main.k.About = {};\n    Main.k.About.initialized = false;\n    Main.k.About.open = function() {//TODO: MULTILANG\n        if (Main.k.folding.displayed == \"about\") {\n            Main.k.folding.displayGame();\n            return;\n        }\n\n        if (!Main.k.About.initialized) {\n            Main.k.About.initialized = true;\n\n            var td = $(\"<td>\").addClass(\"\").css({\n                \"padding-right\": \"6px\",\n                \"padding-top\": \"1px\",\n                transform: \"scale(0,1)\",\n                color: \"rgb(9,10,97)\"\n            }).attr(\"id\", \"about_col\").appendTo($(\"table.inter tr\").first());\n\n            // Logo\n\n            // Links\n            var links = $(\"<div>\").css({\n                \"text-align\": \"center\"\n            }).appendTo(td);\n            $(\"<img>\").css({\n                height: \"100px\",\n                margin: \"0 auto 0px\"\n            }).attr(\"src\", Main.k.servurl + \"/img/ctrlw1.png\").appendTo(links);\n            $(\"<br/>\").appendTo(links);\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/planet.png' /> Groupe Twinoid\", 'http://twinoid.com/g/ctrl-w').css({\n                margin: \"0 2px\",\n                display: \"inline-block\"\n            }).appendTo(links);\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talkie.png' /> Chan IRC\", \"http://webchat.quakenet.org/?channels=#ctrlw\").css({\n                margin: \"0 2px\",\n                display: \"inline-block\"\n            }).appendTo(links)\n                .find(\"a\").attr(\"_title\", Main.k.text.gettext(\"Chan IRC\"))\n                .attr(\"_desc\", Main.k.text.gettext(\"Venez discuter sur IRC avec les autres utilisateurs du script. \\\n\t\t\tVous pourrez également y trouver de l'aide ou faire des suggestions.</p><p><strong>Chan #ctrlw sur Quakenet</strong>\"))\n                .on(\"mouseover\", Main.k.CustomTip).on(\"mouseout\", Main.k.hideTip);\n\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Topic (Forum Mush)\"),\n                /* Translators: Script topic (Mush forum) */\n                Main.k.text.gettext(\"http://twd.io/e/0fdb0w\")).css({\n                    margin: \"0 2px\",\n                    display: \"inline-block\"\n                }\n            ).appendTo(links);\n\n            // Disclaimer\n            $(\"<p>\").css({\n                margin: \"20px\",\n                color: \"#CCC\",\n                \"text-align\": \"center\"\n            }).html(Main.k.text.gettext(\"Script développé par <a href='http://twinoid.com/user/8297'>kill0u</a>, maintenu par <a href='http://twinoid.com/user/1244143'>badconker</a><br/>\"+\n            \"Le logo, les images (mise en forme personnalisée des messages) et le design du site web ont été faits par \"+\n            \"<a href='http://twinoid.com/user/2992052'>Gnux</a>.<br/>\"+\n            Main.k.text.gettext(\"Contributeurs : \") + \"<a href='http://twinoid.com/user/362197'>FloKy</a>\" +\n            \", <a href='http://twinoid.com/user/5140898'>_Fraise__</a>\"+\n            \", <a href='http://twinoid.com/user/8011565'>NightExcessive</a><br/>\"+\n            Main.k.text.gettext(\"Traducteurs : \") + \"<a href='http://twinoid.com/user/7845671'>Avistew (en)</a>, <a href='http://twinoid.com/user/6031682'>Kohaku (es)</a>, <a href='http://twinoid.com/user/531084'>R3my (es)</a>, <br/><a href='http://twinoid.com/user/21696'>Javiernh (es)</a>\")).appendTo(td);\n\n            // Coming soon\n            /*$(\"<h2>\").css({\n             color: \"#EEE\",\n             margin: \"10px 15px 0\"\n             }).html(\"Fonctionnalités à venir&nbsp;:\").appendTo(td);\n             var ul = $(\"<ul>\").css({\n             margin: \"0 20px 0 30px\",\n             color: \"#CCC\",\n             \"list-style-type\": \"square\"\n             }).appendTo(td);\n             $(\"<li>\").html(\"Enregistrement (manuel) des informations sur les joueurs\").appendTo(ul);\n             $(\"<li>\").html(\"Amélioration du Manager\").appendTo(ul);\n             $(\"<li>\").html(\"Amélioration de la gestion des plantes\").appendTo(ul);\n             $(\"<li>\").html(\"Gestion des médicaments et de la nourriture\").appendTo(ul);\n             $(\"<li>\").html(\"Gestion des animations distributeur\").appendTo(ul);\n             $(\"<li>\").html(\"Informations sur le démontage d'objets\").appendTo(ul);\n             $(\"<li>\").html(\"Assistant Admin. Neron + messages pré-enregistrés\").appendTo(ul);\n             $(\"<li>\").html(\"Whiteboard (surprise)\").appendTo(ul);\n             $(\"<li>\").css(\"list-style-type\", \"none\").html(\"<a href='\" + Main.k.website + \"'>Liste des mises à jour</a>\").appendTo(ul);*/\n\n            // Close\n            var close = $(\"<div>\").css({\n                \"text-align\": \"center\",\n                margin: \"30px 0 0\"\n            }).appendTo(td);\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/pageleft.png' /> \"+Main.k.text.gettext(\"Retour au jeu\"), null, Main.k.About.open).css(\"display\", \"inline-block\").appendTo(close);\n        }\n\n        Main.k.folding.display([null,null, \"#about_col\"], \"about\");\n    };\n\n    // == Sync Manager  ========================================\n    Main.k.Sync = {};\n    Main.k.Sync.initialized = false;\n    Main.k.Sync.push_timer = null;\n    Main.k.Sync.open = function(){\n        if(!Main.k.Sync.initialized){\n            this.initialized = true;\n            var td = $(\"<td>\").addClass(\"chat_box ctrlw_col\").css({\n                \"padding-right\": \"6px\",\n                \"padding-top\": \"1px\",\n                transform: \"scale(0,1)\"\n            }).attr(\"id\", \"sync_col\").appendTo($(\"table.inter tr\").first());\n\n            var regex = new RegExp('[0-9]+$');\n            var result = regex.exec($('#tid_openRight').attr('href'));\n            var sync_key = localStorage.getItem('ctrlw_sync_key');\n            $('<p>').addClass('ctrlw-row-options').append(\n                $('<label>')\n                    .html('<span style=\"display: inline-block; width:10%\">'+Main.k.text.gettext(\"Clé :\")+'</span>')\n                    .append(\n                    $('<input>')\n                        .attr({\n                            type: 'text',\n                            placeholder: Main.k.text.gettext('Collez votre clé ici'),\n                            id:'ctrlw-sync-key'\n                        })\n                        .css({\n                            'text-align': 'center',\n                            display: 'inline-block',\n                            width: '80%',\n                            'margin-right': '10px'\n                        })\n                        .data('val',localStorage.getItem('ctrlw_sync_key'))\n                        .val(sync_key != null ? sync_key : '')\n                        .on('paste',function(elem){\n                            var $this = $(this);\n                            setTimeout(function () {\n                                var val = $this.val();\n                                var old_val = $this.data('val');\n                                if (val.length > 20 && localStorage.getItem('ctrlw_sync_key') != val && old_val != val) {\n                                    var $status_sync = $('.status_sync');\n                                    $status_sync.hide();\n                                    $('.status_sync_load').show();\n                                    $.when(Main.k.Sync.pull(val)).then(function () {\n                                        localStorage.setItem('ctrlw_sync_key', val);\n                                        $status_sync.hide();\n                                        $('.status_sync_ok').show();\n                                    }).fail(function () {\n                                        $status_sync.hide();\n                                        $('.status_sync_ko').show();\n\n                                    });\n\n                                }\n                                $this.data('val', val);\n                            },10);\n                        })\n                )\n                    .append(\n                    $('<div>')\n                        .css({\n                            display: 'inline-block',\n                            position: 'relative',\n                            top: '2px'\n                        })\n                        .append(\n                        $('<img>')\n                            .attr({\n                                'src': '/img/icons/ui/alert.png'\n                            })\n                            .addClass('status_sync status_sync_ko')\n                            .css({\n                                'margin-left': '5px',\n                                display: (sync_key != null ? 'none' : 'inline'),\n                                position: 'relative',\n                                top: '-2px'\n                            })\n                    )\n                        .append(\n                        $('<img>')\n                            .attr({\n                                'src': '/img/icons/ui/reported.png'\n                            })\n                            .addClass('status_sync status_sync_ok')\n                            .css({\n                                'margin-left': '5px',\n                                display: (sync_key == null ? 'none' : 'inline')\n                            })\n                    )\n                        .append('<img class=\"cdLoading status_sync status_sync_load\" src=\"/build/img/icons/ui/loading1.gif\" alt=\"loading...\" style=\"display:none\"/>')\n\n                )\n            )\n                .appendTo(td);\n            $('<p>')\n                .css({\n                    'text-align': 'center'\n                })\n                .append(\n                Main.k.MakeButton(\"<img src='/build/img/icons/ui/neron_fluw.png' /> \"+Main.k.text.gettext(\"Générer une nouvelle clé\"), null, Main.k.Sync.createKey)\n                    .css(\"display\", \"inline-block\")\n                    .addClass('ctrlw')\n            )\n                .appendTo(td);\n            $('<p>')\n                .css({\n                    'text-align': 'center'\n                })\n                .append(\n                Main.k.MakeButton(\"<img src='http://imgup.motion-twin.com/twinoid/6/4/6666e528_4030.jpg' /> \"+Main.k.text.gettext(\"Supprimer la clé\"), null, function(){\n                    if(confirm(Main.k.text.gettext('Si vous supprimez la clé, vous ne pourrez plus synchroniser vos données, voulez vous continuer ?'))){\n                        $('.status_sync').hide();\n                        $('.status_sync_ko').show();\n                        localStorage.removeItem('ctrlw_sync_key');\n                        $('#ctrlw-sync-key').val('');\n                    }\n                })\n                    .css(\"display\", \"inline-block\")\n                    .addClass('ctrlw')\n            )\n                .appendTo(td);\n            $('<p class=\"info\">')\n                .html(Main.k.text.gettext(\"Afin de pouvoir synchroniser vos données vous devez entrer votre clé d'authentification. \" +\n                \"Si vous n'en n'avez pas, cliquez sur le bouton \\\"Générer une nouvelle clé\\\"\"))\n                .appendTo(td);\n            $('<p class=\"warning\">'+Main.k.text.gettext(\"Conservez précieusement votre clé (dans votre bloc-note Twinoid par exemple) afin de pouvoir récupérer vos données.\")+'<p>')\n                .appendTo(td);\n        }\n        Main.k.folding.display([null,null, \"#sync_col\"], \"sync\", function() {\n        });\n    };\n    Main.k.Sync.display = function(surname) {\n        if (Main.k.folding.displayed == \"sync\") {\n            Main.k.Sync.close();\n        }else{\n            Main.k.Sync.open();\n        }\n    };\n    Main.k.Sync.close = function(){\n        Main.k.folding.displayGame();\n    };\n    Main.k.Sync.createKey = function(){\n        var $status_sync = $('.status_sync');\n        $status_sync.hide();\n        $('.status_sync_load').show();\n        GM_xmlhttpRequest({\n            url :Main.k.servurl + \"/sync/createkey\",\n            method: \"GET\",\n            onload: function(json) {\n                $status_sync.hide();\n                $('.status_sync_ok').show();\n                try {\n                    json = JSON.parse(json.response);\n                } catch (e) {\n                    Main.k.quickNoticeError('Une erreur serveur s\\'est produite');\n                    console.error('json key',json);\n                    return false;\n                }\n                localStorage.setItem('ctrlw_sync_key',json.key);\n                $('#ctrlw-sync-key').val(json.key);\n                Main.k.Sync.push();\n            },\n            onerror: function(xhr,statut,http){\n                var message = JSON.parse(xhr.responseText).message;\n                $status_sync.hide();\n                $('.status_sync_ko').show();\n                Main.k.quickNoticeError('Une erreur s\\'est produite : '+ message);\n                console.warn(xhr,statut,http);\n            }\n        });\n    };\n    Main.k.Sync.pull = function(key) {\n        console.info('Main.k.Sync.pull');\n        var dfd = new jQuery.Deferred();\n        if(typeof(key) == 'undefined'){\n            key = localStorage.getItem('ctrlw_sync_key');\n        }\n        if(key == null){\n            dfd.reject('key_null');\n        }else{\n            var button = $('#ctrlw_sync_button');\n            button.find('img').hide();\n            button.find('.ctrlw_down').show();\n            console.log('Main.k.Sync.pull request');\n            GM_xmlhttpRequest({\n                method: 'POST',\n                url : Main.k.servurl + \"/sync/pull\",\n                data : $.param({\n                    last_update_time : localStorage.getItem('ctrlw_sync_last_update_time'),\n                    key: key\n                }),\n                headers: {\n                    \"Content-Type\": \"application/x-www-form-urlencoded\"\n                },\n                onload: function(response) {\n                    button.find('img').hide();\n                    button.find('.ctrlw_normal').show();\n                    if(response.status == 200){\n                        var json = JSON.parse(response.responseText);\n                        console.log('Main.k.Sync.pull response',json);\n                        if(json.error == 'auth'){\n                            Main.k.quickNoticeError('Cette clé n\\'existe pas');\n                            dfd.reject('auth');\n                        }else{\n                            if(json.status == 'outdated'){\n                                console.warn(JSON.parse(json.sync.profiles));\n                                Main.k.Profiles.load(json.sync.profiles,true);\n                                if(typeof(json.sync.msgs_prerecorded) != 'undefined'){\n                                    Main.k.Manager.loadMsgsPrerecorded(json.sync.msgs_prerecorded,true);\n                                }\n                                Main.k.GameInfos.load(json.sync.game_infos);\n                                Main.k.MushInitHeroes();\n                                Main.k.quickNotice(Main.k.text.gettext('Synchronisation effectuée'));\n                                Main.k.MushUpdate();\n                            }\n                            dfd.resolve();\n                        }\n                    }else{\n                        Main.k.quickNoticeError('Sync pull, fatal error');\n                    }\n\n\n                },\n                onerror: function(xhr,statut,http){\n                    alert('error Main.k.Sync.pull');\n                    console.warn(xhr,statut,http);\n                    button.find('img').hide();\n                    button.find('.ctrlw_normal').show();\n                    dfd.reject('ajax_error');\n\n\n                }\n            });\n        }\n\n        return dfd.promise();\n    };\n    Main.k.Sync.push = function(force_push) {\n        console.info('xhr Sync.push1');\n        var key = localStorage.getItem('ctrlw_sync_key');\n        if(key == null){\n            return;\n        }\n        if(typeof(force_push) == 'undefined'){\n            force_push = false;\n        }\n        var button = $('#ctrlw_sync_button');\n        button.find('img').hide();\n        button.find('.ctrlw_up').show();\n        console.info('xhr Sync.push2');\n        setTimeout(function() {\n            GM_xmlhttpRequest({\n                method: \"POST\",\n                url: Main.k.servurl + \"/sync/push\",\n                data : $.param({\n                    last_update_time : localStorage.getItem('ctrlw_sync_last_update_time'),\n                    mush_time: $('#input').attr('now'),\n                    profiles: JSON.stringify(Main.k.Profiles.data),\n                    game_infos: JSON.stringify(Main.k.GameInfos.data),\n                    msgs_prerecorded: JSON.stringify(Main.k.Manager.msgs_prerecorded),\n                    key: key,\n                    force : force_push ? 1 : 0\n                }),\n                headers: {\n                    \"Content-Type\": \"application/x-www-form-urlencoded\"\n                },\n                onload: function(response) {\n                    console.warn('response',response);\n\n                    if(response.status == 200){\n                        /** @type {{sync:<Object{updated_at:string}>,status:string}} **/\n                        var json = JSON.parse(response.responseText);\n                        console.warn('json',json);\n                        //json = JSON.parse(localStorage.getItem('ctrlw_json_test'));\n                        if(json.status == 'ok'){\n                            localStorage.setItem('ctrlw_sync_last_update_time',$('#input').attr('now'));\n                        }else{\n                            console.warn('json.status',json.status);\n                            if(typeof(json.status) !='undefined'){\n                                if(typeof(json.error) !='undefined' && json.error == 'auth'){\n                                    Main.k.quickNoticeError(Main.k.text.gettext('Synchronisation impossible, clé incorrecte'));\n                                }else{\n                                    var popup = Main.k.CreatePopup();\n                                    popup.content.css({\n                                        \"height\": \"auto\",\n                                        \"max-height\": \"90%\",\n                                        \"width\": \"700px\",\n                                        \"color\": \"#FFF\"\n                                    });\n\n                                    // Fill popup content\n                                    var content = \"<div class='sync_ask popup-content'>\" + Main.k.text.gettext('Les données distantes sont plus récentes que les données locales. <br/> Que voulez vous faire ?') + '<br/>' +\n                                        Main.k.text.gettext('Date synchro serveur : ') + new Date(json.sync.mush_time) + '<br/>' +\n                                        Main.k.text.gettext('Date synchro locale : ') + new Date(parseInt(localStorage.getItem('ctrlw_sync_last_update_time'))) +\n                                        \"</div>\";\n                                    var buttons = $(\"<div class='popup-actions'>\" +\n                                    \"<div id=\\\"confirm_pull\\\" class=\\\"but updatesbtn\\\" >\" +\n                                    \"<div class=\\\"butright\\\">\" +\n                                    \"<div class=\\\"butbg\\\">\" +\n                                    \"<a href=\\\"#\\\">\"+Main.k.text.gettext(\"Ecraser les données locales\")+\"</a>\" +\n                                    \"</div>\" +\n                                    \"</div>\" +\n                                    \"</div>\" +\n                                    \"<div id=\\\"confirm_push\\\" class=\\\"but updatesbtn\\\" >\" +\n                                    \"<div class=\\\"butright\\\">\" +\n                                    \"<div class=\\\"butbg\\\">\" +\n                                    \"<a href=\\\"#\\\">\"+Main.k.text.gettext(\"Ecraser les données distantes\")+\"</a>\" +\n                                    \"</div>\" +\n                                    \"</div>\" +\n                                    \"</div>\" +\n                                    \"</div>\");\n                                    buttons.find('#confirm_pull').on('click',function(e){\n                                        e.preventDefault();\n                                        Main.k.Sync.pull();\n                                        Main.k.ClosePopup();\n                                    });\n                                    buttons.find('#confirm_push').on('click',function(e){\n                                        e.preventDefault();\n                                        Main.k.Sync.push(true);\n                                        Main.k.ClosePopup();\n                                    });\n                                    var cancelAc = \"'Main.k.ClosePopup();'\";\n                                    var cancel = \"<div id=\\\"cancel\\\" class=\\\"but updatesbtn\\\" onclick=\" + cancelAc + \"><div class=\\\"butright\\\"><div class=\\\"butbg\\\"><a href=\\\"#\\\">\" + Main.getText(\"cancel\") + \"</a></div></div></div></div>\";\n                                    buttons.append(cancel);\n                                    $(\"<div>\").html(content).append(buttons).appendTo(popup.content);\n\n                                    // Display popup\n                                    Main.k.OpenPopup(popup.dom);\n                                    //Main.k.Sync.pull();\n                                }\n                            }\n                        }\n                        button.find('img').hide();\n                        button.find('.ctrlw_normal').show();\n                    }else{\n                        Main.k.quickNoticeError('Sync push, fatal error');\n                    }\n\n\n                },\n                onerror: function(xhr,statut,http){\n                    alert('error Main.k.Sync.push');\n                    console.warn(xhr,statut,http);\n                }\n            });\n        }, 0);\n    };\n    Main.k.Sync.pushDelay = function() {\n        var delay = 5;\n        var key = localStorage.getItem('ctrlw_sync_key');\n        if(key == null){\n            return;\n        }\n        var button = $('#ctrlw_sync_button');\n        button.find('img').hide();\n        button.find('.ctrlw_wheels').show();\n        clearTimeout(Main.k.Sync.push_timer);\n        button.removeClass('loading');\n\n        /* trick for reset animation */\n        var button_clone = button.clone(true);\n        button.before(button_clone).remove();\n        button = button_clone;\n\n        var counter = button.find('.counter');\n        Main.k.countdownTimer.stop('syncdelay');\n        button.addClass('loading');\n        counter.text(delay);\n        Main.k.countdownTimer.go(delay,'syncdelay',function(count){\n            button.find('.counter').text(count);\n            if(count <= 0){\n                counter.text('');\n            }\n        });\n        Main.k.Sync.push_timer = setTimeout(function(){\n            button.find('img').hide();\n            button.find('.ctrlw_normal').show();\n            button.removeClass('loading');\n            Main.k.Sync.push();\n            Main.k.Sync.push_timer = null;\n        },delay * 1000);\n    };\n    callbacks_storage_sync.add(Main.k.Sync.pushDelay);\n\n\n    // == /Sync Manager  =======================================\n\n    // == Profiles Manager  ========================================\n    Main.k.Profiles = {};\n    Main.k.Profiles.initialized = false;\n    Main.k.Profiles.current = null;\n    Main.k.Profiles.data = {};\n    Main.k.Profiles.open = function() {\n        /** @type {{surname:string,statuses:List, titles:List, dev_surname:string}} **/\n        var o_hero;\n        console.log('Main.k.folding.displayed',Main.k.folding.displayed);\n        if (!Main.k.Profiles.initialized) {\n            Main.k.Profiles.initialized = true;\n            var h = Main.k.h[Main.k.Profiles.current];\n            console.log(h);\n            var td = $(\"<td>\").addClass(\"chat_box ctrlw_col\").css({\n                \"padding-right\": \"6px\",\n                \"padding-top\": \"1px\",\n                transform: \"scale(0,1)\",\n                color: \"rgb(9,10,97)\"\n            }).attr(\"id\", \"profile_col\").appendTo($(\"table.inter tr\").first());\n\n            var header = $(\"<div>\").addClass(\"header\").css({\n                background: \"rgba(52,74,146,0.35)\"\n            }).appendTo(td);\n            $(\"<img>\").css({\n                height: \"120px\",\n                float: \"left\",\n                margin: \"4px\"\n            }).attr(\"src\", \"/img/art/char/\" + h.dev_surname_long + \".jpg\").appendTo(header);\n            $(\"<h3>\").css({\n                position: \"relative\",\n                margin: \"2px 5px 5px 94px\",\n                color: \"#EEE\",\n                \"border-bottom\": \"2px solid #EEE\",\n                \"padding-bottom\": \"2px\",\n                \"font-size\": \"17px\"\n            }).html(\"<span>\" + Main.k.getFullName(Main.k.Profiles.current) + \"</span>\").appendTo(header);\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/awake.png' />\",null,function(event) {\n                Main.k.Profiles.set(Main.k.Profiles.current);\n            }).css({\n                position: \"absolute\",\n                top: \"2px\",\n                right: \"3px\"\n            })\n                .addClass('spy ctrlw')\n                .appendTo($(\"h3\",header)).find(\"a\")\n                .attr(\"_title\", Main.k.text.gettext(\"Espionnage\"))\n                .attr(\"_desc\", Main.k.text.gettext(\"<p>Vous êtes dans la même pièce que cette personne ; vous pouvez donc l'examiner de plus près.</p><p><strong>Cliquez ici pour enregistrer les compétences visibles, statuts publiques et titres de ce personnage.</strong><p>\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            $('<div>')\n                .addClass('hero-details')\n                .appendTo(header);\n            $(\"<div>\").addClass(\"clear\").appendTo(header);\n            var r = $(\"<div>\").addClass(\"right\").css({\n                \"margin-top\": \"10px\"\n            }).appendTo(td);\n            var $notes = $(\"<div>\").attr(\"id\", \"profile-notes\").addClass(\"rightbg chattext\").css({\n                resize: \"none\",\n                height: \"293px\",\n                \"min-height\": \"0\"\n            }).appendTo(r);\n            $notes\n                .append(\n                $('<div>').addClass('profile-content')\n                    .append(\n                    $('<label>')\n                        .attr('for','tiny-notes')\n                        .html('<img src=\"/build/img/icons/ui/infoalert.png\" style=\"vertical-align: text-bottom\"/> '+Main.k.text.gettext('Notes résumées :'))\n                        .addTooltip(Main.k.text.gettext('Notes résumées :'),Main.k.text.gettext('Ce texte apparaitra au survol de la souris sur l\\'icone du personnage à la place de la description originale du jeu'))\n                )\n                    .append(\n                    $('<textarea>')\n                        .addClass('chatbox')\n                        .attr('id','tiny-notes')\n                        .on('focus',function(){$(this).addClass('chatboxfocus');})\n                        .on('keyup',function(){\n                            $('.desc-submit-button img').hide();\n                            $('.desc-submit-button img.desc-ko').show();\n                        })\n                )\n                    .append(\n                    $('<label>')\n                        .attr('for','long-notes')\n                        .text(Main.k.text.gettext('Notes détaillées :'))\n                )\n                    .append(\n                    $('<textarea>')\n                        .addClass('chatbox')\n                        .attr('id','long-notes')\n                        .on('focus',function(){$(this).addClass('chatboxfocus');})\n                        .on('keyup',function(){\n                            $('.desc-submit-button img').hide();\n                            $('.desc-submit-button img.desc-ko').show();\n                        })\n                )\n            );\n            var $actions = $('<div>').addClass('actions').appendTo($notes);\n\n            Main.k.MakeButton(\n                \"<img src='/build/img/icons/ui/alert.png' style=\\\"display:none\\\" class=\\\"desc-ko\\\" /><img class=\\\"desc-ok\\\" style='vertical-align:text-bottom' src='/build/img/icons/ui/projects_done.png' /> \"+Main.k.text.gettext('Enregistrer'),\n                null,\n                function(e){\n                    e.preventDefault();\n                    var profile = Main.k.Profiles.get();\n                    profile.short_desc = $('#tiny-notes').val();\n                    profile.long_desc = $('#long-notes').val();\n                    Main.k.Profiles.set(profile);\n                    $('.desc-submit-button img').hide();\n                    $('.desc-submit-button img.desc-ok').show();\n                }\n            )\n                .css(\"display\", \"inline-block\")\n                .addClass('desc-submit-button')\n                .appendTo($actions);\n\n            var close = $(\"<div>\").css({\n                \"text-align\": \"center\",\n                margin: \"10px 0 0\"\n            }).appendTo(td);\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/pageleft.png' /> \"+Main.k.text.gettext('Retour au jeu'), null, Main.k.Profiles.close).css(\"display\", \"inline-block\").appendTo(close);\n\n        }\n        Main.k.Profiles.update();\n        Main.k.folding.display([null,null, \"#profile_col\"], \"profiles\", function() {\n        });\n    };\n    Main.k.Profiles.display = function(surname) {\n        console.group('Main.k.Profiles.display');\n        console.log('surname',surname);\n        console.log(Main.k.folding.displayed +' == \"profiles\" && ' + surname + ' == '+ Main.k.Profiles.current);\n        if (Main.k.folding.displayed == \"profiles\" && surname == Main.k.Profiles.current) {\n            Main.k.Profiles.close();\n        }else{\n            Main.k.Profiles.current = surname;\n            Main.k.Profiles.open();\n        }\n        console.groupEnd();\n    };\n    Main.k.Profiles.update = function() {\n        console.group('Main.k.Profiles.update');\n        if(Main.k.Profiles.current == null){\n            return;\n        }\n        console.log('Main.k.Profiles.current',Main.k.Profiles.current);\n        var $profile_col = $(\"#profile_col\");\n        var $header = $profile_col.find(\".header\");\n        var $hero_details = $profile_col.find('.hero-details');\n\n        var $this = this;\n        var h = Main.k.h[Main.k.Profiles.current];\n\n        $hero_details.empty();\n\n        // Display hero\n        $header.find(\"img\").first().attr(\"src\", \"/img/art/char/\" + h.dev_surname_long + \".jpg\");\n        $header.find(\"h3 span\").html(Main.k.getFullName(Main.k.Profiles.current));\n\n        var o_hero = this.get(Main.k.Profiles.current);\n        var $spy_button = $profile_col.find('.spy');\n        if($.inArray(Main.k.Profiles.current,Main.k.heroes_same_room) != -1){\n            $spy_button.show();\n        }else{\n            $spy_button.hide();\n        }\n        console.log('o_hero',o_hero);\n        if(o_hero != null){\n            var statuses = $(\"<div>\").addClass(\"icons statuses\");\n            $.each(o_hero.statuses,function(k,status){\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/status/\" + status.img + \".png\")\n                    .attr(\"alt\", status.img)\n                    .attr(\"_title\", status.name)\n                    .attr(\"_desc\", status.desc)\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip)\n                    .appendTo(statuses);\n            });\n            if(typeof(o_hero.spores) != 'undefined' && o_hero.spores != null){\n                console.warn(o_hero.spores);\n                var $spores = $('<div>')\n                    .css({\n                        position: 'relative',\n                        display: 'inline-block',\n                        'margin-left': '2px',\n                        top: '2px'\n                    })\n                    .appendTo(statuses);\n\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/spore.png\")\n                    .attr(\"height\", \"16\").attr(\"alt\", o_hero.spores.name)\n                    .attr(\"_title\", o_hero.spores.name)\n                    .attr(\"_desc\", o_hero.spores.desc)\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip)\n                    .appendTo($spores);\n\n                $('<span>')\n                    .text(o_hero.spores.nb)\n                    .css({\n                        color: '#FFF',\n                        'font-size': \"10px\",\n                        position: 'absolute',\n                        left: '4px',\n                        top: '1px',\n                        opacity: 0.7,\n                        'pointer-events': 'none'\n\n                    })\n                    .appendTo($spores);\n            }\n\n            var skills = $(\"<div>\").addClass(\"icons skills\");\n            $.each(o_hero.skills,function(k,skill){\n                var skilldom = $(\"<span>\").addClass(\"skill\").appendTo(skills);\n\n                $(\"<img>\").attr(\"src\", \"/img/icons/skills/\" + skill.img + \".png\")\n                    .attr(\"height\", \"19\").attr(\"alt\", skill.img)\n                    .attr(\"_title\", skill.name)\n                    .attr(\"_desc\", skill.desc + (Main.k.compInactiveMush[skill.img] ? \"<p><strong>\"+Main.k.text.gettext(\"Compétence inactive mush\")+\"</strong></p>\" : \"\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip)\n                    .appendTo(skilldom);\n\n                if (Main.k.compInactiveMush[skill.img]) {\n                    $(\"<img>\").attr(\"src\", Main.k.servurl_badconker + \"/img/non-mush.png\").addClass(\"actmush\")\n                        .attr(\"width\", \"10\").attr(\"height\", \"10\")\n                        .attr(\"_title\", Main.k.text.gettext(\"Compétence inactive mush\"))\n                        .attr(\"_desc\", Main.k.text.gettext(\"Cette compétence est inactive quand on est mush (source : Twinpedia).\"))\n                        .on(\"mouseover\", Main.k.CustomTip)\n                        .on(\"mouseout\", Main.k.hideTip)\n                        .appendTo(skilldom);\n                }\n            });\n\n            var titles = $(\"<div>\")\n                .css({\n                    position: 'absolute',\n                    right: '5px',\n                    top: 0\n                })\n                .addClass(\"titles\");\n            console.info('o_hero.titles',o_hero.titles);\n            $.each(o_hero.titles,function(k,title){\n                console.log(title);\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/\" + title.img + \".png\")\n                    .attr(\"alt\", title.img)\n                    .attr(\"_title\", title.name)\n                    .attr(\"_desc\", title.desc)\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip)\n                    .appendTo(titles);\n            });\n\n            $hero_details.append(skills);\n            $hero_details.append(statuses);\n            $hero_details.append(titles);\n\n            $('#long-notes').val(typeof(o_hero.long_desc) != 'undefined' ? o_hero.long_desc : '');\n            $('#tiny-notes').val(o_hero.short_desc);\n\n        }else{\n            $(\"<div>\")\n                .html(Main.k.text.gettext('Aucune donnée enregistrée'))\n                .css({\n                    color:'#FFF'\n                })\n                .appendTo($hero_details);\n\n        }\n        var $custom_infos = $('<div>').addClass('profile-custom-infos').appendTo($hero_details);\n        $('<label />')\n            .attr('for','hero_details_dead')\n            .append(\n            $('<img>')\n                .attr({\n                    src: '/img/icons/ui/dead.png',\n                    alt: 'dead',\n                    title: 'dead'\n                })\n        )\n            .append(\n            $('<input />')\n                .attr({\n                    id: 'hero_details_dead',\n                    type: 'checkbox'\n                })\n                .prop('checked',o_hero.dead)\n                .on('change',function(){\n                    var o_hero = $this.get();\n                    o_hero.dead = $(this).prop('checked');\n                    $this.set(o_hero);\n                })\n        )\n            .appendTo($custom_infos);\n        $('<label />')\n            .attr('for','hero_details_inactive')\n            .append(\n            $('<img>')\n                .attr({\n                    src: '/img/icons/ui/'+Main.k.statuses['inactive']['img']+'.png',\n                    alt: 'inactive',\n                    title: 'inactive'\n                })\n        )\n            .append(\n            $('<input />')\n                .attr({\n                    id: 'hero_details_inactive',\n                    type: 'checkbox'\n                })\n                .prop('checked',$this.hasAttr(o_hero,'statuses',Main.k.statuses['inactive']['img']))\n                .on('change',function(){\n                    var o_hero = $this.get();\n                    if($(this).prop('checked')){\n                        o_hero.statuses.push(Main.k.statuses['inactive']);\n                    }else{\n                        o_hero = $this.removeAttrFromProfile(o_hero,'statuses',Main.k.statuses['inactive']['img']);\n                    }\n                    $this.set(o_hero);\n                    $this.update();\n                })\n        )\n            .appendTo($custom_infos);\n        $('<label />')\n            .attr('for','hero_details_hinactive')\n            .append(\n            $('<img>')\n                .attr({\n                    src: '/img/icons/ui/'+Main.k.statuses['hinactive']['img']+'.png',\n                    alt: 'highly inactive',\n                    title: 'highly inactive'\n                })\n        )\n            .append(\n            $('<input />')\n                .attr({\n                    id: 'hero_details_hinactive',\n                    type: 'checkbox'\n                })\n                .prop('checked',$this.hasAttr(o_hero,'statuses',Main.k.statuses['hinactive']['img']))\n                .on('change',function(){\n                    var o_hero = $this.get();\n                    if($(this).prop('checked')){\n                        o_hero.statuses.push(Main.k.statuses['hinactive']);\n                    }else{\n                        o_hero = $this.removeAttrFromProfile(o_hero,'statuses',Main.k.statuses['hinactive']['img']);\n                    }\n                    $this.set(o_hero);\n                    $this.update();\n                })\n        )\n            .appendTo($custom_infos);\n        console.groupEnd();\n    };\n    Main.k.Profiles.create = function(dev_surname){\n        return {\n            'name': Main.k.h[dev_surname].name,\n            'dev_surname': dev_surname,\n            'short_desc': Main.k.h[dev_surname].short_desc,\n            'long_desc': '',\n            'statuses': [],\n            'titles': [],\n            'skills': [],\n            'dead': false\n        };\n    };\n    Main.k.Profiles.set = function(profile,save){\n        if(save == null){\n            save = true;\n        }\n        console.group('Main.k.Profiles.save');\n        console.log('profile',profile);\n        var profiles = this.data;\n        if(profiles == null){\n            profiles = {};\n        }\n        if(typeof(profile) == 'string'){\n            profile = this.convertHeroToProfile(Main.k.getHeroBySurname(profile));\n        }\n        profiles[profile.dev_surname] = profile;\n        this.data = profiles;\n        console.groupEnd();\n        if(save){\n            this.save();\n            Main.k.MushUpdate();\n        }\n    };\n    Main.k.Profiles.get = function(hero){\n        if(typeof(hero) == 'undefined'){\n            hero = Main.k.Profiles.current;\n        }\n        var profiles = this.data;\n        if(profiles != null && typeof(profiles[hero]) != 'undefined') {\n            console.groupEnd();\n            return profiles[hero];\n        }else{\n            console.groupEnd();\n            return Main.k.Profiles.create(hero);\n        }\n    };\n    Main.k.Profiles.save = function() {\n        localStorage.setItem('ctrlw_profiles',JSON.stringify(this.data));\n        callbacks_storage_sync.fire();\n    };\n    Main.k.Profiles.load = function(profiles,json) {\n        console.info('Main.k.Profiles.load');\n        var profiles_json;\n        if(typeof(profiles) != 'undefined'){\n            if(typeof(json) != 'undefined' && !json){\n                profiles_json = JSON.stringify(profiles);\n            }else{\n                profiles_json = profiles;\n                profiles = JSON.parse(profiles);\n            }\n            this.data = profiles;\n            localStorage.setItem('ctrlw_profiles',profiles_json);\n        }else{\n            profiles_json = localStorage.getItem('ctrlw_profiles');\n            if(profiles_json != null){\n                this.data = JSON.parse(profiles_json);\n            }\n        }\n\n    };\n    Main.k.Profiles.convertHeroToProfile = function(o_hero_orig) {\n        console.group('convertHeroToSimpleHero');\n        console.log('o_hero_orig',o_hero_orig);\n        var profile = this.get(o_hero_orig.dev_surname);\n        if(profile == null){\n            profile = Main.k.Profiles.create(o_hero_orig.dev_surname);\n        }\n        profile.statuses = [];\n        profile.titles = [];\n        profile.skills = [];\n        profile.spores = null;\n        profile.name = o_hero_orig.name;\n        profile.dev_surname = o_hero_orig.dev_surname;\n        profile.dead = false;\n        if (o_hero_orig.statuses) {\n            var $_statuses = o_hero_orig.statuses.iterator();\n            while( $_statuses.hasNext() ) {\n                /** @type {{img:string,desc:string}} **/\n                profile.statuses.push($_statuses.next());\n            }\n        }\n\n        var skills = $(\"<div>\").addClass(\"icons skills\");\n        if (o_hero_orig.skills) {\n            var $_skills = o_hero_orig.skills.iterator();\n            while( $_skills.hasNext() ) {\n                profile.skills.push($_skills.next());\n            }\n        }\n\n        var titles = $(\"<div>\").addClass(\"titles\");\n        if (o_hero_orig.titles) {\n            var $_titles = o_hero_orig.titles.iterator();\n            while( $_titles.hasNext() ) {\n                profile.titles.push($_titles.next());\n            }\n        }\n        if (o_hero_orig.spores) {\n            profile.spores = o_hero_orig.spores;\n        }\n        console.groupEnd();\n        return profile;\n    };\n    Main.k.Profiles.removeAttrFromProfile = function(profile,type_attribute,value,key_value){\n        console.warn('avant',profile[type_attribute]);\n        if(typeof(key_value) == 'undefined'){\n            key_value = 'img';\n        }\n        var index_to_remove = null;\n        for(var i = 0; i<profile[type_attribute].length; i++){\n            if(profile[type_attribute][i][key_value] == value){\n                index_to_remove = i;\n            }\n        }\n        console.warn('milieu',index_to_remove,profile[type_attribute]);\n        if(index_to_remove != null){\n            profile[type_attribute].splice(index_to_remove,1);\n        }\n        console.warn('apres',profile[type_attribute]);\n        return profile;\n    };\n    Main.k.Profiles.hasAttr = function(profile,type_attribute,value,key_value){\n        if(typeof(key_value) == 'undefined'){\n            key_value = 'img';\n        }\n        for(var i = 0; i<profile[type_attribute].length; i++){\n            if(profile[type_attribute][i][key_value] == value){\n                return true;\n            }\n        }\n        return false;\n    };\n    Main.k.Profiles.hasStatusWhichRemoveTitle = function(profile){\n        if(profile.dead){\n            return true;\n        }\n        var status = null;\n        for( var inc = 0; inc < profile.statuses.length; inc ++){\n            /** @type {{desc:string,img:string, name:string}} **/\n            status = profile.statuses[inc];\n            if($.inArray(status.img,[Main.k.statuses.inactive.img,Main.k.statuses.hinactive.img]) != -1){\n                return true;\n            }\n        }\n        return false;\n    };\n    Main.k.Profiles.close = function(){\n        console.log('Main.k.Profiles.close');\n        Main.k.Profiles.current = null;\n        Main.k.folding.displayGame();\n    };\n    Main.k.Profiles.clear = function(){\n        Main.k.Profiles.data = {};\n        localStorage.removeItem('ctrlw_profiles');\n        callbacks_storage_sync.fire();\n    };\n// == /Profiles Manager  =======================================\n\n    Main.k.GameInfos = {};\n    Main.k.GameInfos.data = {};\n    Main.k.GameInfos.data.heroes_list = [];\n    Main.k.GameInfos.init = function() {\n        var ctrlw_game_infos = localStorage.getItem(\"ctrlw_game_infos\");\n        if (ctrlw_game_infos == null){\n            return;\n        }\n        Main.k.GameInfos.data = JSON.parse(ctrlw_game_infos);\n    };\n    Main.k.GameInfos.load = function (json){\n        localStorage.setItem(\"ctrlw_game_infos\",json);\n        Main.k.GameInfos.init();\n    };\n    Main.k.GameInfos.save = function() {\n        localStorage.setItem(\"ctrlw_game_infos\",JSON.stringify(Main.k.GameInfos.data));\n        callbacks_storage_sync.fire();\n    };\n    Main.k.GameInfos.clear = function(){\n        Main.k.Profiles.data = {};\n        localStorage.removeItem(\"ctrlw_game_infos\");\n        callbacks_storage_sync.fire();\n    };\n\n    // == Message Manager  ========================================\n    Main.k.Manager = {};\n    Main.k.Manager.initialized = false;\n    Main.k.Manager.heroes = [];\n    Main.k.Manager.open = function(after) {\n        console.log('manager open debut');\n        var tabs, r, rbg;\n        if (Main.k.folding.displayed == \"manager\" || Main.k.folding.displayed == \"manager_mini\") {\n            Main.k.folding.displayGame();\n            return;\n        }\n        // TEMP CONFIG\n        var hasmushchat = true;\n        var haschat1 = true;\n        var haschat2 = true;\n        var haschat3 = true;\n\n        if (!Main.k.Manager.initialized) {\n            Main.k.Manager.initialized = true;\n\n            // Topics\n            // ----------------------------------------------------------\n            var $tableInterFirst = $(\"table.inter tr\").first();\n            var td_topics = $(\"<td>\").addClass(\"chat_box\").css({\n                \"padding-right\": \"6px\",\n                \"padding-top\": \"1px\",\n                width: \"330px\",\n                transform: \"scale(0,1)\"\n            }).attr(\"id\", \"topics_col\").appendTo($tableInterFirst);\n\n            // Tabs\n            tabs = $(\"<ul>\").addClass(\"tabschat customtabs\").css({margin: 0, position: \"relative\"}).appendTo(td_topics);\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/tip.png\").appendTo($(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabstats\").appendTo(tabs));\n            $(\"<img>\").attr(\"src\", \"http://twinoid.com/img/icons/new.png\").appendTo($(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabnew\").appendTo(tabs));\n            $(\"<img>\").attr(\"src\", \"http://twinoid.com/img/icons/search.png\").appendTo($(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabsearch\").appendTo(tabs));\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/wall.png\").appendTo($(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabwall\").appendTo(tabs));\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/fav.png\").appendTo($(\"<li>\").addClass(\"tab tabon\").attr(\"id\", \"tabfav\").appendTo(tabs));\n\n            // Tab content\n            r = $(\"<div>\").addClass(\"right\").css(\"margin-top\", 0).appendTo(td_topics);\n            rbg = $(\"<div>\").addClass(\"rightbg chattext\").css({\n                \"resize\": \"none\"\n            }).appendTo(r);\n\n            $(\"<div>\").addClass(\"tabcontent\").attr(\"id\", \"tabstats_content\").appendTo(rbg);\n            $(\"<div>\").addClass(\"tabcontent wall\").attr(\"id\", \"tabnew_content\").appendTo(rbg);\n            $(\"<div>\").addClass(\"tabcontent wall\").attr(\"id\", \"tabsearch_content\").appendTo(rbg);\n            if (hasmushchat) $(\"<div>\").addClass(\"tabcontent\").attr(\"id\", \"tabmush_content\").appendTo(rbg);\n            $(\"<div>\").addClass(\"tabcontent wall\").attr(\"id\", \"tabwall_content\").appendTo(rbg);\n            $(\"<div>\").addClass(\"tabcontent wall\").attr(\"id\", \"tabfav_content\").appendTo(rbg);\n            if (haschat1) $(\"<div>\").addClass(\"tabcontent\").attr(\"id\", \"tabchat1_content\").appendTo(rbg);\n            if (haschat2) $(\"<div>\").addClass(\"tabcontent\").attr(\"id\", \"tabchat2_content\").appendTo(rbg);\n            if (haschat3) $(\"<div>\").addClass(\"tabcontent\").attr(\"id\", \"tabchat3_content\").appendTo(rbg);\n            rbg.find(\".tabcontent\").css(\"display\", \"none\");\n\n            // Tooltips\n            var $tabstats = $(\"#tabstats\");\n            $tabstats.attr(\"_title\", \"Statistiques\").attr(\"_desc\", Main.k.text.gettext(\"Affiche les statistiques, et permet de gérer le nombre de messages chargés dans la page.\"));\n            $(\"#tabnew\").attr(\"_title\", \"Nouveaux Messages\").attr(\"_desc\", Main.k.text.gettext(\"Beaucoup de messages à lire ? Le manager permet de rattraper son retard plus facilement. En chargeant tous les messages dans l'onglet Statistiques, vous pouvez aussi voir les messages non lus manqués à cause du bug (Mush) des messages.\"));\n            $(\"#tabsearch\").attr(\"_title\", \"Recherche de Messages\").attr(\"_desc\", Main.k.text.gettext(\"Une discussion à retrouver ? Envie de savoir combien d'incendies se sont déclarés ? (@neron incendie daedalus)\"));\n            /* Translators: This translation must be copied from the game. */\n            $(\"#tabwall\").attr(\"_title\", \"Discussion\").attr(\"_desc\", Main.k.text.gettext(\"Le canal de discussion est indispensable pour s'organiser avec l'équipage.</p><p>Pour participer vous devez posséder un <strong>talkie-walkie</strong>.\"));\n            /* Translators: This translation must be copied from the game. */\n            $(\"#tabfav\").attr(\"_title\", \"Favoris\").attr(\"_desc\", Main.k.text.gettext(\"Votre sélection de sujets favoris.\"));\n            tabs.find(\".tab\").on(\"mouseover\", Main.k.CustomTip);\n            tabs.find(\".tab\").on(\"mouseout\", Main.k.hideTip);\n            tabs.find(\".tab\").on(\"click\", function() { Main.k.Manager.selectTab(this); });\n\n\n            // Current topic\n            // ----------------------------------------------------------\n            var td_topic = $(\"<td>\").addClass(\"chat_box\").css({\n                \"padding-right\": \"6px\",\n                \"padding-top\": \"1px\",\n                width: \"330px\",\n                transform: \"scale(0,1)\"\n            }).attr(\"id\", \"topic_col\").appendTo($tableInterFirst);\n\n            // Tabs\n            tabs = $(\"<ul>\").addClass(\"tabschat customtabs\").css({margin: 0, position: \"relative\"}).appendTo(td_topic);\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/wall.png\").appendTo(\n                $(\"<li>\").addClass(\"tab tabon\").attr(\"id\", \"tabtopic\").attr(\"_title\", \"Discussion\").attr(\"_desc\", Main.k.text.gettext(\"Le canal de discussion est indispensable pour s'organiser avec l'équipage.</p><p>Pour participer vous devez posséder un <strong>talkie-walkie</strong>.\")).appendTo(tabs)\n            );\n\n\n            // List\n            r = $(\"<div>\").addClass(\"right\").css(\"margin-top\", 0).appendTo(td_topic);\n            rbg = $(\"<div>\").addClass(\"rightbg chattext\").css({\n                resize: \"none\"\n            }).appendTo(r);\n\n            var topic = $(\"<div>\").attr(\"id\", \"tabtopic_content\").addClass(\"tabcontent wall topicwall\").css({\n                resize: \"none\",\n                \"min-height\": \"427px\"\n            }).appendTo(rbg);\n            $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Aucun topic sélectionné.\")).appendTo(topic);\n\n            if (hasmushchat) {\n                /* Translators: The beginning must be copied from the game. */\n                var mushtab = $(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabmush\").attr(\"_title\", \"Canal Mush\").attr(\"_desc\", Main.k.text.gettext(\"Ssshh, personne nous entend ici... Le Canal Mush est le <em>canal privé</em> pour les adhérents aux <strong>Mush</strong> <img src='/build/img/icons/ui/mush.png' />.</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\")).appendTo(tabs);\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/mush.png\").appendTo(mushtab);\n                var mushchat = $(\"<div>\").attr(\"id\", \"tabmush_content\").css(\"display\", \"none\").addClass(\"tabcontent wall\").appendTo(rbg);\n                $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Disponible prochainement.\")).appendTo(mushchat);\n            }\n            if (haschat1) {\n                var chat1tab = $(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabchat1\").attr(\"_title\", \"Chat privé #1\").attr(\"_desc\", Main.k.text.gettext(\"Chat privé ouvert avec :<br/>[liste des participants]</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\")).appendTo(tabs);\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/private.png\").appendTo(chat1tab);\n                var chat1 = $(\"<div>\").attr(\"id\", \"tabchat1_content\").css(\"display\", \"none\").addClass(\"tabcontent wall\").appendTo(rbg);\n                $(\"<p>\").addClass(\"warning\").html(\"Disponible prochainement.\").appendTo(chat1);\n            }\n            if (haschat2) {\n                var chat2tab = $(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabchat2\").attr(\"_title\", \"Chat privé #2\").attr(\"_desc\", Main.k.text.gettext(\"Chat privé ouvert avec :<br/>[liste des participants]</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\")).appendTo(tabs);\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/private.png\").appendTo(chat2tab);\n                var chat2 = $(\"<div>\").attr(\"id\", \"tabchat2_content\").css(\"display\", \"none\").addClass(\"tabcontent wall\").appendTo(rbg);\n                $(\"<p>\").addClass(\"warning\").html(\"Disponible prochainement.\").appendTo(chat2);\n            }\n            if (haschat3) {\n                var chat3tab = $(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabchat3\").attr(\"_title\", \"Chat privé #3\").attr(\"_desc\", Main.k.text.gettext(\"Chat privé ouvert avec :<br/>[liste des participants]</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\")).appendTo(tabs);\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/private.png\").appendTo(chat3tab);\n                var chat3 = $(\"<div>\").attr(\"id\", \"tabchat3_content\").css(\"display\", \"none\").addClass(\"tabcontent wall\").appendTo(rbg);\n                $(\"<p>\").addClass(\"warning\").html(\"Disponible prochainement.\").appendTo(chat3);\n            }\n            tabs.find(\".tab\").on(\"mouseover\", Main.k.CustomTip);\n            tabs.find(\".tab\").on(\"mouseout\", Main.k.hideTip);\n            tabs.find(\".tab\").on(\"click\", function() { Main.k.Manager.selectTopicTab(this); });\n\n\n            // Reply\n            // ----------------------------------------------------------\n            var td_reply = $(\"<td>\").addClass(\"chat_box\").css({\n                transform: \"scale(0,1)\",\n                \"padding-top\": \"1px\",\n                \"text-align\": \"right\"\n            }).attr(\"id\", \"reply_col\").appendTo($tableInterFirst);\n\n            // Tabs\n            tabs = $(\"<ul>\").addClass(\"tabschat customtabs\").css({\n                margin: 0,\n                \"text-align\": \"left\",\n                position: \"relative\"\n            }).appendTo(td_reply);\n            var tabreply = $(\"<li>\").addClass(\"tab tabon\").attr(\"id\", \"tabreply\").attr(\"_title\", Main.k.text.gettext(\"Nouveau message\")).attr(\"_desc\", Main.k.text.gettext(\"Répondez à un topic / une discussion ou créez un nouveau topic.\")).appendTo(tabs);\n            var tabneron = $(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabneron\").attr(\"_title\", Main.k.text.gettext(\"Annonces vocodées\")).attr(\"_desc\", Main.k.text.gettext(\"Assistant pour les Admin. Néron pour faciliter la création d'annonces vocodées.</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\")).appendTo(tabs);\n            var tabcustom = $(\"<li>\").addClass(\"tab taboff\").attr(\"id\", \"tabcustom\").attr(\"_title\", Main.k.text.gettext(\"Messages pré-enregistrés\")).attr(\"_desc\", Main.k.text.gettext(\"Messages récurrents & autres (à définir).</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\")).appendTo(tabs);\n            $(\"<img>\").attr(\"src\", \"http://twinoid.com/img/icons/edit.png\").appendTo(tabreply);\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/neron.png\").appendTo(tabneron);\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/book.png\").appendTo(tabcustom);\n            tabs.find(\".tab\").on(\"mouseover\", Main.k.CustomTip);\n            tabs.find(\".tab\").on(\"mouseout\", Main.k.hideTip);\n            tabs.find(\".tab\").on(\"click\", function() { Main.k.Manager.selectReplyTab(this); });\n\n            r = $(\"<div>\").addClass(\"right\").css(\"margin-top\", 0).appendTo(td_reply);\n            rbg = $(\"<div>\").addClass(\"rightbg chattext\").css({\n                \"resize\": \"none\",\n                \"text-align\": \"center\",\n                \"position\": \"relative\"\n            }).appendTo(r);\n            var reply = $(\"<div>\").attr(\"id\", \"tabreply_content\").addClass(\"tabcontent wall\").appendTo(rbg);\n            var vocod = $(\"<div>\").attr(\"id\", \"tabneron_content\").css(\"display\", \"none\").addClass(\"tabcontent wall\").appendTo(rbg);\n            var custom = $(\"<div>\").attr(\"id\", \"tabcustom_content\").css(\"display\", \"none\").addClass(\"tabcontent wall\").appendTo(rbg);\n            $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Disponible prochainement.\")).appendTo(vocod);\n\n            // Actions\n            var mini = Main.k.MakeButton(\"<img src='/build/img/icons/ui/less.png' /> Réduire le Manager\",null,function() {\n                Main.k.Manager.minimize();\n            }).attr(\"id\", \"manager_togglemini\").appendTo(td_reply);\n            mini.css({\n                \"margin\": \"3px 4px 0 auto\",\n                \"display\": \"inline-block\"\n            });\n            var close = Main.k.MakeButton(\"<img src='/build/img/icons/ui/pageleft.png' /> \"+Main.k.text.gettext(\"Fermer le Manager\"),null,function() {\n                Main.k.Manager.open();\n            }).appendTo(td_reply);\n            close.css({\n                \"margin\": \"3px 4px 0 auto\",\n                \"display\": \"inline-block\"\n            });\n        }\n\n        // Load data\n        Main.k.Manager.update();\n        Main.k.Manager.selectTab($tabstats);\n\n        $(\"#manager_togglemini\").find(\"a\").html(\"<img src='/build/img/icons/ui/less.png' /> \"+Main.k.text.gettext(\"Réduire le Manager\"));\n        Main.k.folding.display([\"#topics_col\", \"#topic_col\", \"#reply_col\"], \"manager\", after);\n    };\n    Main.k.Manager.replywaiting = \"\";\n    Main.k.Manager.openOn = function(_target, val, k) {\n        if (val && val.length > 0) Main.k.Manager.replywaiting = val;\n\n        if (_target == \"newtopic\") {\n            Main.k.Manager.open();\n        } else if (_target == \"reply\") {\n            Main.k.Manager.displayedTopic = k;\n            var after = function() {\n                var k = Main.k.Manager.displayedTopic;\n                Main.k.Manager.selectTopic(k);\n            };\n            Main.k.Manager.open(after);\n        }\n    };\n    Main.k.Manager.minimize = function(){\n        var $manager_togglemini = $(\"#manager_togglemini\");\n        if (Main.k.folding.displayed == \"manager\") {\n            $manager_togglemini.find(\"a\").html(\"<img src='/build/img/icons/ui/more.png' /> Agrandir le Manager\");\n            Main.k.folding.display([Main.k.folding.gamecols[0], Main.k.folding.gamecols[1], \"#reply_col\"], \"manager_mini\");\n        } else {\n            $manager_togglemini.find(\"a\").html(\"<img src='/build/img/icons/ui/less.png' /> \"+Main.k.text.gettext(\"Réduire le Manager\"));\n            Main.k.folding.display([\"#topics_col\", \"#topic_col\", \"#reply_col\"], \"manager\");\n        }\n    };\n    Main.k.Manager.selectTab = function(el) {\n        // Select tab\n        var $topic_col = $(\"#topics_col\");\n        $topic_col.find(\".tab\").removeClass(\"tabon\").addClass(\"taboff\");\n        $(el).removeClass(\"taboff\").addClass(\"tabon\");\n\n        // Display content\n        $topic_col.find(\".tabcontent\").css(\"display\", \"none\");\n        $(\"#\" + $(el).attr(\"id\") + \"_content\").css(\"display\", \"block\");\n    };\n    Main.k.Manager.selectTopicTab = function(el) {\n        // Select tab\n        var $topic_col = $(\"#topics_col\");\n        $topic_col.find(\".tab\").removeClass(\"tabon\").addClass(\"taboff\");\n        $(el).removeClass(\"taboff\").addClass(\"tabon\");\n\n        // Display content\n        $topic_col.find(\".tabcontent\").css(\"display\", \"none\");\n        $(\"#\" + $(el).attr(\"id\") + \"_content\").css(\"display\", \"block\");\n    };\n    Main.k.Manager.selectReplyTab = function(el) {\n        var $reply_col = $('#reply_col');\n        // Select tab\n        $reply_col.find(\".tab\").removeClass(\"tabon\").addClass(\"taboff\");\n        $(el).removeClass(\"taboff\").addClass(\"tabon\");\n\n        // Display content\n        $reply_col.find(\".tabcontent\").css(\"display\", \"none\");\n        $(\"#\" + $(el).attr(\"id\") + \"_content\").css(\"display\", \"block\");\n    };\n    Main.k.Manager.topics = [];\n    Main.k.Manager.replies = [];\n    Main.k.Manager.lastago = \"\";\n    Main.k.Manager.loadedtopics = [];\n    Main.k.Manager.loadedreplies = [];\n    Main.k.Manager.lmwProcessing = false;\n    Main.k.Manager.loadWholeWall = function(k) {\n        if (Main.k.Manager.lmwProcessing) return;\n        Main.k.Manager.lmwProcessing = true;\n\n        var w = Main.getChannel(Main.curChatIndex()).find(\"div.wall div.unit\").last();\n        var wp = w.closest(\".wall\");\n\n        if (w.length > 0) {\n            var datak = k ? k : w.attr(\"data-k\");\n            Tools.ping(\"/retrWallAfter/\" + datak,function(content) {\n                var jq1 = $(content);\n                Main.k.Manager.lmwProcessing = false;\n                if (jq1.find(\".wall\").html().trim().length > 0) {\n                    // Store messages\n                    Main.k.Manager.parseWall(jq1.find(\".wall\"));\n\n                    // Get data-k\n                    var datak = jq1.find(\".wall .unit\").last().attr(\"data-k\");\n\n                    // Load moar\n                    Main.k.Manager.loadWholeWall(datak);\n                } else {\n                    Main.k.Manager.update();\n                }\n            });\n        } else {\n            Main.k.Manager.lmwProcessing = false;\n            Main.k.Manager.update();\n        }\n    };\n    Main.k.Manager.parseWall = function(wall) {\n        if (!wall.find) wall = $(wall);\n        var topics = wall.find(\".mainmessage\");\n\n        topics.each(function() {\n            var topic_ago;\n            var tid = $(this).closest(\".unit\").attr(\"data-k\");\n            var editing = (Main.k.Manager.loadedtopics[tid]);\n\n            // Create topic object\n            var topic = editing ? Main.k.Manager.getTopicByTid(tid) : {};\n            if (!editing) topic.mushid = tid;\n\n            // Favorite ?\n            if (!editing) topic.fav = $(this).closest(\".cdWallChannel\").attr(\"id\") == \"cdFavWall\";\n\n            // Neron or Hero ?\n            var hero = \"\";\n            if (!editing) {\n                if ($(this).find(\".mainsaid.neron_talks\").length != 0) {\n                    hero = \"neron\";\n                    Main.k.Manager.heroes[hero].mess++;\n\n                    // AV\n                    if ($(this).find(\".mainsaid.neron_talks p\").length > 0) {\n                        Main.k.Manager.heroes[hero].av++;\n\n                        topic.msg = \"\";\n                        $(this).find(\"p, ul\").each(function() {\n                            topic.msg += \"<\" + $(this).prop(\"tagName\") + \">\" + $(this).html() + \"</\" + $(this).prop(\"tagName\") + \">\";\n                        });\n                    } else {\n                        Main.k.Manager.heroes[hero].a++;\n\n                        var msg = $(this).find(\".mainsaid.neron_talks\").html();\n                        msg = msg.replace(/([\\r\\n]+)/g, \"\");\n                        topic.msg = /NERON\\s:<\\/span>(.+)<span\\s*class=\"ago\"/i.exec(msg)[1].trim();\n                    }\n                } else {\n                    hero = Main.k.GetHeroNameFromTopic($(this));\n                    Main.k.Manager.heroes[hero].mess++;\n                    Main.k.Manager.heroes[hero].topic++;\n\n                    topic.msg = \"\";\n                    $(this).find(\"p, ul\").each(function() {\n                        topic.msg += \"<\" + $(this).prop(\"tagName\") + \">\" + $(this).html() + \"</\" + $(this).prop(\"tagName\") + \">\";\n                    });\n                    if(topic.msg == ''){\n                        topic.msg = $(this).find('.mainsaid')\n                            .clone()\t\t//clone the element\n                            .children()\t\t//select all the children\n                            .remove()\t\t//remove all the children\n                            .end()\t\t\t//again go back to selected element\n                            .text();\n                    }\n                }\n\n                topic.author = hero;\n                topic.id = Main.k.Manager.topics.length;\n            }\n\n            topic.ago = $(this).find(\".ago\").html().trim();\n            topic_ago = topic.ago;\n            topic.read = !$(this).hasClass(\"not_read\");\n            topic.realread = !$(this).hasClass(\"not_read\");\n            if (!topic.realread && !Main.k.hasTalkie) return;\n\n            Main.k.Manager.loadedtopics[tid] = true;\n            if (!editing) topic.replies = [];\n            if (!editing) Main.k.Manager.topics.push(topic);\n\n            // Add messages\n            $(this).parent().find(\".cdRepl\").each(function() {\n                var tid = $(this).closest(\".unit\").attr(\"data-k\");\n                var topic = Main.k.Manager.getTopicByTid(tid);\n\n                var idx = $(this).attr(\"data-idx\");\n                var rid = topic.mushid + \".\" + idx;\n\n                var editing = (Main.k.Manager.loadedreplies[rid] == true);\n\n                // Create message object\n                var reply = editing ? topic.replies[idx] : {};\n                if (!reply) reply = {};\n\n                // Neron or Hero ?\n                var hero = \"\";\n                if (!editing) {\n                    if ($(this).find(\".neron\").length != 0) {\n                        hero = \"neron\";\n                        Main.k.Manager.heroes[hero].mess++;\n                        Main.k.Manager.heroes[hero].av++;\n                    } else {\n                        hero = Main.k.GetHeroNameFromTopic($(this));\n                        Main.k.Manager.heroes[hero].mess++;\n                    }\n\n                    reply.author = hero;\n                    reply.msg = \"\";\n                    $(this).find(\"p, ul\").each(function() {\n                        reply.msg += \"<\" + $(this).prop(\"tagName\") + \">\" + $(this).html() + \"</\" + $(this).prop(\"tagName\") + \">\";\n                    });\n                    if(reply.msg == ''){\n                        reply.msg = $(this).find('.reply')\n                            .clone()\t\t//clone the element\n                            .children()\t\t//select all the children\n                            .remove()\t\t//remove all the children\n                            .end()\t\t\t//again go back to selected element\n                            .text();\n                    }\n                    reply.tid = topic.id;\n                    reply.id = idx;\n                }\n\n                reply.ago = $(this).find(\".ago\").html().trim();\n                topic_ago = Main.k.minAgo(reply.ago, topic_ago);\n                reply.read = !$(this).hasClass(\"not_read\");\n                if (topic.read && !reply.read) topic.read = false;\n                if (!reply.read && !Main.k.hasTalkie) return;\n                Main.k.Manager.loadedreplies[rid] = true;\n\n                // Save message\n                if (!editing) {\n                    topic.replies.push(reply);\n                    Main.k.Manager.replies.push(reply);\n                }\n            });\n\n            Main.k.Manager.lastago = Main.k.maxAgo(topic_ago, Main.k.Manager.lastago);\n        });\n    };\n    Main.k.Manager.parseTopic = function(topic, highlight) {\n        var topicDOM = $(\"<div>\").addClass(\"reply bubble unit\");\n        if (Main.k.Options.cbubbles) topicDOM.addClass(\"bubble_\" + topic.author);\n        if (Main.k.Options.cbubblesNB) topicDOM.addClass(\"custombubbles_nobackground\");\n        var isneron = (topic.author == \"neron\");\n\n        // Author\n        var authdiv = $(\"<div>\").addClass(isneron ? topic.author : \"char \" + topic.author).appendTo(topicDOM);\n        if (topic.author == \"neron\") authdiv.html('<img src=\"/build/img/icons/ui/neron.png\">');\n\n        // Buddy\n        $(\"<span>\").addClass(\"buddy\").html(isneron ? \" NERON : \" : \" \" + Main.k.COMPLETE_SURNAME(topic.author) + \" : \").appendTo(topicDOM);\n\n        // Content\n        var msg = topic.msg;\n        if (highlight) {\n            for (var i=0; i<highlight.length; i++) {\n                var reg = new RegExp(highlight[i], \"gi\");\n                msg = msg.replace(reg, \"<span class='highlight'>\" + highlight[i] + \"</span>\");\n            }\n        }\n        $(\"<div>\").css(\"display\", \"inline\").html(msg).appendTo(topicDOM);\n\n        // Ago\n        $(\"<span>\").addClass(\"ago\").html(topic.ago).appendTo(topicDOM);\n\n        return topicDOM;\n    };\n    Main.k.Manager.displayedTopic = null;\n    Main.k.Manager.displayTopic = function(ti, lwords) {\n        var displaymore = true; // TEMP\n\n        // Clear currtopic\n        var currtopic = $(\"#tabtopic_content\").empty();\n\n        // Parse topic\n        var topic = Main.k.Manager.topics[ti];\n        var mainsaid = Main.k.Manager.parseTopic(topic, lwords);\n        Main.k.Manager.displayedTopic = topic.mushid;\n        mainsaid.attr(\"class\", \"bubble mainmessage mainsaid\");\n        if (topic.author == \"neron\") {\n            mainsaid.find(\"img\").remove();\n            mainsaid.addClass(\"neron_talks\");\n        }\n        mainsaid.css({\n            \"padding-bottom\": \"20px\",\n            \"z-index\": \"10\"\n        }).appendTo(currtopic);\n        if (Main.k.Options.cbubbles) {\n            mainsaid.addClass(\"bubble_\" + topic.author);\n            if (Main.k.Options.cbubblesNB) mainsaid.addClass(\"custombubbles_nobackground\");\n        } else {\n            mainsaid.css(\"background\", \"rgba(255,255,255,0.8)\");\n        }\n\n        // Mark as read\n        if (!topic.realread) {\n            mainsaid.addClass(\"not_read\");\n            mainsaid.prepend($('<img>').addClass(\"recent\").attr(\"src\", \"/img/icons/ui/recent.png\"));\n            mainsaid.attr(\"data-k\", topic.mushid);\n            mainsaid.on(\"mouseover\", function() {\n                ArrayEx.pushBack(Main.checkedWallPost,$(this).attr(\"data-k\"));\n                haxe.Timer.delay(Main.sendWallChecked,1000);\n\n                $(this).find(\".recent\").remove();\n                $(this).removeClass(\"not_read\");\n                $(this).off('onmouseover');\n            });\n        }\n\n        // Display read messages\n        // TODO: do not display if no read messages\n        if (topic.replies.length > 10 && !displaymore) {\n            $(\"<a>\").addClass(\"displaymore\").attr(\"href\", \"#\").on(\"click\", Main.k.Manager.displayAllReplies)\n                .html(\"Afficher les \" + topic.replies.length + \" messages\").appendTo(currtopic);\n        }\n\n        // Display replies\n        var replytable = $(\"<table>\").addClass(\"treereply\").appendTo(currtopic);\n        var tbody = $(\"<tbody>\").appendTo(replytable);\n\n        for (var i=0; i<topic.replies.length; i++) {\n            var reply = topic.replies[i];\n\n            var tr = $(\"<tr>\").addClass(\"cdRepl\").appendTo(tbody);\n            if (topic.replies.length > 10 && reply.read && !displaymore) tr.addClass(\"messread\");\n            if (!reply.read) tr.addClass(\"not_read\");\n\n            var _class = \"tree\" + (i == (topic.replies.length -1) ? \" treelast\" : \"\");\n            $(\"<td>\").addClass(_class).appendTo(tr);\n            var td2 = $(\"<td>\").appendTo(tr);\n\n            var replyDOM = Main.k.Manager.parseTopic(reply, lwords);\n            replyDOM.removeClass(\"unit\").appendTo(td2);\n            replyDOM.prepend($('<div>').attr(\"class\", \"triangleup\"));\n            if (!reply.read) replyDOM.prepend($('<img>').addClass(\"recent\").attr(\"src\", \"/img/icons/ui/recent.png\"));\n\n            // Mark as read\n            if (true || !reply.read) {\n                tr.attr(\"data-k\", topic.mushid);\n                tr.attr(\"data-idx\", reply.id);\n                tr.on(\"mouseover\", function() {\n                    ArrayEx.pushBack(Main.checkedWallPost, $(this).attr(\"data-k\") + \"#\" + $(this).attr(\"data-idx\"));\n                    haxe.Timer.delay(Main.sendWallChecked,1000);\n\n                    $(this).find(\".recent\").remove();\n                    $(this).removeClass(\"not_read\");\n                    $(this).off(\"mouseover\");\n                });\n            }\n        }\n    };\n    Main.k.Manager.displayAllReplies = function() {\n        var $tabtopic_content = $(\"#tabtopic_content\");\n        $tabtopic_content.find(\".messread\").each(function() {\n            $(this).removeClass(\"messread\");\n        });\n        $tabtopic_content.find(\".displaymore\").addClass(\"messread\");\n    };\n    Main.k.Manager.getTopicByTid = function(tid) {\n        for (var i=0; i<Main.k.Manager.topics.length; i++) {\n            var t = Main.k.Manager.topics[i];\n            if (t.mushid == tid) return t;\n        }\n        return false;\n    };\n    Main.k.Manager.clearSess = function() {\n        // Clear sid cookie\n        js.Cookie.set(\"sid\", \"\", -42, \"/\", \".\"+Main.k.domain+\"\");\n\n        // Reload session\n        $('<iframe>', {\n            src: Main.k.mushurl+'/me',\n            id: 'sessionframe',\n            scrolling: 'no'\n        }).css({\n            width: 0,\n            height: 0,\n            display: \"none\",\n            position: \"absolute\"\n        }).appendTo('body').load(function() {\n            // Get new flash\n            var el = $('#cdContent', $('#sessionframe').contents()).clone();\n            el.find(\"embed\").remove();\n\n            var $cdContent = $(\"#cdContent\");\n            // Replace flash\n            $cdContent.replaceWith(el);\n            eval($cdContent.find(\"script\").html());\n\n            // Delete iframe\n            $(\"#sessionframe\").remove();\n\n            // Update new flash\n            Main.refreshChat();\n            Main.acListMaintainer.refresh(true);\n\n            // Fix page title\n            $(document).attr(\"title\", \"Mush - Jeu de survie dans l'espace : Vous êtes le seul espoir de l'humanité !\");\n\n            // Update manager\n            Main.k.Manager.topics = [];\n            Main.k.Manager.replies = [];\n            Main.k.Manager.lastago = \"\";\n            Main.k.Manager.loadedtopics = [];\n            Main.k.Manager.loadedreplies = [];\n            Main.k.Manager.update();\n        });\n    };\n    Main.k.Manager.updateHeroes = function() {\n        Main.k.Manager.initHeroes();\n\n        for (var i=0; i<Main.k.Manager.topics.length; i++) {\n            var topic = Main.k.Manager.topics[i];\n            Main.k.Manager.heroes[topic.author].topic++;\n            Main.k.Manager.heroes[topic.author].mess++;\n\n            for (var j=0; j<topic.replies.length; j++) {\n                var reply = topic.replies[j];\n                Main.k.Manager.heroes[reply.author].mess++;\n            }\n        }\n    };\n    Main.k.Manager.sortedheroes = [];\n    Main.k.Manager.sortHeroes = function() {\n        // Init\n        Main.k.Manager.sortedheroes = [];\n        for (var h in Main.k.Manager.heroes) {\n            if(Main.k.Manager.heroes.hasOwnProperty(h)) {\n                var hero = Main.k.Manager.heroes[h];\n                if (!hero || hero.mess == undefined) continue;\n\n                Main.k.Manager.sortedheroes.push(h);\n            }\n        }\n\n        // Sort\n        Main.k.Manager.sortedheroes.sort(function(b,a) {\n            a = Main.k.Manager.heroes[a];\n            b = Main.k.Manager.heroes[b];\n\n            var a1 = a.mess, b1 = b.mess;\n            if (a1 == b1) {\n                var a2 = a.topic, b2 = b.topic;\n                if (a2 == b2) {\n                    var a3 = a.name, b3 = b.name;\n                    return a3 > b3 ? 1 : -1;\n                }\n                return a2 > b2 ? 1 : -1;\n            }\n            return a1 > b1 ? 1 : -1;\n        });\n    };\n    Main.k.Manager.loadingMessages = function() {\n        var $recap_div = $(\"#recap_div\");\n        $recap_div.empty();\n        $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Chargement en cours...\")).appendTo($recap_div);\n    };\n    Main.k.Manager.fillStats = function() {\n        var tab = $(\"#tabstats_content\").empty();\n        tab.css({\n            color: \"rgb(9, 10, 97)\"\n        });\n\n        var warn = $(\"<div>\").addClass(\"warning\").html(Main.k.text.gettext(\"Gérez le nombre de messages chargés.\"+\n        \"Le manager est plus complet lorsque tous les messages sont chargés, \"+\n        \"mais le jeu devient beaucoup plus lent à cause du chargement de ces messages à chaque action (particularité de mush...).\"))\n            .css(\"background-position\", \"7px 15px\")\n            .appendTo(tab);\n\n        // Actions\n        var actions = $(\"<div>\").css({\n            \"text-align\": \"center\",\n            \"margin-top\": \"8px\"\n        }).appendTo(warn);\n\n        // Action : load all\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/wall.png' class='alerted' /><img src='/build/img/icons/ui/onceplus.png' class='alert' /> \"+Main.k.text.gettext(\"Tout charger\"),null,function() {\n            Main.k.Manager.loadingMessages();\n            Main.k.Manager.loadWholeWall();\n        })\n            .appendTo(actions)\n            .find(\"a\")\n            .attr(\"_title\", Main.k.text.gettext(\"Charger tous les messages\")).attr(\"_desc\", Main.k.text.gettext(\"Chargez tous les messages pour profiter pleinement du manager : recherches dans tous les messages depuis le début de la partie, nouveaux messages manqués à cause du bug de mush, statistiques complètes, etc.</p><p><strong>Cette action peut prendre un certain temps, suivant le nombre de messages postés sur votre vaisseau.</strong>\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip);\n\n        // Action : unload\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/wall.png' class='alerted' /><img src='/build/img/icons/ui/bin.png' class='alert' /> \"+Main.k.text.gettext(\"Décharger\"),null,function() {\n            Main.k.Manager.loadingMessages();\n            Main.k.Manager.clearSess();\n        })\n            .appendTo(actions)\n            .find(\"a\")\n            .attr(\"_title\", Main.k.text.gettext(\"Décharger les messages\")).attr(\"_desc\", Main.k.text.gettext(\"Déchargez la liste de messages pour alléger le jeu. Lorsque vous chargez des messages (en scrollant sur le chat, par exemple), ceux-ci restent chargés. Mush chargeant toute la page (dont les messages) à chaque action, votre jeu est grandement ralenti lorsque le nombre de messages chargés est conséquent.</p><p><strong>Cette action bloque le jeu pendant quelques secondes.</strong>\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip);\n\n        // Fix actions\n        actions.find(\".but\").css({\n            display: \"inline-block\",\n            margin: \"0 2px\"\n        });\n\n        // Print recap\n        var recap = $(\"<div>\").attr(\"id\", \"recap_div\").addClass(\"recap\").appendTo(tab);\n        Main.k.Manager.updateHeroes();\n        Main.k.Manager.sortHeroes();\n\n        var topic_nb = Main.k.Manager.topics.length;\n        var answer_nb = Main.k.Manager.replies.length;\n        var total_msg = topic_nb + answer_nb;\n        //A continuer ici\n        var recap_p = $(\"<p>\").html(Main.k.text.strargs(Main.k.text.ngettext(\"Total : <b>%1</b> message chargé\",\"Total : <b>%1</b> messages chargés\",total_msg),[total_msg])\n\n        + \" \"+ Main.k.text.strargs(Main.k.text.ngettext(\"en <b>%1</b> topic. <br/> (depuis %2)\",\"en <b>%1</b> topics. <br/> (depuis %2)\",topic_nb),[topic_nb,Main.k.extendAgo(Main.k.Manager.lastago)])).appendTo(recap);\n\n        // Hero count\n        var popup_recap_char = $(\"<div>\").addClass(\"chars\").appendTo(recap);\n        var popup_msg = \"//\" + Main.k.text.strargs(Main.k.text.ngettext(\"Total : %1 message\",\"Total : %1 messages\",total_msg),[total_msg])+\"//\";\n        var max_highlighted = 6;\n        for (var i=0; i<Main.k.Manager.sortedheroes.length; i++) {\n            var hero = Main.k.Manager.heroes[Main.k.Manager.sortedheroes[i]];\n            if (!hero || hero.mess == undefined) continue;\n            if (i == max_highlighted) $(\"<br/>\").appendTo(popup_recap_char);\n\n            var heroDiv = $(\"<div>\").addClass(\"hero _\" + hero.name).attr(\"_title\", Main.k.COMPLETE_SURNAME(hero.name)).css(\"cursor\", \"help\").appendTo(popup_recap_char);\n            if (i < max_highlighted) heroDiv.addClass(\"highlight\");\n            if (hero.name == \"neron\") {\n                heroDiv.attr(\"_desc\", Main.k.text.strargs(Main.k.text.ngettext(\"<b>%1</b> message\",\"<b>%1</b> messages\",hero.mess),[hero.mess])); // dont <b>\" + hero.a + \"</b> annonces officielles et <b>\" + hero.av + \"</b> annonces vocodées.\");\n            } else {\n                heroDiv.attr(\"_desc\", Main.k.text.strargs(Main.k.text.ngettext(\"<b>%1</b> message\",\"<b>%1</b> messages\",hero.mess),[hero.mess])\n\n                + \" \"+Main.k.text.strargs(Main.k.text.ngettext(\"dont <b>%1</b> topic.\",\"dont <b>%1</b> topics.\",hero.topic),[hero.topic]));\n            }\n            heroDiv.on(\"mouseover\", Main.k.CustomTip);\n            heroDiv.on(\"mouseout\", Main.k.hideTip);\n            heroDiv.on(\"click\", Main.k.Manager.searchHero);\n\n            $(\"<img>\").attr(\"src\", \"/img/icons/ui/\" + hero.name.replace(\"_\", \"\") + \".png\").appendTo(heroDiv);\n            var msg = (i < max_highlighted) ? hero.mess + \"&nbsp;messages\" : hero.mess;\n            $(\"<span>\").html(msg).appendTo(heroDiv);\n\n            /* Translators: %1 = character name, %2 = message count */\n            popup_msg += \"\\n\"+Main.k.text.strargs(Main.k.text.ngettext(\"**%1 : ** //%2// message\",\"**%1 : ** //%2// messages\",hero.mess),[Main.k.COMPLETE_SURNAME(hero.name),hero.mess]);\n        }\n\n        // Code for sharing msg count\n        $(\"<textarea>\").val(popup_msg).appendTo(recap);\n    };\n    Main.k.Manager.fillNewFav = function() {\n        var topic, topicDOM, actions;\n        var active_topics = $(\"#tabnew_content\").empty().css(\"color\", \"rgb(9, 10, 97)\");\n        var favtopics = $(\"#tabfav_content\").empty().css(\"color\", \"rgb(9, 10, 97)\");\n\n        var allread = true;\n        var favorites = [];\n        for (var i=0; i<this.topics.length; i++) {\n            topic = this.topics[i];\n\n            if (topic.fav) favorites.push(topic);\n            if (!topic.read) {\n                allread = false;\n                topicDOM = this.parseTopic(topic);\n                if (topic.author == \"neron\") {\n                    topicDOM.find(\"img\").remove();\n                    topicDOM.addClass(\"mainmessage neron_talks\");\n                }\n                active_topics.append(topicDOM);\n\n\n                // Unread replies\n                var unread = 0;\n                if (!topic.realread) unread++;\n                for (var j=0; j<topic.replies.length; j++) {\n                    var m = topic.replies[j];\n                    if (!m.read) unread++;\n                }\n\n                // Actions\n                actions = $(\"<a>\").addClass(\"topicact\").attr(\"href\", \"#topic\" + i)\n                    .on(\"click\", function() { Main.k.Manager.displayTopic(parseInt(/([0-9]+)/.exec(this.href)[1])); return false; })\n                    .html(Main.k.text.strargs(Main.k.text.ngettext(\"%1 réponse\",\"%1 réponses\",topic.replies.length),[topic.replies.length])+ \" - \" + Main.k.text.strargs(Main.k.text.ngettext(\"%1 message non lu\",\"%1 messages non lus\",unread),[unread]))\n                    .appendTo(active_topics);\n            }\n        }\n        if (allread) $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Aucun message non lu.\")).appendTo(active_topics);\n\n        if (favorites.length == 0) $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Vous n'avez pas de favoris.\")).appendTo(active_topics);\n        for (i=0; i<favorites.length; i++) {\n            topic = favorites[i];\n\n            topicDOM = this.parseTopic(topic);\n            if (topic.author == \"neron\") {\n                topicDOM.find(\"img\").remove();\n                topicDOM.addClass(\"mainmessage neron_talks\");\n            }\n            favtopics.append(topicDOM);\n\n            // Actions\n            actions = $(\"<a>\").addClass(\"topicact\").attr(\"href\", \"#topic\" + topic.id)\n                .on(\"click\", function() { Main.k.Manager.displayTopic(parseInt(/([0-9]+)/.exec(this.href)[1])); return false; })\n                .html(Main.k.text.strargs(Main.k.text.ngettext(\"%1 réponse\",\"%1 réponses\",topic.replies.length),[topic.replies.length]))\n                .appendTo(favtopics);\n        }\n    };\n    Main.k.Manager.fillWall = function() {\n        var wall = $(\"#tabwall_content\").empty().css(\"color\", \"rgb(9, 10, 97)\");\n        for (var i=0; i<this.topics.length; i++) {\n            var topic = this.topics[i];\n\n            var topicDOM = this.parseTopic(topic);\n            if (topic.author == \"neron\") {\n                topicDOM.find(\"img\").remove();\n                topicDOM.addClass(\"mainmessage neron_talks\");\n            }\n            wall.append(topicDOM);\n\n            // Unread replies\n            var unread = 0;\n            if (!topic.realread) unread++;\n            for (var j=0; j<topic.replies.length; j++) {\n                var m = topic.replies[j];\n                if (!m.read) unread++;\n            }\n\n            // Actions\n            var actions = $(\"<a>\").addClass(\"topicact\").attr(\"href\", \"#topic\" + i)\n                .on(\"click\", function() { Main.k.Manager.displayTopic(parseInt(/([0-9]+)/.exec(this.href)[1])); return false; })\n                .html(Main.k.text.strargs(Main.k.text.ngettext(\"%1 réponse\",\"%1 réponses\",topic.replies.length),[topic.replies.length]))\n                .appendTo(wall);\n        }\n    };\n    Main.k.Manager.fillSearch = function() {\n        var search = $(\"#tabsearch_content\").empty().css(\"color\", \"rgb(9, 10, 97)\");\n\n        // Search tools\n        var searchbar = $(\"<div>\").addClass(\"bar\").appendTo(search);\n        $(\"<input>\").css(\"padding-bottom\", \"2px\").attr(\"type\", \"text\").attr(\"id\", \"searchfield\").on(\"keypress\", function(event) {\n            if(event.keyCode == 13) Main.k.Manager.search();\n        }).appendTo(searchbar);\n\n        $(\"<a>\").css({\n            cursor: \"pointer\",\n            position: \"absolute\",\n            top: \"4px\",\n            left: \"4px\"\n        }).addClass(\"butmini\")\n            .html('<img src=\"/build/img/icons/ui/guide.png\"/>')\n            .appendTo(searchbar)\n            .on(\"click\", Main.k.Manager.fillSearch);\n\n        $(\"<a>\").css(\"cursor\", \"pointer\").addClass(\"butmini\")\n            .html('<img src=\"http://twinoid.com/img/icons/search.png\"/>')\n            .appendTo(searchbar)\n            .on(\"click\", Main.k.Manager.search);\n\n        var results = $(\"<div>\").attr(\"id\", \"searchresults\").appendTo(search);\n        $(\"<h4>\").html(Main.k.text.gettext(\"Fonction de recherche\")).appendTo(results);\n        $(\"<p>\").addClass(\"help\").html(Main.k.text.gettext(\"- Vous pouvez rechercher plusieurs mots, dans le désordre, complets ou non, qu'importe le contenu entre eux dans le message.\")).appendTo(results);\n        $(\"<p>\").addClass(\"help\").html(Main.k.text.gettext(\"- Pour rechercher les messages d'un joueur en particulier, utilisez <i>@personnage</i> (le prénom en minuscule, avec un _ pour kuan_ti et jin_su).\")).appendTo(results);\n        $(\"<p>\").addClass(\"help\").html(Main.k.text.gettext(\"- Pour rechercher uniquement dans le premier message des topics, utilisez <i>@topic</i>.\")).appendTo(results);\n    };\n    Main.k.Manager.search = function() {\n        var word, reg, res, res1;\n        var val = $(\"#searchfield\").val().trim();\n        var results = [];\n        var max_results = 500;\n        var topiconly = false;\n        var $searchresults = $(\"#searchresults\");\n        // Clear results\n        $searchresults.empty();\n\n        // Get searched words\n        var tmp = val.split(/\\s+/);\n        var lwords = [];\n        var iwords = [];\n        var authors = [];\n        for (var i=0; i<tmp.length; i++) {\n            // Topics only?\n            if (tmp[i] == \"@topic\") {\n                topiconly = true;\n                continue;\n            }\n\n            // Search by author\n            if (tmp[i][0] == \"@\") {\n                var author = tmp[i].replace(\"@\", \"\");\n                authors.push(author);\n                continue;\n            }\n\n            // Ignored keyword\n            if (tmp[i][0] == \"!\") {\n                word = tmp[i].replace(/([^a-z0-9-éèêëàâœôöîïüûùç'%_]+)/gi, \"\");\n                if (word.length > 2) iwords.push(word);\n                continue;\n            }\n\n            // Keyword\n            word = tmp[i].replace(/([^a-z0-9-éèêëàâœôöîïüûùç'%_]+)/gi, \"\");\n            if (word.length > 2) lwords.push(word);\n        }\n\n        // Delete doubles\n        lwords = Main.k.EliminateDuplicates(lwords);\n        iwords = Main.k.EliminateDuplicates(iwords);\n        authors = Main.k.EliminateDuplicates(authors);\n\n        // Search\n        if (authors.length >= 1 || lwords.length >= 1 || iwords.length >= 1) {\n            var words = \"(\" + lwords.join(\"|\") + \")\";\n            var nwords = lwords.length;\n            var matched_topics = 0;\n\n            for (i=0; i<Main.k.Manager.topics.length && matched_topics < max_results; i++) {\n                topic = Main.k.Manager.topics[i];\n                var matched = false;\n                var autmatched = false;\n                var imatched = false;\n\n                // Search by author\n                if (authors.length > 0) {\n                    for (var k=0; k<authors.length; k++) {\n                        if (topic.author == authors[k]) {\n                            autmatched = true;\n\n                            if (nwords == 0) matched = true;\n                        }\n                    }\n                }\n\n                // Ignored keywords\n                if (iwords.length > 0) {\n                    var ireg = new RegExp( \"(\" + iwords.join(\"|\") + \")\", \"gi\");\n                    if (topic.msg.match(ireg)) {\n                        matched = false;\n                        imatched = true;\n                    }\n                }\n\n                // Search by keywords\n                if (!imatched && lwords.length > 0 && (authors.length == 0 || autmatched)) {\n                    reg = new RegExp(words, \"gi\");\n                    res = topic.msg.match(reg);\n                    if (res && res.length >= nwords) {\n                        res1 = Main.k.EliminateDuplicates(res);\n                        if (res.length == res1.length) matched = true;\n                    }\n                }\n\n                // Search in replies\n                for (var j=0; j<topic.replies.length && !matched && !topiconly; j++) {\n                    var m = topic.replies[j];\n                    autmatched = false;\n                    imatched = false;\n\n                    // Search by author\n                    if (authors.length > 0) {\n                        for (var l=0; l<authors.length; l++) {\n                            if (m.author == authors[l]) {\n                                autmatched = true;\n\n                                if (nwords == 0) matched = true;\n                            }\n                        }\n                    }\n\n                    // Ignored keywords\n                    if (iwords.length > 0) {\n                        reg = new RegExp( \"(\" + iwords.join(\"|\") + \")\", \"gi\");\n                        if (m.msg.match(reg)) {\n                            matched = false;\n                            imatched = true;\n                        }\n                    }\n\n                    // Search by keywords\n                    if (!imatched && lwords.length > 0 && (authors.length == 0 || autmatched)) {\n                        reg = new RegExp(words, \"gi\");\n                        res = m.msg.match(reg);\n                        if (res && res.length >= nwords) {\n                            res1 = Main.k.EliminateDuplicates(res);\n                            if (res.length == res1.length) matched = true;\n                        }\n                    }\n                }\n\n                if (matched) {\n                    matched_topics++;\n                    results.push(topic);\n                }\n            }\n        }\n\n        // Display results\n        if (results.length > 0) {\n            // Récap'\n            $(\"<p>\").addClass(\"warning\").html(Main.k.text.strargs(Main.k.text.ngettext(\"%1 résultat (maximum : %2).\",\"%1 résultats (maximum : %2).\",results.length),[results.length,max_results]))\n                .appendTo($searchresults);\n\n            // Display topics\n            for (i=0; i<results.length; i++) {\n                var topic = results[i];\n\n                var topicDOM = Main.k.Manager.parseTopic(topic, lwords);\n                $searchresults.append(topicDOM);\n\n                // Actions\n                $(\"<a>\").addClass(\"topicact\").attr(\"href\", \"#topic\" + topic.id)\n                    .on(\"click\", function() { Main.k.Manager.displayTopic(parseInt(/([0-9]+)/.exec(this.href)[1]), lwords); return false; })\n                    .html(Main.k.text.strargs(Main.k.text.ngettext(\"%1 réponse\",\"%1 réponses\",topic.replies.length),[topic.replies.length])).appendTo($searchresults);\n            }\n\n        } else if (authors.length >= 1 || lwords.length >= 1 || iwords.length >= 1) {\n            $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Aucun résultat.\")).appendTo($searchresults);\n        } else {\n            $(\"<p>\").addClass(\"warning\").html(Main.k.text.gettext(\"Le texte recherché est trop court.\")).appendTo($searchresults);\n        }\n    };\n    Main.k.Manager.searchHero = function(event) {\n        var tgt = $(event.target);\n        if (!tgt.attr(\"class\")) tgt = tgt.parent();\n        var hero = tgt.attr(\"class\").replace(\"hero _\" , \"\").replace(\"highlight\", \"\");\n\n        Main.k.Manager.selectTab($(\"#tabsearch\"));\n        $(\"#searchfield\").val(\"@\" + hero);\n        Main.k.Manager.search();\n    };\n\n    Main.k.Manager.replyloaded = false;\n    Main.k.Manager.fillReply = function() {\n        if (Main.k.Manager.replyloaded) {\n            // Update message content\n            if (Main.k.Manager.replywaiting != \"\") {\n                $(\"#tabreply_content\").find(\".tid_wallPost\").val(Main.k.Manager.replywaiting);\n                Main.k.Manager.replywaiting = \"\";\n            }\n        } else {\n            var newpost = $(\"#tabreply_content\").empty();\n            newpost.html(\"<div class='loading'><img src='http://twinoid.com/img/loading.gif' alt='Chargement' /> \"+Main.k.text.gettext(\"Chargement…\")+\"</div>\");\n            Main.k.LoadJS('/mod/wall/post', {_id: \"tabreply_content\"}, function() {\n                Main.k.Manager.replyloaded = true;\n\n                // Remove inactive tags\n                var $tabreply_content = $(\"#tabreply_content\");\n                $tabreply_content.find(\".tid_advanced\").remove();\n                $tabreply_content.find(\".tid_button\").remove();\n                $tabreply_content.find(\".tid_options\").remove();\n                $tabreply_content.find(\".tid_editorBut_question\").remove();\n                $tabreply_content.find(\".tid_editorBut__user\").remove();\n                // TODO: remove inactive tags in main chat\n\n                $tabreply_content.find(\" #tid_wallPost_preview\").attr(\"id\", \"\").addClass(\"tid_wallPost_preview\");\n                $tabreply_content.find(\" #tid_wallPost\").attr(\"id\", \"\").addClass(\"tid_wallPost\");\n\n                var preview = $tabreply_content.find(\".tid_wallPost_preview\").attr(\"id\", \"\").addClass(\"reply bubble\");\n                if (Main.k.Options.cbubbles) preview.addClass(\"bubble_\" + Main.k.ownHero);\n                if (Main.k.Options.cbubblesNB) preview.addClass(\"custombubbles_nobackground\");\n\n                var bubble = Main.k.ownHero;\n                $(\"<div>\").addClass(\"char \" + bubble).appendTo(preview);\n                $(\"<span>\").addClass(\"buddy\").html(Main.k.ownHero.replace('_',' ').capitalize() + \" : \").appendTo(preview);\n                $(\"<p>\").addClass(\"tid_preview tid_editorContent tid_wallPost_preview\").appendTo(preview);\n                $(\"<div>\").addClass(\"clear\").appendTo(preview);\n\n                // Actions\n                var buttons = $(\"<div>\").addClass(\"tid_buttons\").appendTo($tabreply_content);\n                var answer = Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/reply.png' /> \"+ Main.k.text.gettext(\"Répondre au topic\"),null,function() {\n                    var $tid_wallPost = $tabreply_content.find(\".tid_wallPost\");\n                    var val = $tid_wallPost.val();\n                    var k = Main.k.Manager.displayedTopic;\n                    Main.k.postMessage(k, val, Main.k.Manager.update);\n                    $tid_wallPost.val(\"\");\n\n                    Main.k.Manager.waitingforupdate = true;\n                    setTimeout(function() {\n                        if (Main.k.Manager.waitingforupdate) Main.k.Manager.update();\n                    }, 5000);\n                })\n                    .css({display: \"inline-block\", margin: \"4px 4px 8px\"})\n                    .appendTo(buttons)\n                    .find(\"a\")\n                    .attr(\"_title\", \"Répondre\").attr(\"_desc\", Main.k.text.gettext(\"Envoyer ce message en tant que réponse au topic affiché ci-contre.\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n\n                var newtopic = Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/reply.png' /> \" + Main.k.text.gettext(\"Nouveau topic\"),null,function() {\n                    var $tid_wallPost = $tabreply_content.find(\".tid_wallPost\");\n                    var val = $tid_wallPost.val();\n                    Main.k.newTopic(val, Main.k.Manager.update);\n                    $tid_wallPost.val(\"\");\n                })\n                    .css({display: \"inline-block\", margin: \"4px 4px 8px\"})\n                    .appendTo(buttons)\n                    .find(\"a\")\n                    .attr(\"_title\", \"Nouveau topic\").attr(\"_desc\", Main.k.text.gettext(\"Poster ce message en tant que nouveau topic.\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n\n\n                if(typeof(js.Lib.window[\"editor_tid_wallPost\"]) == 'undefined'){\n                    js.Lib.window[\"editor_tid_wallPost\"] = {};\n                }\n                // Modify preview\n                js.Lib.window[\"editor_tid_wallPost\"].preview = preview;\n\n                // Remove inactive icons\n                js.Lib.window[\"editor_tid_wallPost\"].loadSmileys = function(q) {\n                    var k;\n                    var _g = this;\n                    this.initIcons();\n                    if(this.smileysPanel.find(\".tid_active\").removeClass(\"tid_active\")[\"is\"](q)) return this.hideSmileys(true);\n                    this.hideSmileys(false);\n                    var cid = q.attr(\"tid_cat\");\n                    var cat = null;\n                    if(cid != \"_funtag\") {\n                        var $it0 = this.config.icons.iterator();\n\n                        while( $it0.hasNext() ) {\n                            /** @type {{category:string}} **/\n                            var c = $it0.next();\n                            if(c.category == cid) {\n                                cat = c;\n                                break;\n                            }\n                        }\n                        if(cat == null) return false;\n                    }\n                    var s = new StringBuf();\n                    s.b += \"<div class=\\\"tid_smileyPopUp\\\">\";\n                    if(cid == \"_funtag\") {\n                        s.b += Std.string(\"<div class=\\\"tid_title\\\">\" + this.config.funTitle + \"</div>\");\n                        var keys = [];\n                        var $it1 = this.config.fun.keys();\n                        while( $it1.hasNext() ) {\n                            k = $it1.next();\n                            keys.push(k);\n                        }\n                        keys.sort(function(a,b) {\n                            return Reflect.compare(a,b);\n                        });\n                        var _g1 = 0;\n                        while(_g1 < keys.length) {\n                            k = keys[_g1];\n                            ++_g1;\n                            s.b += Std.string(\"<a class=\\\"tid_fun\\\" href=\\\"#\\\" tid_s=\\\"\" + StringTools.htmlEscape(\"{\" + k + \"}\") + \"\\\"><img src=\\\"http://\" + _tid.host + \"/img/icons/\" + this.config.fun.get(k).i + \".png\\\" alt=\\\"\" + k + \"\\\" title=\\\"\" + StringTools.htmlEscape(this.config.fun.get(k).n) + \"\\\"/>\" + StringTools.htmlEscape(this.config.fun.get(k).n) + \"</a>\");\n                        }\n                    } else {\n                        s.b += Std.string(\"<div class=\\\"tid_title\\\">\" + cat.category + \"</div>\");\n                        s.b += \"<div class=\\\"tid_wrapper\\\">\";\n                        var $it2 = cat.icons.iterator();\n                        var a = true;\n                        while( $it2.hasNext() ) {\n                            var i = $it2.next();\n\n                            // Ignore incorrect icons\n                            if (cat.category == \"Mush\") {\n                                // Delete inactive icons\n                                if (i.image == \"/ui/o2.png\") continue;\n                                if (i.tag == \":mush_pa_gen:\") continue;\n                                if (i.tag == \":mush_pa_mov:\") continue;\n                                if (i.tag == \":mush_planet:\") continue;\n\n                                // Modify incorrect icons\n                                if (i.tag == \":mush_pa:\") {\n                                    i.tag = \":pa:\";\n                                    i.image = \"/img/icons/ui/pa_slot1.png\";\n                                } else if (i.tag == \":mush_pm:\") {\n                                    i.tag = \":pm:\";\n                                    i.image = \"/img/icons/ui/pa_slot2.png\";\n                                } else if (i.tag == \":mush_exp:\") {\n                                    i.tag = \":xp:\";\n                                    i.image = \"/img/icons/ui/xp.png\";\n                                }\n                            }\n\n                            var str = i.tag;\n                            var desc = i.tag;\n                            if(i.alt != null) {\n                                str = i.alt;\n                                desc = i.alt + \", \" + i.tag;\n                            }\n                            var mh = \"\";\n                            if(i.max != null) mh += \"<span class=\\\"tid_max tid_max_\" + i.tag.split(\":\").join(\"\") + \"\\\">\" + i.max + \"</span>\";\n                            s.b += Std.string(\"<a class=\\\"tid_smiley\\\" href=\\\"#\\\">\" + mh + \"<img src=\\\"\" + cat.url + i.image + \"\\\" tid_s=\\\"\" + StringTools.htmlEscape(str) + \"\\\" title=\\\"\" + StringTools.htmlEscape(desc) + \"\\\"/></a>\");\n                        }\n                        s.b += \"</div>\";\n                    }\n                    s.b += \"<div class=\\\"tid_clear\\\"></div>\";\n                    s.b += \"</div>\";\n                    q.addClass(\"tid_active\");\n                    var pop = $(s.b);\n                    q.parent().append(pop);\n                    pop.hide().slideDown(200);\n                    if(cid == \"_funtag\") pop.find(\"a.tid_fun\").click(function() {\n                        _g.insert($(this).attr(\"tid_s\"));\n                        return false;\n                    }); else pop.find(\"a.tid_smiley\").click(function() {\n                        var m = $(this).find(\".tid_max\");\n                        if(m.length > 0 && Std.parseInt(m.html()) == 0) return false;\n                        _g.insert($(this).find(\"img\").attr(\"tid_s\"));\n                        return false;\n                    });\n                    return false;\n                };\n\n                // Auto-load Mush icons\n                //$(\"#editor_tid_wallPost\").loadSmileys($(\"#editor_tid_wallPost a.tid_smcat[tid_cat='Mush']\"));\n\n                // Update message content\n                if (Main.k.Manager.replywaiting != \"\") {\n                    $tabreply_content.find(\".tid_wallPost\").val(Main.k.Manager.replywaiting);\n                    Main.k.Manager.replywaiting = \"\";\n                }\n            });\n        }\n    };\n\n    Main.k.Manager.customloaded = false;\n    Main.k.Manager.fillCustom = function() {\n        if (Main.k.Manager.customloaded) {\n            // Update message content\n            if (Main.k.Manager.replywaiting != \"\") {\n                $(\"#tabcustom_content\").find(\".tid_wallPost\").val(Main.k.Manager.replywaiting);\n                Main.k.Manager.replywaiting = \"\";\n            }\n        } else {\n\n            var newpost = $(\"#tabcustom_content\").empty();\n            newpost.html(\"<div class='loading'><img src='http://twinoid.com/img/loading.gif' alt='Chargement' /> \"+Main.k.text.gettext(\"Chargement…\")+\"</div>\");\n            Main.k.LoadJS('/mod/wall/post', {_id: \"tabcustom_content\"}, function() {\n                Main.k.Manager.customloaded = true;\n\n                // Remove inactive tags\n                var $tabcustom_content = $(\"#tabcustom_content\");\n                $tabcustom_content.find(\".tid_advanced\").remove();\n                $tabcustom_content.find(\".tid_button\").remove();\n                $tabcustom_content.find(\".tid_options\").remove();\n                $tabcustom_content.find(\".tid_editorBut_question\").remove();\n                $tabcustom_content.find(\".tid_editorBut__user\").remove();\n                // TODO: remove inactive tags in main chat\n\n                $tabcustom_content.find(\"#tid_wallPost_preview\").attr(\"id\", \"\").addClass(\"tid_wallPost_preview\");\n                $tabcustom_content.find(\"#tid_wallPost\").attr(\"id\", \"\").addClass(\"tid_wallPost\");\n\n                var preview = $tabcustom_content.find(\".tid_wallPost_preview\").addClass(\"reply bubble\");\n                if (Main.k.Options.cbubbles) preview.addClass(\"bubble_\" + Main.k.ownHero);\n                if (Main.k.Options.cbubblesNB) preview.addClass(\"custombubbles_nobackground\");\n\n                var bubble = Main.k.ownHero.replace(/(\\s)/g, \"_\").toLowerCase();\n                $(\"<div>\").addClass(\"char \" + bubble).appendTo(preview);\n                $(\"<span>\").addClass(\"buddy\").html(Main.k.ownHero.capitalize() + \" : \").appendTo(preview);\n                $(\"<p>\").addClass(\"tid_preview tid_editorContent tid_wallPost_preview\").appendTo(preview);\n                $(\"<div>\").addClass(\"clear\").appendTo(preview);\n\n                // Actions\n                var buttons = $(\"<div>\").addClass(\"tid_buttons\").appendTo($tabcustom_content);\n                var answer = Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/reply.png' /> \"+ Main.k.text.gettext(\"Répondre au topic\"),null,function() {\n                    var $tid_wallPost = $tabcustom_content.find(\".tid_wallPost\");\n                    var val = $tid_wallPost.val();\n                    var k = Main.k.Manager.displayedTopic;\n                    Main.k.postMessage(k, val, Main.k.Manager.update);\n                    $tid_wallPost.val(\"\");\n\n                    Main.k.Manager.waitingforupdate = true;\n                    setTimeout(function() {\n                        if (Main.k.Manager.waitingforupdate) Main.k.Manager.update();\n                    }, 5000);\n                })\n                    .css({display: \"inline-block\", margin: \"4px 4px 8px\"})\n                    .appendTo(buttons)\n                    .find(\"a\")\n                    .attr(\"_title\", \"Répondre\").attr(\"_desc\", Main.k.text.gettext(\"Envoyer ce message en tant que réponse au topic affiché ci-contre.\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n\n                var newtopic = Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/reply.png' /> \" + Main.k.text.gettext(\"Nouveau topic\"),null,function() {\n                    var $tid_wallPost = $tabcustom_content.find(\".tid_wallPost\");\n                    var val = $tid_wallPost.val();\n                    Main.k.newTopic(val, Main.k.Manager.update);\n                    $tid_wallPost.val(\"\");\n                })\n                    .css({display: \"inline-block\", margin: \"4px 4px 8px\"})\n                    .appendTo(buttons)\n                    .find(\"a\")\n                    .attr(\"_title\", \"Nouveau topic\").attr(\"_desc\", Main.k.text.gettext(\"Poster ce message en tant que nouveau topic.\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n\n                var addmsg = Main.k.MakeButton(\"<img src='http://mush.vg/img/icons/ui/fav.png' /> \" + Main.k.text.gettext(\"Ajouter aux favoris\"),null,function() {\n                    var $tid_wallPost = $tabcustom_content.find(\".tid_wallPost\");\n                    var message = $tid_wallPost.val();\n                    Main.k.CreateNeronPrompt();\n                    $(\"#validate\").click(function(){\n                        var title = $(\"#neron_alert_content\").find(\"input\").val();\n                        Main.k.ClosePopup();\n                        try{\n                            Main.k.Manager.addMsgPrerecorded(title,message);\n                        }\n                        catch(e){\n                            if(e.name == \"MessageAlreadyExist\"){\n                                Main.k.CreateNeronAlert(Main.k.text.gettext(\"Le message existe déjà.\"));\n                            }\n                            else if(e.name == \"TitleEmpty\"){\n                                Main.k.CreateNeronAlert(Main.k.text.gettext(\"Le titre est vide.\"));\n                            }\n                            else if(e.name == \"MessageEmpty\"){\n                                Main.k.CreateNeronAlert(Main.k.text.gettext(\"Le message est vide.\"));\n                            }\n                            else if(Main.k.debug){\n                                Main.k.treatingBug(e);\n                            }\n                        }\n                    });\n\n                })\n                    .css({display: \"inline-block\", margin: \"4px 4px 8px\"})\n                    .appendTo(buttons)\n                    .find(\"a\")\n                    .attr(\"_title\", \"Ajouter aux favoris\").attr(\"_desc\", Main.k.text.gettext(\"Ajouter un message à votre liste des messages pré-enregistrés.\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n\n                var delmsg = Main.k.MakeButton(\"<img src='http://mush.vg/img/icons/ui/bin.png' /> \" + Main.k.text.gettext(\"Supprimer un favori\"),null,function() {\n                    try{\n                        var title = $tabcustom_content.find(\".array_messages_prerecorded .selected\").text();\n                        Main.k.Manager.delMsgPrerecorded( title );\n                    }\n                    catch(e){\n                        if(e.name == \"MessageNotExist\"){\n                            Main.k.CreateNeronAlert(Main.k.text.gettext(\"Le message que vous voulez supprimer n'existe pas.\"));\n                        }\n                        else if(Main.k.debug){\n                            Main.k.treatingBug(e);\n                        }\n                    }\n                })\n                    .css({display: \"inline-block\", margin: \"4px 4px 8px\"})\n                    .appendTo(buttons)\n                    .find(\"a\")\n                    .attr(\"_title\", \"Supprimer un favori\").attr(\"_desc\", Main.k.text.gettext(\"Supprimer une message de votre liste des messges pré-enregistrés.\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n\n                if(typeof(js.Lib.window[\"editor_tid_wallPost\"]) == 'undefined'){\n                    js.Lib.window[\"editor_tid_wallPost\"] = {};\n                }\n                // Modify preview\n                js.Lib.window[\"editor_tid_wallPost\"].preview = preview;\n\n                // Remove inactive icons\n                js.Lib.window[\"editor_tid_wallPost\"].loadSmileys = function(q) {\n                    var k;\n                    var _g = this;\n                    this.initIcons();\n                    if(this.smileysPanel.find(\".tid_active\").removeClass(\"tid_active\")[\"is\"](q)) return this.hideSmileys(true);\n                    this.hideSmileys(false);\n                    var cid = q.attr(\"tid_cat\");\n                    var cat = null;\n                    if(cid != \"_funtag\") {\n                        var $it0 = this.config.icons.iterator();\n\n                        while( $it0.hasNext() ) {\n                            /** @type {{category:string}} **/\n                            var c = $it0.next();\n                            if(c.category == cid) {\n                                cat = c;\n                                break;\n                            }\n                        }\n                        if(cat == null) return false;\n                    }\n                    var s = new StringBuf();\n                    s.b += \"<div class=\\\"tid_smileyPopUp\\\">\";\n                    if(cid == \"_funtag\") {\n                        s.b += Std.string(\"<div class=\\\"tid_title\\\">\" + this.config.funTitle + \"</div>\");\n                        var keys = [];\n                        var $it1 = this.config.fun.keys();\n                        while( $it1.hasNext() ) {\n                            k = $it1.next();\n                            keys.push(k);\n                        }\n                        keys.sort(function(a,b) {\n                            return Reflect.compare(a,b);\n                        });\n                        var _g1 = 0;\n                        while(_g1 < keys.length) {\n                            k = keys[_g1];\n                            ++_g1;\n                            s.b += Std.string(\"<a class=\\\"tid_fun\\\" href=\\\"#\\\" tid_s=\\\"\" + StringTools.htmlEscape(\"{\" + k + \"}\") + \"\\\"><img src=\\\"http://\" + _tid.host + \"/img/icons/\" + this.config.fun.get(k).i + \".png\\\" alt=\\\"\" + k + \"\\\" title=\\\"\" + StringTools.htmlEscape(this.config.fun.get(k).n) + \"\\\"/>\" + StringTools.htmlEscape(this.config.fun.get(k).n) + \"</a>\");\n                        }\n                    } else {\n                        s.b += Std.string(\"<div class=\\\"tid_title\\\">\" + cat.category + \"</div>\");\n                        s.b += \"<div class=\\\"tid_wrapper\\\">\";\n                        var $it2 = cat.icons.iterator();\n                        var a = true;\n                        while( $it2.hasNext() ) {\n                            var i = $it2.next();\n\n                            // Ignore incorrect icons\n                            if (cat.category == \"Mush\") {\n                                // Delete inactive icons\n                                if (i.image == \"/ui/o2.png\") continue;\n                                if (i.tag == \":mush_pa_gen:\") continue;\n                                if (i.tag == \":mush_pa_mov:\") continue;\n                                if (i.tag == \":mush_planet:\") continue;\n\n                                // Modify incorrect icons\n                                if (i.tag == \":mush_pa:\") {\n                                    i.tag = \":pa:\";\n                                    i.image = \"/img/icons/ui/pa_slot1.png\";\n                                } else if (i.tag == \":mush_pm:\") {\n                                    i.tag = \":pm:\";\n                                    i.image = \"/img/icons/ui/pa_slot2.png\";\n                                } else if (i.tag == \":mush_exp:\") {\n                                    i.tag = \":xp:\";\n                                    i.image = \"/img/icons/ui/xp.png\";\n                                }\n                            }\n\n                            var str = i.tag;\n                            var desc = i.tag;\n                            if(i.alt != null) {\n                                str = i.alt;\n                                desc = i.alt + \", \" + i.tag;\n                            }\n                            var mh = \"\";\n                            if(i.max != null) mh += \"<span class=\\\"tid_max tid_max_\" + i.tag.split(\":\").join(\"\") + \"\\\">\" + i.max + \"</span>\";\n                            s.b += Std.string(\"<a class=\\\"tid_smiley\\\" href=\\\"#\\\">\" + mh + \"<img src=\\\"\" + cat.url + i.image + \"\\\" tid_s=\\\"\" + StringTools.htmlEscape(str) + \"\\\" title=\\\"\" + StringTools.htmlEscape(desc) + \"\\\"/></a>\");\n                        }\n                        s.b += \"</div>\";\n                    }\n                    s.b += \"<div class=\\\"tid_clear\\\"></div>\";\n                    s.b += \"</div>\";\n                    q.addClass(\"tid_active\");\n                    var pop = $(s.b);\n                    q.parent().append(pop);\n                    pop.hide().slideDown(200);\n                    if(cid == \"_funtag\") pop.find(\"a.tid_fun\").click(function() {\n                        _g.insert($(this).attr(\"tid_s\"));\n                        return false;\n                    }); else pop.find(\"a.tid_smiley\").click(function() {\n                        var m = $(this).find(\".tid_max\");\n                        if(m.length > 0 && Std.parseInt(m.html()) == 0) return false;\n                        _g.insert($(this).find(\"img\").attr(\"tid_s\"));\n                        return false;\n                    });\n                    return false;\n                };\n\n                // Auto-load Mush icons\n                //$(\"#editor_tid_wallPost\").loadSmileys($(\"#editor_tid_wallPost a.tid_smcat[tid_cat='Mush']\"));\n\n\n                var array_msg = $(\"<p>\").addClass(\"array_messages_prerecorded\").prependTo( $tabcustom_content );\n\n                var messages_prerecorded = [];\n                if(Main.k.Manager.msgs_prerecorded != undefined ){\n                    messages_prerecorded = Main.k.Manager.msgs_prerecorded;\n                }\n\n                for(var idMsg = 0;idMsg<messages_prerecorded.length;idMsg++){\n                    $(\"<span>\"+ messages_prerecorded[idMsg][0] +\"</span>\").addClass(\"message_prerecorded\")\n                        .appendTo(array_msg)\n                        .click(function(){\n                            if($(this).is(\".selected\")){\n                                $tabcustom_content.find(\".array_messages_prerecorded .selected\").removeClass(\"selected\");\n                                $tabcustom_content.find(\".tid_wallPost\").val(\"\");\n                            }else {\n                                $tabcustom_content.find(\".array_messages_prerecorded .selected\").removeClass(\"selected\");\n                                $(this).addClass(\"selected\");\n\n                                var msgPrerecorded = \"\";\n                                try{\n                                    msgPrerecorded = Main.k.Manager.getMsgPrerecorded($(this).text());\n                                }catch(e){\n                                    if(Main.k.debug){\n                                        Main.k.treatingBug(e);\n                                    }\n                                }\n                                $tabcustom_content.find(\".tid_wallPost\").val(msgPrerecorded);\n                            }\n                        });\n                }\n            });\n\n            // Update message content\n            if (Main.k.Manager.replywaiting != \"\") {\n                newpost.find(\".tid_wallPost\").val(Main.k.Manager.replywaiting);\n                Main.k.Manager.replywaiting = \"\";\n            }\n        }\n    };\n\n    Main.k.Manager.initHeroes = function() {\n        Main.k.Manager.heroes[\"neron\"] = { name: \"neron\", mess: 0, av: 0, a: 0 };\n        for (var i=0; i<Main.k.HEROES.length; i++) {\n            Main.k.Manager.heroes[Main.k.HEROES[i]] = { name: Main.k.HEROES[i], mess: 0, topic: 0 };\n        }\n    };\n    Main.k.Manager.waitingforupdate = false;\n    Main.k.Manager.update = function() {\n        Main.k.Manager.waitingforupdate = false;\n        Main.k.Manager.initHeroes();\n        Main.k.Manager.parseWall($(\".cdWallChannel\"));\n        Main.k.Manager.fillStats();\n        Main.k.Manager.fillNewFav();\n        Main.k.Manager.fillWall();\n        Main.k.Manager.fillSearch();\n        Main.k.Manager.fillReply();\n        Main.k.Manager.fillCustom();\n\n        // Update current displayed topic\n        if (Main.k.Manager.displayedTopic) {\n            Main.k.Manager.displayTopic(Main.k.Manager.getTopicByTid(Main.k.Manager.displayedTopic).id);\n        }\n    };\n    Main.k.Manager.selectTopic = function(k) {\n        var tid = Main.k.Manager.getTopicByTid(k).id;\n        Main.k.Manager.displayTopic(tid);\n    };\n\n    Main.k.Manager.msgs_prerecorded = [];\n    Main.k.Manager.getMsgPrerecorded = function(title){\n        var messages_prerecorded = [];\n        if(this.msgs_prerecorded != undefined){\n            messages_prerecorded = this.msgs_prerecorded ;\n        }\n\n        for(var idMsg = 0;idMsg < messages_prerecorded.length;idMsg++){\n            if(title == messages_prerecorded[idMsg][0]){\n                return messages_prerecorded[idMsg][1];\n            }\n        }\n\n        throw new this.Exception(\"MessageNotExist\");\n    };\n    Main.k.Manager.addMsgPrerecorded = function(title, message) {\n        if(title == \"\" || title == undefined){\n            throw new this.Exception(\"TitleEmpty\");\n        }\n        else if(message == \"\"){\n            throw new this.Exception(\"MessageEmpty\");\n        }\n\n        var messages_prerecorded = [];\n        if(this.msgs_prerecorded != undefined){\n            messages_prerecorded = this.msgs_prerecorded ;\n        }\n\n        for(var idMsg = 0;idMsg < messages_prerecorded.length;idMsg++){\n            if(title == messages_prerecorded[idMsg][0]){\n                throw new this.Exception(\"MessageAlreadyExist\");\n            }\n        }\n\n        messages_prerecorded.push([title,message]);\n        this.msgs_prerecorded = messages_prerecorded;\n        this.saveMsgsPrerecorded();\n        this.customloaded = false;\n        this.fillCustom();\n    };\n    Main.k.Manager.delMsgPrerecorded = function(title) {\n        var messages_prerecorded = [];\n        var isFound = false;\n        if(this.msgs_prerecorded != undefined){\n            messages_prerecorded = this.msgs_prerecorded ;\n        }\n        for(var idMsg = 0;idMsg < messages_prerecorded.length;idMsg++){\n            if(title == messages_prerecorded[idMsg][0]){\n                messages_prerecorded.splice(idMsg,1);\n                isFound = true;\n            }\n        }\n\n        if(isFound){\n            this.msgs_prerecorded = messages_prerecorded;\n            this.saveMsgsPrerecorded();\n            this.customloaded = false;\n            this.fillCustom();\n        }\n        else{\n            throw new this.Exception(\"MessageNotExist\");\n        }\n    };\n    Main.k.Manager.loadMsgsPrerecorded = function(msgs_prerecorded,json) {\n        var msgs_prerecorded_json;\n        if(typeof(msgs_prerecorded) != 'undefined') {\n            if (typeof(json) != 'undefined' && !json) {\n                msgs_prerecorded_json = JSON.stringify(msgs_prerecorded);\n            } else {\n                msgs_prerecorded_json = msgs_prerecorded;\n                msgs_prerecorded = JSON.parse(msgs_prerecorded);\n            }\n            this.msgs_prerecorded = msgs_prerecorded;\n            localStorage.setItem(\"ctrlw_msgs_prerecorded\", msgs_prerecorded_json);\n        }else{\n            msgs_prerecorded_json = localStorage.getItem(\"ctrlw_msgs_prerecorded\");\n            if(msgs_prerecorded_json != null){\n                this.msgs_prerecorded = JSON.parse(msgs_prerecorded_json);\n            }\n        }\n    };\n    Main.k.Manager.saveMsgsPrerecorded = function() {\n        localStorage.setItem(\"ctrlw_msgs_prerecorded\",JSON.stringify(Main.k.Manager.msgs_prerecorded));\n        callbacks_storage_sync.fire();\n    };\n\n    Main.k.Manager.Exception = function(name){\n        this.name = name;\n    };\n    // == /MessageManager =========================================\n\n\n\n\n    Main.k.AliveHeroes = [];\n    Main.k.MushInit = function() {\n        console.log('MushInit');\n        var cook_session = js.Cookie.get(\"ctrlwsession\");\n        var sid = js.Cookie.get(\"sid\");\n        if(typeof(sid) == 'undefined'){\n            sid = js.Cookie.get(\"mush_sid\");\n        }\n        if(typeof(cook_session) == 'undefined' || sid.hashCode() != cook_session){\n            Main.k.Sync.pull();\n            localStorage.removeItem('ctrlw_newgame');\n        }\n        js.Cookie.set(\"ctrlwsession\",sid.hashCode(),420000000);\n\n        Main.k.Profiles.load();\n        Main.k.Manager.loadMsgsPrerecorded();\n        Main.k.AliveHeroes = [];\n        Main.k.GameInfos.init();\n        Main.k.MushInitHeroes();\n\n        var $content = $(\"#content\");\n        // Handle Mush Logo (option)\n        if (Main.k.Options.dlogo) {\n            $content.css({ position: \"absolute\", top: \"120px\", left: \"125px\" });\n            $content.find(\"[class^=logo]\").css({ top: \"-100px\" });\n            $(\"body\").css(\"background-position\", \"50% 20px\");\n        } else {\n            $content.css({ position: \"absolute\", top: \"40px\", left: \"125px\" });\n            $content.find(\"[class^=logo]\").css({ display: \"none\" });\n        }\n        var vending = $(\".butmini.distr\").css(\"display\", \"none\");\n        if (vending.length > 0) {\n            $(\"#vendingmenu\").css(\"display\", \"inline\");\n        }\n\n        // Add left bar\n        // ----------------------------------- //\n        var leftbar = $(\"<div>\").addClass(\"usLeftbar\").insertBefore($content);\n        Main.k.MakeButton(\"<img src='\" + Main.k.servurl + \"/img/ctrlw_sml.png' height='16' /> \" + Main.k.version, null, Main.k.About.open, Main.k.text.gettext(\"à propos\").capitalize(), Main.k.text.gettext(\"Cliquez ici pour plus d'informations sur le script.\")).css({\n            display: \"inline-block\",\n            margin: \"0 auto 10px\"\n        }).appendTo($(\"<div>\").css(\"text-align\", \"center\").appendTo(leftbar));\n        // ----------------------------------- //\n\n        // Sync Push on leave\n        // ----------------------------------- //\n        $(window).bind('beforeunload', function(event){\n            console.warn('beforeunload',Main.k.Sync.push_timer);\n            if(Main.k.Sync.push_timer != null){\n                return Main.k.text.gettext(\"CTRL+W : Veuillez attendre la fin de la synchronisation avant de quitter cette page.\");\n            }\n\n        });\n        // ----------------------------------- //\n\n        // Misc tools\n        // ----------------------------------- //\n        $(\"<h3>\").addClass(\"first\").html(Main.k.text.gettext(\"outils\").capitalize()).appendTo(leftbar);\n\n        // Update Manager\n        Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/new.png' /> \" + Main.k.text.gettext(\"Mise à jour\"), null, null, Main.k.text.gettext(\"Mise à jour du script\"),\n            \"Une nouvelle version du script CTRL+W est disponible.\")\n            .appendTo(leftbar).attr(\"id\", \"updatebtn\").css(\"display\", \"none\").find(\"a\").on(\"mousedown\", Main.k.UpdateDialog);\n\n\n        //Integration with others scripts\n        $(window).load(function () {\n            setTimeout(function () {\n                var $mushUSMenu = $('#mushUSMenu');\n                //Mush Helper script\n                if ($mushUSMenu.length > 0) {\n                    var wrapper_mhs = $mushUSMenu.parents(\":eq(2)\");\n                    wrapper_mhs.css('left', '-' + (wrapper_mhs.width()) + 'px');\n                    var arrow = wrapper_mhs.find('.arrowright');\n                    arrow.attr('class', 'arrowleft');\n                    arrow.off('click');\n                    arrow.toggle(function () {\n                        wrapper_mhs.animate({left: 0}, 500);\n                    }, function () {\n                        wrapper_mhs.animate({left: '-' + wrapper_mhs.width() + 'px'}, 500);\n                    });\n\n                    Main.k.MakeButton(\"<img src='http://mush.twinoid.com/img/icons/ui/talkie.png' style='vertical-align: -20%' /> \" + 'MHS', null, null, 'Mush Helper Script'\n                    ).insertAfter($('#updatebtn')).find(\"a\").on(\"mousedown\", function () {\n                            wrapper_mhs.find('.arrowleft').trigger('click');\n                        });\n                }\n\n                var s_astro_icon = '';\n                if ($('#astro_maj_inventaire').length > 0) {\n                    var img_astro = $('<img class=\"\" src=\"/build/img/icons/ui/pa_comp.png\" height=\"14\"/>');\n                    var $share_inventory_button = $('#share-inventory-button');\n                    $share_inventory_button.find('a img').remove();\n                    $share_inventory_button.find('a').prepend(img_astro);\n                    img_astro.addClass('blink-limited');\n\n                }\n\n            }, 10);\n\n        });\n\n        // Message Manager\n        Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/archive.png' style='vertical-align: -20%' /> \"+ Main.k.text.gettext(\"Msg Manager\"), null, null, Main.k.text.gettext(\"Message Manager\"),\n            Main.k.text.gettext(\"Ne manquez plus de messages ! Tous les topics avec des messages non lus seront mis en évidence, et vous pourrez effectuer des recherches par auteur ou contenu.\"))\n            .appendTo(leftbar).find(\"a\").on(\"mousedown\", Main.k.Manager.open);\n\n        // Options Manager\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/pa_eng.png' style='vertical-align: -20%' /> \"+ Main.k.text.gettext(\"Options\"), null, null, Main.k.text.gettext(\"Gérer les options\"), Main.k.text.gettext(\"Certaines fonctionnalitées de Ctrl+W sont configurables. Cliquez ici pour spécifier vos préférences.\"))\n            .appendTo(leftbar).find(\"a\").on(\"mousedown\", Main.k.Options.open);\n\n        // Sync Manager\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/comm.png' style='vertical-align: -20%' class=\\\"ctrlw_normal\\\"/>\" +\n            \"<img src='http://imgup.motion-twin.com/twinoid/a/c/1d84a74e_4030.jpg' style='vertical-align: -20%;display:none' class=\\\"ctrlw_down\\\" />\" +\n            \"<img src='http://imgup.motion-twin.com/twinoid/8/f/0c596094_4030.jpg' style='vertical-align: -20%;display:none' class=\\\"ctrlw_up\\\" /> \"+\n            \"<img src='http://imgup.motion-twin.com/twinoid/3/a/830c06f5_4030.jpg' style='vertical-align: -20%;display:none' class=\\\"ctrlw_wheels\\\" /> \"+\n            '<span class=\"txt\">' + Main.k.text.gettext(\"Sync\") + '</span> <span class=\"counter\"></span>', null, null, Main.k.text.gettext(\"Sync\"), Main.k.text.gettext(\"Permet de synchroniser les données du script entre vos différents navigateurs\")\n        )\n            .attr('id','ctrlw_sync_button')\n            .appendTo(leftbar).find(\"a\").on(\"mousedown\", Main.k.Sync.display);\n\n        // Page reloader\n        Main.k.MakeButton(\"<img src='http://twinoid.com/img/icons/refresh.png' style='vertical-align: -20%' /> \"+ Main.k.text.gettext(\"Actualiser\"), null, null, Main.k.text.gettext(\"Actualiser\"),\n            Main.k.text.gettext(\"Actualiser la page sans tout recharger. <strong>Fonctionnalité en cours d'optimisation.</strong>\"))\n            .appendTo(leftbar).find(\"a\").on(\"mousedown\", function() {\n                // TODO: loading screen -- Optimize\n\n                Main.refreshChat();\n                Main.acListMaintainer.refresh(true);\n                Main.syncInvOffset(null,true);\n                Main.doChatPacks();\n                Main.topChat();\n                Main.onChanDone(ChatType.Local[1],true)\n            });\n\n        Main.k.MakeButton(Main.k.text.gettext(\"Nouvelle partie ?\"), null, null, Main.k.text.gettext(\"Nouvelle partie\"),\n            Main.k.text.gettext(\"Vous venez de commencer une nouvelle partie ? Utilisez ce bouton pour supprimer les informations de votre ancienne partie\"))\n            .attr('id', 'button_new_game')\n            .appendTo(leftbar).find(\"a\").on(\"mousedown\", function () {\n                if (confirm(Main.k.text.gettext(\"Êtes vous sûr de vouloir effacer les informations de la partie précédente ?\"))) {\n                    localStorage.removeItem('ctrlw_newgame');\n                    Main.k.Profiles.clear();\n                    Main.k.GameInfos.clear();\n                    Main.k.MushUpdate();\n                    //$('#button_new_game').remove();\n                }\n\n            });\n        // ----------------------------------- //\n\n        // Exploration\n        // ----------------------------------- //\n        $(\"<div>\").attr(\"id\", \"expblock\").appendTo(leftbar);\n        // ----------------------------------- //\n\n        // Heroes' titles\n        // ----------------------------------- //\n        var t = $('<h3 class=\"titles_title\"></h3>').html(Main.k.text.gettext(\"titres\").capitalize()).appendTo(leftbar);\n        $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \"#titles_list\").appendTo(t).on(\"click\", Main.k.ToggleDisplay);\n        $(\"<div>\").addClass(\"titles_list\").attr(\"id\", \"titles_list\").appendTo(leftbar);\n        // ----------------------------------- //\n\n\n        // Heroes\n        // ----------------------------------- //\n        t = $(\"<h3>\").html(Main.k.text.gettext(\"Présent(s)\").capitalize()).appendTo(leftbar);\n        $(\"<span>\").addClass(\"displaymore\").attr(\"_target\", \"#heroes_list\").appendTo(t).on(\"click\", Main.k.ToggleDisplay);\n        $(\"<div>\").attr(\"id\", \"heroes_list\").css(\"display\", \"none\").appendTo(leftbar);\n        t = $(\"<h3>\").html(Main.k.text.gettext(\"équipage\").capitalize()).appendTo(leftbar);\n        $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \"#crew_list\").appendTo(t).on(\"click\", Main.k.ToggleDisplay);\n        $(\"<div>\").attr(\"id\", \"crew_list\").css(\"display\", \"block\").appendTo(leftbar);\n        // ----------------------------------- //\n\n\n        // Inventory\n        // ----------------------------------- //\n        t = $(\"<h3>\").html(Main.k.text.gettext(\"inventaire\").capitalize()).appendTo(leftbar);\n        $(\"<span>\").addClass(\"displaymore\").attr(\"_target\", \".kobject_list\").appendTo(t).on(\"click\", Main.k.ToggleDisplay);\n        $(\"<div>\").addClass(\"inventory kobject_list\").css(\"display\", \"none\").appendTo(leftbar);\n        $(\"<div>\").css({\"clear\": \"both\", \"height\": \"5px\"}).appendTo(leftbar);\n\n        // Inventory actions\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \" + Main.k.text.gettext(\"Partager\") , null, null, Main.k.text.gettext(\"Partager l'inventaire\"),\n            Main.k.text.gettext(\"<p>Insère l'inventaire de la pièce dans la zone de texte active, de la forme&nbsp;:</p><p><strong>Couloir central :</strong> <i>Combinaison</i>, <i>Couteau</i>, <i>Médikit</i>, <i>Extincteur</i></p><p><strong>Partage aussi sur Astropad si celui-ci est installé.</strong></p>\")\n        ).appendTo(leftbar)\n            .attr('id','share-inventory-button')\n            .find(\"a\").on(\"mousedown\", function(e) {\n                Main.k.SyncAstropad(e);\n                $('textarea:focus').each(function(e) {\n                    var txt = Main.k.FormatInventory();\n                    $(this).insertAtCaret(txt);\n                });\n                return false;\n            });\n        Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+ Main.k.text.gettext(\"Consommables\"), null, null, Main.k.text.gettext(\"Partager les effets des consommables\"),\n            Main.k.text.gettext(\"Insère la liste des consommables avec leurs effets dans la zone de texte active, de la forme&nbsp;:</p><p>TODO: aperçu</p>\"))\n            .attr(\"id\", \"pharmashare\").css(\"display\", \"none\").appendTo(leftbar)\n            .find(\"a\").on(\"mousedown\", function(e) {\n                $('textarea:focus').each(function(e) {\n                    var txt = Main.k.FormatPharma();\n                    $(this).insertAtCaret(txt);\n                });\n                return false;\n            });\n        //Main.k.MakeButton(\"<img src='/img/icons/ui/notes.gif' /> Daedalus\", null, null, Main.k.text.gettext(\"Inventaire complet\"),\n        //\t\"Affiche l'inventaire complet du Daedalus, pièce par pièce.</p><p><strong>/!&#92; Fonctionnalité non codée</strong>\").appendTo(leftbar);\n        // ----------------------------------- //\n\n        // Fix \"o²\"\n        var $spaceshipstatus_li = $(\".spaceshipstatus li\");\n        $spaceshipstatus_li.first().attr(\"onmouseover\", $spaceshipstatus_li.first().attr(\"onmouseover\").replace(/\\(o²\\)\\s+/g, \"\"));\n\n        // Lab - Nexus - Pilgred - Plants - Planets\n        // ----------------------------------- //\n        $(\"<div>\").attr(\"id\", \"project_list\").appendTo(leftbar);\n        // ----------------------------------- //\n    };\n    Main.k.MushAfterInit = function() {\n        console.info('Main.k.MushAfterInit',$().jquery);\n\n        // Fix dimensions\n        Main.k.Resize();\n        $(window).resize(Main.k.Resize);\n        $(\"#chatBlock\").on(\"resize\", Main.k.Resize);\n    };\n    Main.k.onCycleChange = function(){\n        // Script updates\n        // ----------------------------------- //\n        localStorage.removeItem('ctrlw_update_cache');\n        localStorage.removeItem('ctrlw_remaining_cycles',0);\n        // ----------------------------------- //\n    };\n    Main.k.MushUpdate = function() {\n        console.log('mushupdate');\n\n        // Events\n        // ----------------------------------- //\n        $('#swf_ISO_MODULE').off('mousedown');\n        $('#swf_ISO_MODULE').on('mousedown',function(){\n            $('.kobject_list .selected').remove();\n            if($('#cdInventory').is('.placard_on')){\n                Main.closet.hide();\n            }\n        });\n\n        var $wall_chatbox = $('#wall').find('.chatbox');\n        $wall_chatbox.off('focus');\n        $wall_chatbox.on('focus',function(){\n            Main.k.extend.onChatFocus($(this),$(this).attr('id').replace(/[^0-9]+/,\"\"));\n        });\n\n        var $wall_replybox = $('.cdReplyBlock .chatbox');\n        $wall_replybox.off('focus');\n        $wall_replybox.on('focus',Main.k.extend.onWallFocus);\n        $wall_replybox.off('keydown input');\n        $wall_replybox.removeAttr('onkeydown');\n        $wall_replybox.on('keydown', Main.k.extend.onWallInput);\n        $wall_replybox.on('input', function(){\n            Tools.send2Store(\"mush_wallReply_\" + $(this).attr(\"id\"),$(this).val());\n        });\n\n        var $chatbox = $('#privateform .chatbox, #wall .chatbox');\n        $chatbox.off('keydown input');\n        $chatbox.removeAttr('onkeydown');\n        $chatbox.on('keydown', Main.k.extend.onChatInput);\n        $chatbox.on('input', function(){\n            Tools.send2Store(\"mush_chatContent_\" + $(this).attr(\"id\"),$(this).val());\n        });\n\n        var $chatBlock = $('#chatBlock');\n        $chatBlock.off('scroll');\n        $chatBlock.on('scroll',Main.k.extend.onChatScroll);\n\n        /** @type {{surname:string,statuses:List, titles:List, dev_surname:string, spores:string}} **/\n        var hero;\n        var bubble, t, i, j;\n        var $usLeftbar = $(\".usLeftbar\");\n        Main.k.hasTalkie = $(\"#walltab\").length > 0;\n\n        // Never hide unread msg\n        $(\"table.treereply tr.not_read.cdRepl\").css(\"display\", \"table-row\");\n\n        // Day and cycle save\n        var cycle_time = $('.cycletime');\n        if(cycle_time.length > 0){\n            var regex = new RegExp(\"\\\\D+([0-9]{1,2}).*-.*([0-9]{1})\");\n            var result = regex.exec(cycle_time.text());\n            if(result != null){\n                Main.k.Game.updateDayAndCycle(result[1],result[2]);\n            }\n\n\n        }\n\n        // Script updates\n        // ----------------------------------- //\n        Main.k.UpdateCheck();\n        // ----------------------------------- //\n        var $player_status = $('#player_status');\n        if($player_status.length == 0){\n            $player_status = $('<div id=\"player_status\" style=\"position: absolute;right:6px;bottom:0\"><img src=\"'+Main.k.statusImages['bronze']+'\" alt=\"Bronze\" title=\"Bronze\" /></div>').appendTo('.sheetmain');\n        }\n        $player_status.html('<img src=\"'+Main.k.statusImages[Main.k.Game.data.player_status]+'\" alt=\"'+Main.k.Game.data.player_status.capitalize()+'\" title=\"'+Main.k.Game.data.player_status.capitalize()+'\" />');\n        Main.k.displayRemainingCyclesToNextLevel();\n\n        // Titles\n        // ----------------------------------- //\n        /** @type {{skills:List}} **/\n        // Display title list\n        var o_hero;\n        var maxshown = 4;\n        var titles_list = $(\"#titles_list\");\n        titles_list.empty();\n\n        // Commanders\n        var commanders = $(\"<div>\").appendTo(titles_list);\n        $(\"<img>\").addClass(\"icon\").attr(\"src\", \"/img/icons/ui/title_01.png\")\n            /* Translators: This translation must be copied from the game. */\n            .attr(\"_title\", Main.k.text.gettext(\"Commandant\"))\n            /* Translators: This translation must be copied from the game. */\n            .attr(\"_desc\", Main.k.text.gettext(\"Le Commandant décide des planètes que le Daedalus explorera.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .appendTo(commanders);\n        var commander_nb = 0;\n        for (i=0; commander_nb<maxshown && i<Main.k.COMMANDERS.length; i++) {\n            hero = Main.k.COMMANDERS[i];\n            if($.inArray(hero,Main.k.HEROES) != -1) {\n                o_hero = Main.k.Profiles.get(hero);\n                if (!Main.k.Profiles.hasStatusWhichRemoveTitle(o_hero)) {\n                    commander_nb++;\n                    $(\"<img>\")\n                        .addClass(\"body \" + hero)\n                        .attr(\"src\", \"/img/design/pixel.gif\")\n                        .css(\"cursor\", \"pointer\")\n                        .data('dev_surname',hero)\n                        .on('click',function(){\n                            Main.k.Profiles.display($(this).data('dev_surname'));\n                        })\n                        .appendTo(commanders);\n                }\n            }\n        }\n\n        // Admins\n        var admins = $(\"<div>\").appendTo(titles_list);\n        $(\"<img>\").addClass(\"icon\").attr(\"src\", \"/img/icons/ui/title_02.png\")\n            /* Translators: This translation must be copied from the game. */\n            .attr(\"_title\", Main.k.text.gettext(\"Administrateur NERON\"))\n            /* Translators: This translation must be copied from the game. */\n            .attr(\"_desc\", Main.k.text.gettext(\"Le responsable NERON semble avoir une certaine influence auprès de l'ordinateur de bord. Il est notamment le seul à avoir la possibilité de transmettre des messages à tout l'équipage.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .appendTo(admins);\n        var admin_nb = 0;\n        for (i=0; admin_nb<maxshown && i<Main.k.ADMINS.length; i++) {\n            hero = Main.k.ADMINS[i];\n            if($.inArray(hero,Main.k.HEROES) != -1) {\n                o_hero = Main.k.Profiles.get(hero);\n                if (!Main.k.Profiles.hasStatusWhichRemoveTitle(o_hero)) {\n                    admin_nb++;\n                    $(\"<img>\")\n                        .addClass(\"body \" + hero)\n                        .attr(\"src\", \"/img/design/pixel.gif\")\n                        .css(\"cursor\", \"pointer\")\n                        .data('dev_surname',hero)\n                        .on('click',function(){\n                            Main.k.Profiles.display($(this).data('dev_surname'));\n                        })\n                        .appendTo(admins);\n                }\n            }\n        }\n\n        // Comms manager\n        var comms = $(\"<div>\").appendTo(titles_list);\n        $(\"<img>\").addClass(\"icon\").attr(\"src\", \"/img/icons/ui/title_03.png\")\n            /* Translators: This translation must be copied from the game. */\n            .attr(\"_title\", Main.k.text.gettext(\"Responsable de Communications\"))\n            /* Translators: This translation must be copied from the game. */\n            .attr(\"_desc\", Main.k.text.gettext(\"Le Responsable de Communications est la seule personne habilitée à décider quels seront les téléchargements prioritaires du Centre de Communication.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .appendTo(comms);\n        var comms_nb = 0;\n        for (i=0; comms_nb<maxshown && i<Main.k.COMMS.length; i++) {\n            hero = Main.k.COMMS[i];\n            if($.inArray(hero,Main.k.HEROES) != -1){\n                o_hero = Main.k.Profiles.get(hero);\n                if(!Main.k.Profiles.hasStatusWhichRemoveTitle(o_hero)) {\n                    comms_nb++;\n                    $(\"<img>\")\n                        .addClass(\"body \" + hero)\n                        .attr(\"src\", \"/img/design/pixel.gif\")\n                        .css(\"cursor\", \"pointer\")\n                        .data('dev_surname',hero)\n                        .on('click',function(){\n                            Main.k.Profiles.display($(this).data('dev_surname'));\n                        })\n                        .appendTo(comms);\n                }\n            }\n        }\n        // ----------------------------------- //\n\n        // Heroes\n        // ----------------------------------- //\n        var heroes_list = $(\"#heroes_list\").empty();\n\n        // Display players' skills & statuses\n        var $it = Main.heroes.iterator();\n        var missingheroes = [];\n        while ($it.hasNext()) {\n            hero = $it.next();\n            var display = false;\n            bubble = hero.dev_surname;\n            var $save = $('<a href=\"#\"><img src=\"/build/img/icons/ui/awake.png\" /></a>')\n                .css({\n                    'font-size': 0,\n                    position: 'absolute',\n                    right: 0,\n                    bottom: 0\n                })\n                .attr(\"_title\", Main.k.text.gettext(\"Espionnage\"))\n                .attr(\"_desc\", Main.k.text.gettext(\"<p>Vous êtes dans la même pièce que cette personne ; vous pouvez donc l'examiner de plus près.</p><p><strong>Cliquez ici pour enregistrer les compétences visibles, statuts publiques et titres de ce personnage.</strong></p>\"))\n                .data('dev_surname',bubble)\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip)\n                .click(function(e){\n                    e.preventDefault();\n                    var dev_surname = $(this).data('dev_surname');\n                    Main.k.Profiles.set(dev_surname);\n                    Main.k.Profiles.display(dev_surname);\n                });\n\n\n            var statuses = $(\"<div>\").addClass(\"icons statuses\");\n            if (hero.statuses) {\n                var $_statuses = hero.statuses.iterator();\n                while( $_statuses.hasNext() ) {\n                    display = true;\n                    /** @type {{img:string,desc:string}} **/\n                    var status = $_statuses.next();\n\n                    $(\"<img>\").attr(\"src\", \"/img/icons/ui/status/\" + status.img + \".png\")\n                        .attr(\"height\", \"14\").attr(\"alt\", status.img)\n                        .attr(\"_title\", status.name)\n                        .attr(\"_desc\", status.desc)\n                        .on(\"mouseover\", Main.k.CustomTip)\n                        .on(\"mouseout\", Main.k.hideTip)\n                        .appendTo(statuses);\n                }\n            }\n            if (hero.spores) {\n                var $spores = $('<div>')\n                    .css({\n                        position: 'relative',\n                        display: 'inline-block',\n                        'margin-left': '2px',\n                        top: '2px'\n                    })\n                    .appendTo(statuses);\n\n                $(\"<img>\").attr(\"src\", \"/img/icons/ui/spore.png\")\n                    .attr(\"height\", \"16\").attr(\"alt\", hero.spores.name)\n                    .attr(\"_title\", hero.spores.name)\n                    .attr(\"_desc\", hero.spores.desc)\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip)\n                    .appendTo($spores);\n\n                $('<span>')\n                    .text(hero.spores.nb)\n                    .css({\n                        'font-size': \"10px\",\n                        position: 'absolute',\n                        left: '4px',\n                        top: '3px',\n                        opacity: 0.7,\n                        'pointer-events': 'none'\n\n                    })\n                    .appendTo($spores);\n            }\n\n            var skills = $(\"<div>\").addClass(\"icons skills\");\n            if (hero.skills) {\n                var $_skills = hero.skills.iterator();\n                while( $_skills.hasNext() ) {\n                    display = true;\n                    var skill = $_skills.next();\n                    var skilldom = $(\"<span>\").addClass(\"skill\").appendTo(skills);\n\n                    $(\"<img>\").attr(\"src\", \"/img/icons/skills/\" + skill.img + \".png\")\n                        .attr(\"height\", \"19\").attr(\"alt\", skill.img)\n                        .attr(\"_title\", skill.name)\n                        .attr(\"_desc\", skill.desc + (Main.k.compInactiveMush[skill.img] ? \"<p><strong>\"+Main.k.text.gettext(\"Compétence inactive mush\")+\"</strong></p>\" : \"\"))\n                        .on(\"mouseover\", Main.k.CustomTip)\n                        .on(\"mouseout\", Main.k.hideTip)\n                        .appendTo(skilldom);\n\n                    if (Main.k.compInactiveMush[skill.img]) {\n                        $(\"<img>\").attr(\"src\", Main.k.servurl_badconker + \"/img/non-mush.png\").addClass(\"actmush\")\n                            .attr(\"width\", \"10\").attr(\"height\", \"10\")\n                            .attr(\"_title\", Main.k.text.gettext(\"Compétence inactive mush\"))\n                            .attr(\"_desc\", Main.k.text.gettext(\"Cette compétence est inactive quand on est mush (source : Twinpedia).\"))\n                            .on(\"mouseover\", Main.k.CustomTip)\n                            .on(\"mouseout\", Main.k.hideTip)\n                            .appendTo(skilldom);\n                    }\n                }\n            }\n\n            var titles = $(\"<div>\").addClass(\"titles\");\n            if (hero.titles) {\n                var $_titles = hero.titles.iterator();\n                while( $_titles.hasNext() ) {\n                    var title = $_titles.next();\n\n                    $(\"<img>\").attr(\"src\", \"/img/icons/ui/\" + title.img + \".png\")\n                        .attr(\"alt\", title.img)\n                        .attr(\"_title\", title.name)\n                        .attr(\"_desc\", title.desc)\n                        .on(\"mouseover\", Main.k.CustomTip)\n                        .on(\"mouseout\", Main.k.hideTip)\n                        .appendTo(titles);\n                }\n            }\n            var heroDiv = $(\"<div>\").addClass(\"hero\").appendTo(heroes_list);\n            $(\"<img>\")\n                .addClass(\"body \" + bubble)\n                .attr(\"src\", \"/img/design/pixel.gif\")\n                .css(\"cursor\", \"pointer\")\n                .attr(\"data-dev_surname\", hero.dev_surname)\n                .addHeroDescToolTip(hero.dev_surname)\n                .on(\"click\", function() {\n                    console.warn($(this).attr(\"data-dev_surname\"));\n                    Main.k.Profiles.display($(this).attr(\"data-dev_surname\"));\n                })\n                .appendTo(heroDiv);\n\n            heroDiv.append(skills);\n            heroDiv.append(statuses);\n            heroDiv.append(titles);\n            heroDiv.append($save);\n\n        }\n        var crew_list = $(\"#crew_list\").empty();\n        // Display all heroes\n        var missingDiv = $(\"<div>\").addClass(\"missingheroes\").appendTo(crew_list);\n        j=0;\n        var $div_hero;\n        var a_divs_heroes = {\n            'alive': [],\n            'inactive': [],\n            'dead': []\n        };\n        var inactive_status;\n        for (i=0; i<Main.k.HEROES.length; i++) {\n            inactive_status = null;\n            var hero = Main.k.HEROES[i];\n            if(hero == Main.k.ownHero){\n                continue;\n            }\n            var h = Main.k.h[hero];\n            if (j % 5 == 0) $(\"<br/>\").appendTo(missingDiv);\n            j++;\n            bubble = hero.replace(/(\\s)/g, \"_\").toLowerCase();\n            o_hero = Main.k.Profiles.get(hero);\n            $div_hero = $('<div>').css({\n                display: 'inline-block',\n                position: 'relative'\n            })\n                .append(\n                $(\"<img>\").addClass(\"body \" + bubble)\n                    .attr(\"src\", \"/img/design/pixel.gif\")\n                    .css(\"cursor\", \"pointer\")\n                    .addHeroDescToolTip(hero)\n                    .data('dev_surname',hero)\n                    .on(\"click\", function () {\n                        Main.k.Profiles.display($(this).data('dev_surname'));\n                    })\n            );\n\n            for( var inc = 0; inc < o_hero.statuses.length; inc ++){\n                /** @type {{desc:string,img:string, name:string}} **/\n                status = o_hero.statuses[inc];\n                if($.inArray(status.img,['sleepy','noob']) != -1){\n                    inactive_status = status.img;\n                }\n            }\n            if(o_hero.dead == true){\n                a_divs_heroes['dead'].push($div_hero);\n                $('<img>').attr({\n                    src: '/img/icons/ui/dead.png'\n                })\n                    .css({\n                        position: 'absolute',\n                        bottom: '-6px',\n                        right: '-2px',\n                        'pointer-events': 'none'\n                    })\n                    .appendTo($div_hero);\n            }else if(inactive_status != null){\n                a_divs_heroes['inactive'].push($div_hero);\n                $('<img>').attr({\n                    src: '/img/icons/ui/'+inactive_status+'.png'\n                })\n                    .css({\n                        position: 'absolute',\n                        bottom: '-6px',\n                        right: '-2px',\n                        'pointer-events': 'none'\n                    })\n                    .appendTo($div_hero);\n            }else{\n                a_divs_heroes['alive'].push($div_hero);\n\n            }\n        }\n        $.each(a_divs_heroes,function(k,a){\n            $.each(a, function(key,$div){\n                missingDiv.append($div);\n            });\n\n        });\n        var cryo_table = $('.what_happened .table').first();\n        if(cryo_table.length > 0 && cryo_table.find('.ctrlw-save-cryo').length == 0){\n            cryo_table.find('tr').last().after('<tr><td colspan=\"2\" class=\"ctrlw-save-cryo\" style=\"font-style:normal\"></td></tr>');\n            /* Translators: Text for Cryogenized people from CryoModule  Useless to translate in English*/\n            if(cryo_table.find(':contains(\"'+Main.k.text.gettext(\"Cryo\")+'\")').length > 0){\n                cryo_table.find('.ctrlw-save-cryo').append(Main.k.text.gettext(\"Tout le monde doit être décryogénisé pour pouvoir mettre à jour la liste d'équipage\"));\n            }else{\n                Main.k.MakeButton(\"<img src='/build/img/icons/ui/notes.gif' /> \"+Main.k.text.gettext(\"Mettre à jour la liste d'équipage\"), null, null, Main.k.text.gettext(\"Mettre à jour la liste d'équipage\"),Main.k.text.gettext(\"Cliquer ici pour mettre à jour la liste d'équipage de CTRL+W\")\n                ).appendTo(cryo_table.find('.ctrlw-save-cryo'))\n                    .find(\"a\").on(\"mousedown\", function(e) {\n                        var tds,bubble,status,add_bool;\n                        var heroes_list = [];\n                        var status_to_str = {\n                            /* Translators: Text for idle people from CryoModule. Regex allowed*/\n                            'inactive': Main.k.text.gettext('Inactive'),\n                            /* Translators: Text for awake people from CryoModule. Regex allowed*/\n                            'awake' : Main.k.text.gettext('Eveillée?'),\n                            /* Translators: Text for dead people from CryoModule. Regex allowed*/\n                            'dead' :  Main.k.text.gettext('Morte?')//Dead\n                        };\n                        console.info('status_to_str',status_to_str);\n                        cryo_table.find('tr').each(function(){\n                            tds = $(this).find('td');\n                            if(tds.length == 2){\n                                status = null;\n                                bubble = Main.k.surnameToBubble(tds.first().text().trim());\n                                $.each(status_to_str,function(key,regex){\n                                    regex = new RegExp(regex);\n                                    if(regex.exec(tds.last().text().trim()) != null){\n                                        status = key;\n                                    }\n                                });\n                                if(status == null){\n                                    console.error('Statut inconnu :', tds.last().text().trim());\n                                    return true;\n                                }\n                                console.log(bubble,status);\n                                heroes_list.push(bubble);\n                                profile = Main.k.Profiles.get(bubble);\n                                if(status == 'inactive'){\n                                    add_bool = true\n                                    $.each(profile.statuses,function(index,status){\n                                        if(status.img == \"sleepy\"){\n                                            add_bool = false;\n                                            return false;\n                                        }\n                                    });\n                                    if(add_bool){\n                                        profile.statuses.push(Main.k.statuses['inactive']);\n                                    }\n                                    profile.dead = false;\n                                }else if (status == 'awake'){\n                                    profile.dead = false;\n                                    $.each(profile.statuses,function(index,current_status){\n                                        if(current_status.img == \"sleepy\"){\n                                            console.log('is sleepy');\n                                            profile = Main.k.Profiles.removeAttrFromProfile(profile,'statuses',Main.k.statuses['inactive']['img']);\n                                            profile = Main.k.Profiles.removeAttrFromProfile(profile,'statuses',Main.k.statuses['hinactive']['img']);\n                                            return false;\n                                        }\n                                    });\n                                }else if(status == 'dead'){\n                                    profile.dead = true;\n                                }\n                                Main.k.Profiles.set(profile,false);\n\n                            }\n                        });\n                        Main.k.GameInfos.data.heroes_list = heroes_list;\n                        Main.k.GameInfos.save();\n                        Main.k.Profiles.save();\n                        Main.k.MushInitHeroes();\n                        Main.k.MushUpdate();\n                        return false;\n                    });\n            }\n\n        }\n        // ----------------------------------- //\n\n\n        // Exploration\n        // ----------------------------------- //\n        var exploring = $(\".exploring .exploring2\");\n        $(\"#expblock\").empty();\n        if (exploring.length > 0) {\n            t = $(\"<h3>\").html(\"Exploration\").appendTo(\"#expblock\");\n            $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \"#expblockdiv\").appendTo(t).on(\"click\", Main.k.ToggleDisplay);\n            var expblock = $(\"<div>\").attr(\"id\", \"expblockdiv\").appendTo(\"#expblock\");\n\n            i = 0;\n            var planetname = \"\";\n            var back = \"\";\n            exploring.find(\"li\").each(function() {\n                var li = $(this).clone();\n                li.find(\"span\").remove();\n                var imgsrc = \"\";\n\n                //noinspection FallThroughInSwitchStatementJS\n                switch(i) {\n                    case 1:\n                        var players = $(\"<div>\").addClass(\"missingheroes\").appendTo(expblock);\n                        var p = li.html().split(\",\");\n                        for (var j=0; j<p.length; j++) {\n                            var hero = p[j].trim();\n                            var bubble = hero.replace(/(\\s)/g, \"_\").toLowerCase();\n                            var h = Main.k.h[bubble];\n\n                            $(\"<img>\").addClass(\"body \" + bubble)\n                                .attr(\"src\", \"/img/design/pixel.gif\")\n                                .attr(\"_title\", hero)\n                                .attr(\"_desc\", h.short_desc)\n                                .on(\"mouseover\", Main.k.CustomTip)\n                                .on(\"mouseout\", Main.k.hideTip)\n                                .appendTo(players);\n                        }\n                        break;\n\n                    case 0:\n                        imgsrc = \"planet\";\n                    case 2:\n                        if (imgsrc == \"\") imgsrc = \"casio\";\n                        $(\"<p>\").css({\n                            color: \"#DDD\",\n                            \"font-size\": \"12px\",\n                            margin: \"-6px 0 0\",\n                            \"text-align\": \"center\"\n                        }).html(\"<img src='/img/icons/ui/\" + imgsrc + \".png' /> \" + li.html().trim()).appendTo(expblock)\n                            .find(\"img\").css({\n                                position: \"relative\",\n                                top: \"4px\"\n                            });\n                        break;\n                }\n\n                i++;\n            });\n        }\n        // ----------------------------------- //\n\n\n        // Inventory\n        // ----------------------------------- //\n        var hasPlants = false;\n        var hasPharma = false;\n        var mwidth = 120; //$(\".usLeftbar\").width();\n        //$(\"#room\").addClass(\"roominventory\"); // New class used for cancelSelection\n        $(\".kobject_list\").empty();\n        var $room = $(\"#room\");\n        if ($room.find(\"[data-id='TREE_POT']\").size()) hasPlants = true;\n        $room.find(\"li\").not(\".cdEmptySlot\").not(\"[data-id='TREE_POT']\").each(function() {\n            var $this = $(this);\n            var li = $(\"<li>\")\n                .addClass(\"item fakeitem\")\n                .attr(\"serial_fake\", $(this).attr(\"serial\"))\n                .attr(\"data-name\", $(this).attr(\"data-name\"))\n                .attr(\"data-id\", \"TREE_POT\")\n                .css(\"list-style-type\", \"none\")\n                .html($(this).html())\n                .on(\"click\", function() {\n                    if(!$('#cdInventory').hasClass('placard_on')){\n                        Main.closet.show();\n                    }\n                    $(this).siblings().find('.selected').remove();\n                    $(this).prepend('<div class=\"selected\"></div>');\n                    mush_jquery('[serial=\"'+$this.attr('serial')+'\"]').trigger('click') ;\n                })\n                .appendTo(\".kobject_list\")\n                .find(\"td\")\n                .attr(\"_title\", $(this).attr(\"data-name\").split(\"\\\\'\").join(\"'\"))\n                .attr(\"_desc\", $(this).attr(\"data-desc\").split(\"\\\\'\").join(\"'\"))\n                .on(\"mouseover\", Main.k.CustomTip)\n                .on(\"mouseout\", Main.k.hideTip);\n\n            // Loads\n            var name = $(this).attr(\"data-name\");\n            var reg = /\\/>x([0-9]+)$/;\n            if (reg.test(name)) {\n                var charges = reg.exec(name)[1];\n                $(\"<span>\")\n                    .addClass(\"charges\")\n                    .html(\"x\" + charges)\n                    .appendTo(li.find(\"tr\"));\n            }\n\n            // Broken?\n            var broken = \"/img/icons/ui/broken.png\";\n            if (name.indexOf(broken) > -1) {\n                $(\"<img>\").attr(\"src\", broken).addClass(\"broken\").appendTo(li.find(\"tr\"));\n            }\n            // Pharma?\n            if ($(this).attr(\"data-desc\").indexOf(\"Effets\") != -1 || $(this).data('id') == 'CONSUMABLE') hasPharma = true;\n        });\n        $(\".usLeftbar .inventory\").css(\"max-width\", mwidth + \"px\").css(\"margin-left\", \"0px\");\n        // Pharma\n        $(\"#pharmashare\").css(\"display\", !hasPharma ? \"none\" : \"block\");\n        // ----------------------------------- //\n\n\n        // Lab - Nexus - Pilgred - Plants - Planets\n        // ----------------------------------- //\n        var project_list = $(\"#project_list\").empty();\n        var $cdModuleContent = $(\"#cdModuleContent\");\n        var projects = $cdModuleContent.find(\"ul.dev li.cdProjCard\");\n        var projectsdiv;\n        var $research_module = $(\"#research_module\");\n        var pattcore = new RegExp(Main.k.text.gettext(\"Coeur de NERON\"),\"i\");\n        // Research\n        if ($research_module.length > 0 && projects.length > 0) {\n            t = $(\"<h3>\").html(Main.k.text.gettext(\"Laboratoire\")).appendTo(project_list);\n            $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \"#projectspreview\")\n                .on(\"click\", Main.k.ToggleDisplay).appendTo(t);\n\n            projectsdiv = $(\"<div>\").addClass(\"projectspreview labpreview\").attr(\"id\", \"projectspreview\").appendTo(project_list);\n            projects.each(function(i) {\n                var projectdiv = $(\"<div>\").addClass(\"projectpreview\").appendTo(projectsdiv);\n\n                // Project card\n                $(\"<img>\").addClass(\"projectimg\")\n                    .attr(\"src\", $(this).find(\"img.devcard\").attr(\"src\"))\n                    .appendTo(projectdiv);\n\n                // Completion %\n                $(\"<div>\").addClass(\"projectpct\")\n                    .html($(this).find(\"span\").html().trim())\n                    .appendTo(projectdiv);\n\n                // Bonuses\n                var projectbonus = $(\"<div>\").addClass(\"projectbonus\").appendTo(projectdiv);\n                $(this).find(\"div.suggestprogress ul li img\").each(function(i) { $(this).clone().appendTo(projectbonus); });\n\n                // Tooltip\n                var h3 = $(this).find(\"h3\").clone();\n                h3.find(\"em\").remove();\n\n                projectdiv.attr(\"_title\", h3.html().trim())\n                    .attr(\"_desc\",\n                    $(this).find(\"div.desc\").html().trim() + \"</p><p>\" +\n                    $(this).find(\"p.efficacity\").html().trim()\n                )\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            });\n\n            // Research actions\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/guide.png' /> \"+Main.k.text.gettext(\"Partager\"), null, null, Main.k.text.gettext(\"Partager les recherches\"),\n                Main.k.text.gettext(\"<p>Insère la liste de recherches dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                \"<li><strong>Nom de la recherche</strong> - 0%<br/>Description de la recherche<br/>Bonus : <i>Biologiste</i>, <i>Médecin</i></li>\" +\n                \"<li><strong>Nom de la recherche</strong> - 0%<br/>Description de la recherche<br/>Bonus : <i>Biologiste</i>, <i>Médecin</i></li>\" +\n                \"<li><strong>Nom de la recherche</strong> - 0%<br/>Description de la recherche<br/>Bonus : <i>Biologiste</i>, <i>Médecin</i></li></p>\")\n            ).appendTo(project_list)\n                .find(\"a\").addClass(\"shareresearchbtn\").on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatResearch();\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                });\n\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Partager v2\"), null, null, Main.k.text.gettext(\"Partager les recherches\"),\n                Main.k.text.gettext(\"<p>Insère la liste de recherches dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                \"<li><strong>Nom de la recherche</strong> - 0%</li>\" +\n                \"<li><strong>Nom de la recherche</strong> - 0%</li>\" +\n                \"<li><strong>Nom de la recherche</strong> - 0%</li></p>\")\n            ).appendTo(project_list)\n                .find(\"a\").addClass(\"shareresearchbtn\").on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatResearch(true);\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                });\n            /*console.warn('item research',$research_module.find(\" ul.inventory li.item\"));\n             console.log($('.heroSerialActions div').length)\n             $research_module.find(\" ul.inventory\").html($('#room').html());\n             var $roomActions = $('.roomItemActions').children().clone();\n             console.log($('.roomItemActions').children().length,$('.roomItemActions').children());\n             //$roomActions.attr('webdata',$roomActions.attr('serial'));\n             $('.heroSerialActions').append($roomActions);\n             console.log($('.heroSerialActions div').length);*/\n            var tgt = $(\".cdActionList\");\n            var src = $(\".cdActionRepository .heroRoomActions\").children().clone();\n            tgt.html(src);\n            $(\".cdActionList .move\").hide();\n            mush_jquery('#char_col #myInventory > li').removeAttr('onclick');\n            $('#char_col #myInventory > li').on('click',function(){\n                Main.k.CreateNeronAlert(Main.k.text.gettext(\"Veuillez utiliser l'inventaire du labo s'il vous plaît\"));\n            });\n            $research_module.find(\" ul.inventory li.item\").off('click');\n            $research_module.find(\" ul.inventory li.item\").on(\"click\", function(){\n                console.log('select',$(this));\n                serial = $(this).attr('serial');\n                var jMe = $(\"[serial='\" + serial + \"']\");\n                console.log('avant cookie');\n                js.Cookie.set(CrossConsts.COOK_SEL,StringTools.urlEncode(serial),3600);\n                console.log('apres cookie');\n                var parentId = \"\";\n                var parent;\n                realJMe = $(this);\n//\t\t\t\tjMe.each(function() {\n//\t\t\t\t\tif ($(this).parent().attr(\"id\") != undefined && !$(this).parents('#char_col')) {\n//\t\t\t\t\t\trealJMe = $(this);\n//\t\t\t\t\t\tparent = $(this).parent();\n//\t\t\t\t\t\tparentId = parent.attr(\"id\");\n//\t\t\t\t\t}\n//\t\t\t\t});\n//\t\t\t\tif (parentId == \"myInventory\") {\n                if (realJMe.hasClass(\"fakeselected\")) {\n// Clear selection\n                    realJMe.removeClass(\"fakeselected\");\n                    $(\"#cdActionList div\").not(\".move\").remove();\n                    //Main.cancelSelection(mush_jquery(realJMe[0]));\n                    $(\"#myInventory .selected\").parent().removeClass(\"on\");\n                    $(\"#myInventory .selected\").remove();\n                    Main.sel.currentInvSelection = null;\n                    return;\n                }\n                realJMe.addClass(\"on\");\n                console.warn('realJMe',realJMe);\n                var allItems = $(\"#myInventory .item\").not(\".cdEmptySlot\").add(\"[serverselected=true]\");\n                $(\".cdCharColSel\").remove();\n                $(\"#myInventory .selected\").parent().removeClass(\"on\");\n                $(\"#myInventory .selected\").remove();\n                $(\"#myInventory .fakeselected\").removeClass('fakeselected');\n                realJMe.addClass(\"fakeselected\");\n                var $div = $('<div>').prependTo(realJMe).addClass('selected');\n                console.log('selected_parent',$div.parent());\n                var realJMe = $(\"[data-tip='\" + realJMe.attr(\"data-tip\") + \"']\").not(\"[serial='\" + serial + \"']\");\n                console.warn('realJMe',realJMe);\n                var serial = realJMe.attr(\"serial\");\n                Main.sel.currentInvSelection = null;\n                console.warn(1,$('#myInventory .selected'));\n                //Main.cancelSelection(mush_jquery(realJMe[0]));\n                console.warn(2,$('#myInventory .selected'));\n                Main.acListMaintainer.heroWorking = true;\n                Main.sel.currentInvSelection = serial;\n//\t\t\t\t\tMain.acListMaintainer.refreshHeroInv();\n                Main.acListMaintainer.heroWorking = true;\n                //this.currentInvSelection = serial;\n                Main.acListMaintainer.refreshHeroInv();\n                console.warn($('#myInventory .selected'));\n                var actions = $(\"div[webdata='\" + serial + \"']\");\n                console.log('actions',actions);\n                $(\"#cdActionList\").find(\"div\").hide();\n                actions.each(function () {\n                    $(this).clone().appendTo(\"#cdActionList\");\n                });\n                $(\"<div class='action stSel'> \" + realJMe.attr(\"data-name\").split(\"\\\\'\").join(\"'\") + \" :</div>\").prependTo(\"#cdActionList\");\n//\t\t\t\t}\n            });\n\n            // Projects\n        } else if (projects.length > 0 && pattcore.test($cdModuleContent.find(\"h2\").html().trim())) {\n            t = $(\"<h3>\").html(\"Projets Neron\").appendTo(project_list);\n            $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \"#projectspreview\")\n                .on(\"click\", Main.k.ToggleDisplay).appendTo(t);\n\n            projectsdiv = $(\"<div>\").addClass(\"projectspreview\").attr(\"id\", \"projectspreview\").appendTo(project_list);\n            projects.each(function(i) {\n                var projectdiv = $(\"<div>\").addClass(\"projectpreview\").appendTo(projectsdiv);\n\n                // Project card\n                $(\"<img>\").addClass(\"projectimg\").attr(\"src\", $(this).find(\"img\").attr(\"src\")).appendTo(projectdiv);\n\n                // Completion %\n                $(\"<div>\").addClass(\"projectpct\").html($(this).find(\"span\").html().trim()).appendTo(projectdiv);\n\n                // Bonuses\n                var projectbonus = $(\"<div>\").addClass(\"projectbonus\").appendTo(projectdiv);\n                $(this).find(\"div.suggestprogress ul li img\").each(function(i) { $(this).clone().appendTo(projectbonus); });\n\n                // Tooltip\n                projectdiv.attr(\"_title\", $(this).find(\"h3\").html().trim())\n                    .attr(\"_desc\",\n                    $(this).find(\"div.desc\").html().trim() + \"</p><p>\" +\n                    $(this).find(\"p.efficacity\").html().trim()\n                )\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            });\n\n            // Projects actions\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Partager\"), null, null, Main.k.text.gettext(\"Partager les projets\"),\n                Main.k.text.gettext(\"<p>Insère la liste de projets dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                \"<li><strong>Nom du projet</strong> - 0%<br/>Description du projet<br/>Bonus : <i>Tireur</i>, <i>Pilote</i></li>\" +\n                \"<li><strong>Nom du projet</strong> - 0%<br/>Description du projet<br/>Bonus : <i>Tireur</i>, <i>Pilote</i></li>\" +\n                \"<li><strong>Nom du projet</strong> - 0%<br/>Description du projet<br/>Bonus : <i>Tireur</i>, <i>Pilote</i></li></p>\")\n            ).appendTo(project_list)\n                .find(\"a\").addClass(\"shareprojectbtn\").on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatProjects();\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                });\n\n            // Astro\n        } else if ($(\"#navModule\").length > 0) {\n            var nav = $(\"#navModule\");\n            var planets = nav.find(\".planet\").not(\".planetoff\");\n            if (planets.length > 0) {\n                t = $(\"<h3>\").html(Main.k.text.gettext(\"Planètes\")).appendTo(project_list);\n                $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \"#projectspreview\")\n                    .on(\"click\", Main.k.ToggleDisplay).appendTo(t);\n\n                projectsdiv = $(\"<div>\").addClass(\"projectspreview planetpreview\").attr(\"id\", \"projectspreview\").appendTo(project_list);\n                planets.each(function(i) {\n                    // Print planet\n                    var planet = $(\"<div>\").addClass(\"planetpreview\").appendTo(projectsdiv);\n                    $(\"<img>\").attr(\"width\", \"40\")\n                        .attr(\"src\", $(this).find(\"img.previmg\").attr(\"src\"))\n                        .css({'cursor':'pointer'})\n                        .on(\"mousedown\", function(e) {\n                            $('textarea:focus').each(function(e) {\n                                var txt = Main.k.FormatPlanets(i);\n                                $(this).insertAtCaret(txt);\n                            });\n                            return false;\n                        })\n                        .appendTo(planet);\n                    if($(this).find('.share-planet').length == 0){\n                        var $button_share_planet = Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \", null, null, Main.k.text.gettext(\"Partager la planète\"),\n                            Main.k.text.gettext(\"Partage uniquement cette planète dans l'inventaire\")\n                        )\n                            .addClass('share-planet');\n                        $button_share_planet.find(\"a\").on(\"mousedown\", function(e) {\n                            $('textarea:focus').each(function(e) {\n                                var txt = Main.k.FormatPlanets(i);\n                                $(this).insertAtCaret(txt);\n                            });\n                            return false;\n                        });\n                        $('<td>').append($button_share_planet).insertAfter($(this).find('.buttons td:last-child'));\n                    }\n                });\n\n                // Planets actions\n                Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Partager\"), null, null, Main.k.text.gettext(\"Partager les planètes\"),\n                    Main.k.text.gettext(\"Insère la liste de planètes dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                    \"TODO: aperçu\")\n                ).appendTo(project_list)\n                    .find(\"a\").on(\"mousedown\", function(e) {\n                        $('textarea:focus').each(function(e) {\n                            var txt = Main.k.FormatPlanets(null);\n                            $(this).insertAtCaret(txt);\n                        });\n                        return false;\n                    });\n            }\n\n            // BIOS\n        } else if ($(\"#biosModule\").length > 0) {\n            $(\"<h3>\").html(\"BIOS NERON\").appendTo(project_list);\n\n\n            // Share params\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Partager\"), null, null, Main.k.text.gettext(\"Partager les paramètres\"),\n                Main.k.text.gettext(\"Insère la liste de paramètres BIOS Neron dans la zone de texte active, de la forme&nbsp;:</p><p>\" +\n                \"TODO: aperçu\")\n            ).appendTo(project_list)\n                .find(\"a\").on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatBIOS();\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                });\n            //Comm\n        }else if ($(\"#trackerModule\").length > 0){\n            var t = $(\"<h3>\").html(Main.k.text.gettext(\"Com.\")).appendTo(project_list);\n            $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \".commPreview\")\n                .on(\"click\", Main.k.ToggleDisplay).appendTo(t);\n            var nav = $(\"#trackerModule\");\n            var comm = $(\"<div>\").addClass(\"commPreview\").css({'text-align':'center','cursor':'pointer'}).appendTo(project_list);\n            var $img_com = $(\"<img>\")\n                .attr(\"src\", \"/img/design/sensor01.png\")\n                .on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatComm();\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                }).appendTo(comm);\n            setInterval(function(){\n                $img_com.attr('src',$('#trackerModule').find('.sensors img').attr('src'));\n            },100);\n            //TODO multi\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Partager\"), null, null, null,\n                \"TODO: aperçu\"\n            ).appendTo(project_list)\n                .find(\"a\").on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatComm();\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                });\n        }\n\n        // Plants\n        $usLeftbar.find(\"#plantmanager\").remove();\n        if (hasPlants) {\n            // Create div\n            var plantsDIV = $(\"<div>\").attr(\"id\", \"plantmanager\").appendTo($usLeftbar);\n            t = $(\"<h3>\").html(Main.k.text.gettext(\"Plantes\")).appendTo(plantsDIV);\n            $(\"<span>\").addClass(\"displayless\").attr(\"_target\", \".kplantlist\").appendTo(t).on(\"click\", Main.k.ToggleDisplay);\n\n            // List plants\n            var plantlist = $(\"<div>\").addClass(\"kplantlist plants inventory\").css(\"max-width\", mwidth + \"px\").appendTo(plantsDIV);\n            $room.find(\"[data-id='TREE_POT']\").each(function() {\n                var $this = $(this);\n                $(\"<li>\")\n                    .addClass(\"item fakeitem\")\n                    .attr(\"serial_fake\", $(this).attr(\"serial\"))\n                    .attr(\"data-name\", $(this).attr(\"data-name\"))\n                    .attr(\"data-id\", \"TREE_POT\")\n                    .css(\"list-style-type\", \"none\")\n                    .html($(this).html())\n                    .on(\"click\", function() {\n                        if(!$('#cdInventory').hasClass('placard_on')){\n                            Main.closet.show();\n                        }\n                        mush_jquery('[serial=\"'+$this.attr('serial')+'\"]').trigger('click') ; })\n                    .appendTo(plantlist)\n                    .find(\"td\")\n                    .attr(\"_title\", $(this).attr(\"data-name\").split(\"\\\\'\").join(\"'\"))\n                    .attr(\"_desc\", $(this).attr(\"data-desc\").split(\"\\\\'\").join(\"'\"))\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            });\n\n            // Plants actions\n            $(\"<div>\").css(\"clear\", \"both\").css(\"height\", \"5px\").appendTo(plantsDIV);\n            Main.k.MakeButton(\"<img src='/build/img/icons/ui/talk.gif' /> \"+Main.k.text.gettext(\"Partager\"), null, null, Main.k.text.gettext(\"Plantes\"), Main.k.text.gettext(\"Partager l'état des plantes.\"))\n                .appendTo(plantsDIV)\n                .find(\"a\").on(\"mousedown\", function(e) {\n                    $('textarea:focus').each(function(e) {\n                        var txt = Main.k.FormatPlants();\n                        $(this).insertAtCaret(txt);\n                    });\n                    return false;\n                });\n        }\n        // ----------------------------------- //\n\n\n        // Enhance alerts\n        // ----------------------------------- //\n        var $topinfo_bar = $(\"#topinfo_bar\");\n        var alarm = $topinfo_bar.find(\".alarm\");\n        if (alarm.length > 0) {\n            alarm.find(\".alertnb\").remove();\n            var alarm_equip = \"/img/icons/ui/alert.png\";\n            var alarm_door = \"/img/icons/ui/door.png\";\n            var alarm_hunter = \"/img/icons/ui/hunter.png\";\n            var alarm_fire = \"/img/icons/ui/fire.png\";\n\n            alarm.find(\"img\").each(function() {\n                var _alarm = $(this).attr(\"src\").toLowerCase();\n                var alarm_nb = 0;\n                var omo = $(this).parent().attr(\"onmouseover\");\n\n                switch (_alarm) {\n                    case alarm_equip:\n                        alarm_nb = parseInt(/>([0-9]+)/.exec(omo)[1]);\n                        break;\n                    case alarm_door:\n                        alarm_nb = parseInt(/>([0-9]+)/i.exec(omo)[1]);\n                        break;\n                    case alarm_hunter:\n                        var patt = new RegExp(Main.k.text.gettext(\"([0-9]+|un|a)+ appareil\"), \"i\");\n                        if (patt.test(omo)) {\n                            alarm_nb = patt.exec(omo)[1];\n                        } else if (/>([0-9]+|un|a)/i.test(omo)) {\n                            alarm_nb = />([0-9]+|un|a)/i.exec(omo)[1];\n                        }\n                        if (alarm_nb) alarm_nb = (alarm_nb.toLowerCase() == \"un\" || alarm_nb.toLowerCase() == \"a\") ? 1 : parseInt(alarm_nb);\n                        break;\n                    case alarm_fire:\n                        alarm_nb = parseInt(/>([0-9]+)/i.exec(omo)[1]);\n                        break;\n                }\n\n                // Display nb if needed\n                if (alarm_nb!=0) {\n                    var updatebg = true;\n\n                    $(this).css({\n                        position: \"relative\",\n                        \"z-index\": \"5\"\n                    });\n                    $(this).parent().css(\"position\", \"relative\");\n\n                    var wrap = $(\"<div>\").addClass(\"alertnbwrapper\")\n                        .css(\"left\", parseInt(($(this).parent().width() - 20) / 2) + \"px\")\n                        .appendTo($(this).parent());\n\n                    $(\"<div>\").addClass(\"alertnb\").html(alarm_nb).appendTo(wrap);\n                }\n\n\n\n            });\n\n\n            $topinfo_bar.find(\".alarm_on\").css(\"background-image\", \"url(\" + Main.k.servurl + \"/img/alertpleft.gif)\");\n            $topinfo_bar.find(\".alarm_right_on\").css(\"background-image\", \"url(\" + Main.k.servurl + \"/img/alertpright.gif)\");\n            $topinfo_bar.find(\".alarm_bg_on\").css(\"background-image\", \"url(\" + Main.k.servurl + \"/img/alertbg.gif)\");\n        }\n        //Display shield is needed\n        var spaceshipstatus = $topinfo_bar.find(\".spaceshipstatus\");\n        if (spaceshipstatus.length > 0) {\n            spaceshipstatus.find(\".spaceshipstatus-info\").remove();\n            spaceshipstatus.find(\"img\").each(function() {\n                var regex = /\\/([a-z]+)\\.png$/;\n                var matches = regex.exec($(this).attr('src'));\n                if(matches != null){\n                    switch (matches[1]) {\n                        case 'shield':\n                            if(/: *[0-9]+<br\\/>.+: *([0-9]+)<br\\/>/.test($(this).parent().attr('onmouseover'))){\n                                var wrap = $('<div class=\"spaceshipstatus-info\" style=\"font-size:10px;text-align:center;\">'+RegExp.$1+'&nbsp;<img src=\"http://'+Main.k.domain+'/img/icons/ui/plasma.png\" width=\"11\"></div>').appendTo($(this).parent());\n\n                            }\n                            break;\n                    }\n                }\n            });\n        }\n\n        // ----------------------------------- //\n\n\n        // Enhance private chats\n        // ----------------------------------- //\n        for (i=0; i<3; i++) {\n            var tab = $(\"#cdTabsChat\").find(\".cdPrivateTab\" + i);\n            var tabcontent = $(\"#cdPrivate\" + i);\n            if (tab.length > 0 && tabcontent.length > 0) {\n                var tip = \"\";\n                var heroes = tabcontent.find(\".mini_priv\");\n                for (j=0; j<heroes.length; j++) {\n                    var mouseover = $(heroes[j]).attr(\"onmouseover\");\n                    var name = /<h1>([^<]+)<\\/h1>/.exec(mouseover)[1];\n                    var co = /[a-zA-Z]+\\s?:\\s([^<]+)/.exec(mouseover)[1].toLowerCase();\n                    tip += \"<strong>\" + name + \"</strong> - \"+Main.k.text.gettext(\"connecté(e)\")+\" \" + co + \"<br/>\";\n                }\n\n                tab.find(\"img\").off(\"mouseover\").off(\"mouseout\")\n                    .attr(\"_title\", Main.k.text.gettext(\"Canal privé\")+ \" #\" + (i+1))\n                    .attr(\"_desc\", tip)\n                    .on(\"mouseover\", Main.k.CustomTip)\n                    .on(\"mouseout\", Main.k.hideTip);\n            }\n        }\n        // ----------------------------------- //\n\n        // Update manager?\n        if (Main.k.Manager.opened) Main.k.Manager.update();\n\n        Main.k.Profiles.update();\n\n        // Options\n        Main.k.updateBottom();\n        Main.k.customBubbles();\n\n        // Fix PAbis\n        $(\"#cdPaBloc\").find(\"img[src='/img/design/pa1bis.png']\").attr(\"src\", Main.k.servurl + \"/img/pa1bis.png\");\n\n        // Fix dimensions\n        Main.k.Resize();\n\n        // Last sent message lost ?\n        var cook = js.Cookie.get(\"lastsentmsg\");\n        if (cook) {\n            Main.k.displayLastSent(true);\n        } else {\n            //Main.k.displayLastSent(false);\n        }\n    };\n    exportFunction(Main.k.MushUpdate, unsafeWindow.Main.k, {defineAs: \"MushUpdate\"});\n    Main.k.MushInitHeroes = function(){\n        Main.k.heroes = {};\n        Main.k.heroes_same_room = [];\n        var $it = Main.heroes.iterator();\n        var heroes = \"\";\n        var tab_heroes = jQuery.extend([], Main.k.HEROES);\n        var tab_heroes_same_room = [];\n        while ($it.hasNext()) {\n            (function() {\n                /** @type {{surname:string}} **/\n                var hero = $it.next();\n\n                //Main.k.heroes[hero.dev_surname] = Main.k.convertHeroToSimpleHero(hero,null);\n\n                tab_heroes_same_room.push(Main.k.surnameToBubble(hero.surname));\n                tab_heroes = jQuery.grep(tab_heroes, function (value) {\n                    return value != Main.k.surnameToBubble(hero.surname);\n                });\n            })();\n\n        }\n        Main.k.heroes_same_room = tab_heroes_same_room;\n        var existing_heroes = ['finola','chao'];\n        //console.log('check heroes list',Main.k.GameInfos.data.heroes_list);\n        if(Main.k.GameInfos.data.heroes_list.length > 0){\n            Main.k.HEROES = Main.k.GameInfos.data.heroes_list;\n        }else{\n            if($('.groupConf').length > 0 && $('.groupConf img[src*=\"use_andrek\"]').length == 1){\n                existing_heroes = ['andie','derek'];\n            }\n\n            //replace heroes\n            $.each(Main.k.HEROES.replace, function(k,v){\n                var index;\n                if($('.'+k).length > 0 || $.inArray(k,existing_heroes) != -1){\n                    index = $.inArray(v,Main.k.HEROES);\n                }else{\n                    index = $.inArray(k,Main.k.HEROES);\n                }\n                Main.k.HEROES.splice(index,1);\n            });\n        }\n\n\n    };\n    Main.k.MushInit();\n    Main.k.MushUpdate();\n    Main.k.MushAfterInit();\n\n    // TODO: fix for chrome\n    $(document).keypress(function(e){\n        if (e.keyCode === 27) Main.k.ClosePopup();\n    });\n};\nMain.k.tabs.credits = function() {\n    $(\"blockquote\").css(\"overflow\", \"visible\");\n    $(\"blockquote p\").css({\n        height: \"auto\",\n        \"font-size\": \"10pt\",\n        \"margin-top\": \"10px\"\n    });\n    $(\"#extra\").find(\".nova\").css(\"display\", \"none\");\n\n    // Add menu\n    $(\"<div>\").addClass(\"mainmenu\").html('<ul id=\"menuBar\">\\\n\t\t<li class=\"daed\"><a href=\"/\">Jouer</a></li>\\\n\t\t<li><a href=\"/me\">Mon Compte</a></li>\\\n\t\t<li><a href=\"/ranking\">Classement</a></li>\\\n\t\t<li><a href=\"/tid/forum\">Forum</a></li>\\\n\t</ul>').appendTo(\".mxhead\");\n\n    // Enhance mushs\n    $(\".scoremush\").siblings(\"h3\").css(\"color\", \"rgb(255, 64, 89)\");\n    $(\".triumphmush\").siblings(\".dude\").find(\"h3\").css(\"color\", \"rgb(255, 64, 89)\");\n};\nMain.k.tabs.playerProfile = function() {\n\n    /** Only on connected player profile page **/\n    if($(\"#experience.cdTabTgt\").length > 0){\n\n        // Fix Experience\n        $(\".charboostbg ul.slots\").css(\"display\", \"none\");\n        $(\"ul.boost li.charboost\").css(\"height\", \"200px\");\n\n        // Fix menu\n        $(\"#accountmenu\").find(\"a\").each(function() {\n            $(this).on(\"click\", function() {\n                var r = /\\?([a-z]+)$/;\n                if (r.test(this.href)) {\n                    $('.cdTabTgt').hide();\n                    $(\"#\" + r.exec(this.href)[1]).show();\n                    var sel = $(\"#\" + r.exec(this.href)[1] + \"tab\");\n                    sel.addClass('active');\n                    sel.siblings().removeClass('active');\n                } else {\n                    $('.cdTabTgt').hide();\n                    $(\"#experience\").show();\n                    var $experiencetab = $(\"#experiencetab\");\n                    $experiencetab.addClass('active');\n                    $experiencetab.siblings().removeClass('active');\n                }\n                return false;\n            })\n        });\n\n        // Autoselect tab\n        var url = Main.k.window.location;\n        var r = /\\?([a-z]+)$/;\n        if (r.test(url)) {\n            $('.cdTabTgt').hide();\n            $(\"#\" + r.exec(url)[1]).show();\n            var sel = $(\"#\" + r.exec(url)[1] + \"tab\");\n            sel.addClass('active');\n            sel.siblings().removeClass('active');\n        }\n    }\n\n    /** For all profile pages **/\n    /**** MY FILE ****/\n    $('.cdTripEntry td .char').css('margin','5px 0');\n    $('.cdTripEntry').each(function(){\n        $(this).find('td').eq(-2).css('width','71px');\n    });\n    $('.cdTripEntry .new').remove();\n    $('.cdTripPrevious').on('click',function(){\n        if($('.cdTripPage').text() > 1){\n            $('.cdTripPrevious').show();\n        }\n    });\n\n};\nMain.k.tabs.ranking = function() {\n\n    Main.k.SwitchRankingTab = function(event) {\n        var selectedtab = $(event.target).attr(\"id\");\n        $(\"div.bgtablesummar\").addClass(\"hide\");\n        $(\"ul.tablefilter li\").addClass(\"off\");\n        $(event.target).removeClass(\"off\");\n\n        switch (selectedtab) {\n            case \"cdTabFriends\":\n                $(\"div.cdFriends\").removeClass(\"hide\");\n                break;\n\n            case \"cdTabContacts\":\n                $(\"div.cdContacts\").removeClass(\"hide\");\n                break;\n\n            case \"cdTabAll\":\n                $(\"div.cdGlobal\").removeClass(\"hide\");\n                break;\n        }\n    };\n\n    $(\"<style>\").attr(\"type\", \"text/css\").html(\"\\\n\tspan.rankhead {\\\n\t\tdisplay: block;\\\n\t\tposition: absolute;\\\n\t\ttop: 30px; left: 250px;\\\n\t\tbottom: 30px; right: 10px;\\\n\t\tfont-size: 24pt;\\\n\t\tcolor: #FFF;\\\n\t\ttext-align: left;\\\n\t\tfont-family: 'PT Sans Caption','Arial','Segoe UI','Lucida Grande','Trebuchet MS','lucida sans unicode',sans-serif;\\\n\t\ttext-shadow: -1px 0px 2px rgba(0, 0, 0, 0.3), 0px 1px 2px rgba(0, 0, 0, 0.3), 1px 0px 2px rgba(0, 0, 0, 0.3);\\\n\t\ttext-transform: uppercase;\\\n\t}\\\n\t\").appendTo($(\"head\"));\n\n    var $cat_triumph_nova = $(\"#category_triumph, #category_nova\");\n    $cat_triumph_nova.css({\n        margin: \"0\",\n        width: \"50%\",\n        float: \"left\",\n        display: \"block\"\n    });\n\n    $(\"th\").each(function() {\n        var txt = $(this).html().trim();\n        if (txt == \"Héros Favori\") $(this).html(\"\");\n    });\n\n    $(\"ul.tablefilter\").first().clone().css({\n        float: \"right\",\n        width: \"auto\"\n    }).prependTo(\"#ranking\").find(\"li\").attr(\"onclick\", \"\").on(\"click\", Main.k.SwitchRankingTab);\n    $cat_triumph_nova.find(\".tablefilter, .clear\").remove();\n    $(\"#ranking\").find(\"th.distinctions\").css(\"width\", \"auto\");\n    $(\".bgtablesummar\").css(\"margin\", \"0 5px\");\n    $(\"table.summar\").css(\"width\", \"100%\");\n    $(\"table.summar tr.top td\").css(\"font-size\", \"12pt\");\n    $(\".pages\").css(\"display\", \"none\");//TEMP\n    $(\"ul.category\").css(\"display\", \"none\");\n    $(\"tr.cdRhtTr\").css(\"display\", \"table-row\");\n    $(\"<div>\").addClass(\"clear\").appendTo(\"#ranking\");\n    $(\"<div>\").addClass(\"clear\").insertBefore(\"#category_triumph\");\n\n    var headers = $(\"<div>\").css({\"margin\": \"20px auto 10px\", \"text-align\": \"center\", position: \"relative\"}).prependTo(\"#category_triumph, #category_nova\");\n    headers.first().html(\"<span class='rankhead'>Triomphe</span><img alt='Triomphe' src='\" + Main.k.servurl + \"/img/rank_triumph.png' />\");\n    headers.last().html(\"<span class='rankhead'>Super NOVA</span><img alt='NOVA' src='\" + Main.k.servurl + \"/img/rank_nova.png' />\");\n};\nMain.k.tabs.expPerma = function() {\n    if (Main.k.Options.cbubbles) {\n        Main.k.css.bubbles();\n\n        $(\"div.exploreevent p\").each(function() {\n            var heroes = [];\n            var heroes_replace = [];\n            $(\"ul.adventurers .char\").each(function() {\n                var hero = Main.k.GetHeroNameFromTopic($(this).parent());\n                var herof = hero.replace(\"_\", \" \").capitalize();\n                heroes_replace.push('<span class=\"colored_' + hero + '\"><img src=\"/img/icons/ui/' + hero.replace(\"_\", \"\") + '.png\" /> ' + herof + '</span>');\n                heroes.push(herof);\n            });\n\n            var html = $(this).html();\n            for (var i=0; i<heroes.length; i++) {\n                var regex = new RegExp(heroes[i],'g');\n                html = html.replace(regex, heroes_replace[i]);\n            }\n            $(this).html(html);\n        })\n    }\n};\nMain.k.tabs.gameover = function() {\n    // Triumph logs\n    var logs = $(\"#logtri li span, #logtri div div li\");\n    var logcount = {\n        humanC: 0,\t\t\t// 1\n        researchMin: 0,\t\t// 3\n        research: 0,\t\t// 6\n        hunter: 0,\t\t\t// 1\n        expe: 0,\t\t\t// 3\n        planet: 0\t\t\t// 5\n    };\n\n    var reg = /([0-9]+)\\sx\\s([^\\(]+)\\s\\(\\s(?:\\+|-)\\s([0-9]+)\\s\\)/;\n    var $logtri = $(\"#logtri\");\n    $logtri.find(\"div\").css(\"display\", \"block\");\n    $logtri.find(\".rreadmore\").css(\"display\", \"none\");\n    logs.each(function() {\n        var counted = false;\n        var data = reg.exec($(this).html());\n        switch (data[2].trim()) {\n            /* Translators: This translation must be copied from the game. */\n            case Main.k.text.gettext(\"Cycle Humain\"):\n                counted = true;\n                logcount.humanC += parseInt(data[1]);\n                break;\n            /* Translators: This translation must be copied from the game. */\n            case Main.k.text.gettext(\"Recherche Mineur\"):\n                counted = true;\n                logcount.researchMin += parseInt(data[1]);\n                break;\n            /* Translators: This translation must be copied from the game. */\n            case Main.k.text.gettext(\"Recherche\"):\n                counted = true;\n                logcount.research += parseInt(data[1]);\n                break;\n            /* Translators: This translation must be copied from the game. */\n            case Main.k.text.gettext(\"Défenseur Du Daedalus\"):\n                counted = true;\n                logcount.hunter += parseInt(data[1]);\n                break;\n            /* Translators: This translation must be copied from the game. */\n            case Main.k.text.gettext(\"Expédition\"):\n                counted = true;\n                logcount.expe += parseInt(data[1]);\n                break;\n            /* Translators: This translation must be copied from the game. */\n            case Main.k.text.gettext(\"Nouvel Planète\"):\n                counted = true;\n                logcount.planet += parseInt(data[1]);\n                break;\n        }\n\n        if (counted) {\n            var tgt = ($(this).tagName == \"SPAN\") ? $(this).parent() : $(this);\n            tgt.css(\"display\", \"none\");\n        }\n    });\n    if (logcount.planet) {\n        /* Translators: This translation must be copied from the game. */\n        $(\"<li>\").html(logcount.planet + \" x \"+Main.k.text.gettext(\"Nouvelle Planète\") + \" ( + \" + logcount.planet * 5 + \" )\")\n            .attr(\"_title\", Main.k.text.gettext(\"Nouvelle Planète\"))\n            .attr(\"_desc\", Main.k.text.gettext(\"Gagné à chaque planète (arrivée en orbite).\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .prependTo(\"#logtri\");\n    }\n    if (logcount.expe) {\n        /* Translators: This translation must be copied from the game. */\n        $(\"<li>\").html(logcount.expe + \" x \"+ Main.k.text.gettext(\"Expédition\") +\" ( + \" + logcount.expe * 3 + \" )\")\n            .attr(\"_title\", Main.k.text.gettext(\"Expédition\"))\n            .attr(\"_desc\", Main.k.text.gettext(\"Gagné à chaque exploration.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .prependTo(\"#logtri\");\n    }\n    if (logcount.researchMin) {\n        /* Translators: This translation must be copied from the game. */\n        $(\"<li>\").html(logcount.researchMin + \" x \"+ Main.k.text.gettext(\"Recherche Mineure\") +\" ( + \" + logcount.researchMin * 3 + \" )\")\n            .attr(\"_title\", Main.k.text.gettext(\"Recherche Mineure\"))\n            .attr(\"_desc\", Main.k.text.gettext(\"Gagné lorsque la recherche est terminée ainsi qu'une seconde fois lors du retour sur SOL.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .prependTo(\"#logtri\");\n    }\n    if (logcount.research) {\n        /* Translators: This translation must be copied from the game. */\n        $(\"<li>\").html(logcount.research + \" x \"+ Main.k.text.gettext(\"Recherche\") + \" ( + \" + logcount.research * 6 + \" )\")\n            .attr(\"_title\", Main.k.text.gettext(\"Recherche\"))\n            .attr(\"_desc\", Main.k.text.gettext(\"Gagné lorsque la recherche est terminée ainsi qu'une seconde fois lors du retour sur SOL.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .prependTo(\"#logtri\");\n    }\n    if (logcount.hunter) {\n        /* Translators: This translation must be copied from the game. */\n        $(\"<li>\").html(logcount.hunter + \" x \"+ Main.k.text.gettext(\"Défenseur du Daedalus\") + \" ( + \" + logcount.hunter + \" )\")\n            .attr(\"_title\", Main.k.text.gettext(\"Défenseur du Daedalus\"))\n            .attr(\"_desc\", Main.k.text.gettext(\"Gagné pour chaque Hunter abattu.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .prependTo(\"#logtri\");\n    }\n    if (logcount.humanC) {\n        /* Translators: This translation must be copied from the game. */\n        $(\"<li>\").html(logcount.humanC + \" x \"+ Main.k.text.gettext(\"Cycle Humain\") + \" ( + \" + logcount.humanC + \" )\")\n            .attr(\"_title\", Main.k.text.gettext(\"Cycle Humain\"))\n            .attr(\"_desc\", Main.k.text.gettext(\"Gagné à chaque cycle.\"))\n            .on(\"mouseover\", Main.k.CustomTip)\n            .on(\"mouseout\", Main.k.hideTip)\n            .prependTo(\"#logtri\");\n    }\n\n    //Loading on like click\n    $(document).on('click','a.like',function(){\n        $(this).replaceWith('<img class=\"cdLoading\" src=\"/build/img/icons/ui/loading1.gif\" alt=\"loading...\" />');\n    });\n};\n\n// Script initialization\nGM_addStyle(GM_getResourceText ('css:jgrowl'));\neval(GM_getResourceText('jgrowl'));\n$.jGrowl.defaults.closerTemplate = '';\n$.jGrowl.defaults.theme = 'ctrl-w';\n$.jGrowl.defaults.themeState = '';\n\neval(GM_getResourceText('mush'));\n\nMain.k.init();\n\n// If ingame\nif (Main.k.playing && $(\"#topinfo_bar\").length > 0) {\n    Main.k.tabs.playing();\n\n// Fix ending messages\n} else if ($(\"#credits\").length > 0) {\n    Main.k.tabs.credits();\n\n// Fix account page\n} else if ($(\"#profile.cdTabTgt\").length > 0) {\n    Main.k.tabs.playerProfile();\n\n// Fix rankings\n} else if ($(\"#ranking\").length > 0) {\n    Main.k.tabs.ranking();\n\n// ExpPerma\n} else if (Main.k.window.location.href.indexOf(\"expPerma\") != -1) {\n    Main.k.tabs.expPerma();\n\n// Game over\n} else if ($(\"#gameover\").length > 0) {\n    Main.k.tabs.gameover();\n\n// Home\n} else if ($(\"#mediaShow\").length > 0) {\n    $(\"#maincontainer, .boxcontainer\").css(\"margin\", \"0 auto 0\");\n    $(\".kmenu\").css({\n        position: \"relative\",\n        top: \"180px\"\n    });\n    $(\"a.logostart\").css(\"top\", \"20px\");\n//new game\n}else if($('.choosehero2').length > 0){\n    Main.k.Game.clear();\n    localStorage.setItem('ctrlw_newgame',1);\n}\n\nif (Main.k.debug) {Main.k.displayBug();}\n"],"sourceRoot":"/source/"}